---
title: "Controls"
author: Thomas Julou
date: "`r format(Sys.time(), '%d %B, %Y')`"
---

## Growth in M9 glucose before the first switch

```{r}
mycells_btw <- myframes %>% 
  ungroup %>% 
  # filter(!(condition %in% c('glucose', 'lactose', 'mg1655'))) %>% 
  filter(!discard_top) %>%
  filter(start_time>0, start_time>=m_start, end_type=='div') %>% 
  # select(condition, date, pos, gl, id, genealogy, start_time, end_time, end_type, 
         # time_sec, medium, m_start, m_end, gfp_nb, length_um, m_cycle, cell_num_in_lane, total_cell_in_lane) %>% 
  # group_by(date, pos, gl, id) %>%
  partition(condition, date, pos, gl, id, cluster=mycluster) %>%
  # filter(start_time>m_start, end_type=='div', # full cell cycles only
  #        length(unique(interaction(medium, m_cycle)))==1) %>%  # not overlaping a switch
  filter((unique(medium)!='glycerol' & n()>9) | # at least 10 time points (≈1/3 of cell cycle)
           (unique(medium)=='glycerol' & n()>39)) %>% # requires 40 time points in glycerol
  do((function(.df) {
    # browser()
    # .mod_ll_t <- fastLmPure( cbind(1, .df$time_sec), log(.df$length_um) )
    .mod_ll_t <- lm( log(length_um)~time_sec, .df)  # use fastLm() for predict
    .time_birth <- first(.df$time_sec)
    .time_div <- last(.df$time_sec)
    .logl <- predict(.mod_ll_t, se.fit=TRUE)
    data.frame(npoints=.mod_ll_t$df.residual+1,
               time_birth=.time_birth, time_div=.time_div, 
               cell_num_from_top=mean(.df$cell_num_in_lane),
               cell_num_from_bottom=mean(.df$total_cell_in_lane-.df$cell_num_in_lane), 
               # logl_time_slope=.mod_ll_t$coefficients[2], logl_time_slopesd=.mod_ll_t$stderr[2],
               loglength_start=first(.logl$fit), loglength_startse=first(.logl$se.fit), 
               loglength_end=last(.logl$fit), loglength_endse=last(.logl$se.fit), 
               logl_time_slope=.mod_ll_t$coefficients[2], logl_time_slopesd=summary(.mod_ll_t)$coefficients[2,2],
               logl_time_r2=cor(.df$time_sec, log(.df$length_um))^2 )
  })(.) ) %>% 
  collect() %>% 
  arrange(condition, date, pos, gl, id) %>% 
  left_join(myframes %>% group_by(date, pos, gl, id) %>% slice(1) %>% 
              select(date, pos, gl, id, medium, m_start, m_cycle, mstep, gl_id, cell, ugen, parent_id) )

```

```{r eval=FALSE}
mycells_btw %>% 
  # filter(condition=="switch_04h" | str_detect(condition, "CM"), m_cycle==1) %>%
  filter(!is.na(medium)) %>% 
  group_by(condition) %>% 
  mutate(m_col=as.numeric(fct_inorder(factor(medium))) %>% interaction(m_cycle)) %>% 
  ggplot(aes(time_birth, log(2)/logl_time_slope / 60, col=m_col)) +
  facet_grid(condition+date~.) +
  geom_point(alpha=.2, size=.5) +
  scale_x_hours() +
  labs(y="doubling time (min)") +
  coord_cartesian(ylim=c(0, 200))
  
```

CDF stratified by time: this shows that one is close to steady state after 2h in most cases.  
NB: the grey line shows growth in constant glucose (as a reference).

```{r fig.height=10}
mycells_btw %>% 
  group_by(condition) %>% 
  mutate(m_col=as.numeric(fct_inorder(factor(medium))) %>% interaction(m_cycle)) %>% 
  filter(m_col=='1.1') %>% 
  ungroup %>% 
  filter(!is.na(medium)) %>% 
  mutate(time_bin=Hmisc::cut2(time_birth/3600, cuts=(0:15)*2)) %>% 
  (function(.df) {
    ggplot(.df, aes(log(2)/logl_time_slope / 60)) +
      facet_wrap(~condition+date) +
      stat_ecdf(alpha=.5, data=.df %>% filter(condition=='glucose') %>% select(-condition, -date)) +
      stat_ecdf(aes(col=time_bin), alpha=.6) +
      ggplot2::scale_color_discrete() +
      coord_cartesian(xlim=c(40, 300)) +
      labs(x='doubling time (min)', col='birth time (h)') +
      theme(legend.position='bottom')
  })

```

The grey line shows growth in constant glucose (as a reference):

```{r fig.height=10}
mycells_btw %>% 
  filter(!is.na(medium)) %>% 
  group_by(condition) %>% 
  mutate(m_col=as.numeric(fct_inorder(factor(medium))) %>% interaction(m_cycle)) %>% 
  filter(m_col=='1.1') %>% 
  ungroup %>% 
  filter((time_birth>2*3600 & time_birth<6*3600)) %>% 
  (function(.df) {
    ggplot(.df, aes(log(2)/logl_time_slope / 60)) +
      facet_wrap(~date+condition) +
      stat_ecdf(alpha=.5, data=.df %>% filter(condition=='glucose') %>% select(-condition, -date)) +
      stat_ecdf(col=brewer_cols[1]) +
      # stat_ecdf(aes(group=gl_id), col=brewer_cols[1], size=.2) +
      coord_cartesian(xlim=c(40, 300)) +
      labs(x='doubling time (min)', y='cdf', title='initial growth rates (between t=2h and t=6h)')
      # theme(strip.text=element_text(size=6))
  })

```

```{r growth_rate_medians, eval=FALSE}
mycells_btw %>% 
  ungroup %>% 
  filter(condition != 'switch_gly_lac') %>% 
  filter(time_birth>2*3600, time_birth<6*3600) %>% 
  filter(!is.na(medium)) %>% 
  group_by(condition) %>% 
  mutate(m_col=as.numeric(fct_inorder(factor(medium))) %>% interaction(m_cycle)) %>% 
  filter(m_col=='1.1') %>% 
  ungroup %>% 
  mutate(ds=interaction(date, condition, sep="\n")) %>% 
  ggplot() +
  geom_rect(aes(ymin=ymin, ymax=ymax), xmin=-Inf, xmax=Inf, alpha=.3,
            data=mycells_btw %>% ungroup %>% filter(condition=='glucose') %>%
              filter(time_birth>2*3600, time_birth<6*3600) %>% with(log(2)/logl_time_slope / 60) %>% median_pi) +
  stat_summary(aes(ds, log(2)/logl_time_slope / 60), fun.data=median_pi, size=.25) +
  expand_limits(y=0) +
  labs(y='median doubling time (min)', title='initial growth rates (between t=2h and t=6h)') +
  theme(axis.title.x=element_blank(), axis.text.x=element_text(angle=45, hjust=1, vjust=1))

```

The relationship between growth rate and cell size indicates that cells growing slower are in a different physiological state:

```{r fig.height=7}
mycells_btw %>% 
  filter(!is.na(medium)) %>% 
  group_by(condition) %>% 
  mutate(m_col=as.numeric(fct_inorder(factor(medium))) %>% interaction(m_cycle)) %>% 
  filter(m_col=='1.1') %>% 
  ungroup %>% 
  filter((time_birth>2*3600 & time_birth<6*3600)) %>%
  (function(.df) {
    .dfs <- .df %>% group_by(condition, date) %>% 
      do(median_pi(.$loglength_start) %>% setNames(c('lls_med', 'lls_pi_min', 'lls_pi_max')) ) %>% 
      left_join(
        .df %>% group_by(date) %>% 
          do(median_pi(.$logl_time_slope) %>% setNames(c('lltsl_med', 'lltsl_pi_min', 'lltsl_pi_max')) )
        )
         
    ggplot(.df) +
      # facet_wrap(~condition+date) +
      # geom_point(aes(exp(loglength_start), log(2)/logl_time_slope / 60, col=factor(date)), alpha=.2, size=.2) +
      geom_point(aes(exp(lls_med), log(2)/lltsl_med / 60, col=condition), data=.dfs ) +
      geom_errorbar(aes(exp(lls_med), ymin=log(2)/lltsl_pi_min / 60, ymax=log(2)/lltsl_pi_max / 60, col=condition), 
                    alpha=.5, data=.dfs ) +
      geom_errorbarh(aes(exp(lls_med), log(2)/lltsl_med / 60, xmin=exp(lls_pi_min), xmax=exp(lls_pi_max), col=condition),
                     alpha=.5, data=.dfs ) +
      ggrepel::geom_text_repel(aes(exp(lls_med), log(2)/lltsl_med / 60, col=condition, label=date), alpha=0.3, data=.dfs) +
                               # force=4, point.padding=1) +
      coord_cartesian(xlim=c(1.25, 2.25), ylim=c(60, 140)) +
      labs(x='birth length (µm)', y='doubling time (min)', title='initial condition (between t=2h and t=6h)') +
      ggplot2::scale_color_discrete() +
      theme(legend.position='bottom')
  })


```


CDF of exp fits' r^2:
(not very informative)

```{r fig.height=10}
mycells_btw %>% 
  filter(!is.na(medium)) %>% 
  group_by(condition) %>% 
  mutate(m_col=as.numeric(fct_inorder(factor(medium))) %>% interaction(m_cycle)) %>% 
  filter(m_col=='1.1') %>% 
  ungroup %>% 
  filter((time_birth>2*3600 & time_birth<6*3600)) %>% 
  filter(npoints>19) %>% 
  (function(.df) {
    ggplot(.df, aes(logl_time_r2)) +
      facet_wrap(~condition+date) +
      stat_ecdf(alpha=.5, data=.df %>% filter(condition=='glucose') %>% select(-condition, -date)) +
      stat_ecdf(col=brewer_cols[1], alpha=.6) +
      coord_cartesian(xlim=c(0.95, 1)) +
      labs(x='Squared Pearson correl. coeff.', title='initial growth curves (between t=2h and t=6h)')
  })

```


```{r}
discarded_dates <- c(20151218, # switch_08h
                    20171122, # ∆lacA
                    20161021, # switch_late
                    # 20180108, # (( glc+lac to lac ))
                    20170901,  # switch_ramp 15'
                    # switch_withIPTG1uM ??
                    20180313 # switch_24h only 10GLs analysed
)

discarded_datesss <- c(discarded_dates,
                       20160526, # switch_12h ???
                       # 20180207, # switch_12h 
                       20170108, # switch_late x 2! ???
                       20180123  # switch_lacIoe (weird lag distrib)
                       )

```

<!-- TO DO
?? check correl with inoc OD + loading duration + loading ratio
-->

## Growth in lactose 1.5 to 4h after the first switch

```{r fig.height=10}
mycells_btw %>% 
  filter(!date %in% discarded_dates) %>% 
  filter(!is.na(medium)) %>% 
  group_by(condition) %>% 
  mutate(m_col=as.numeric(fct_inorder(factor(medium))) %>% interaction(m_cycle)) %>% 
  filter(m_col=='2.1') %>% 
  ungroup %>% 
  filter(time_birth>m_start+1.5*3600, time_birth<m_start+4*3600) %>% 
  ggplot(aes(log(2)/logl_time_slope / 60)) +
  facet_wrap(~condition+date) +
  stat_ecdf(alpha=.5, data=mycells_btw %>% ungroup %>% filter(condition=='lactose') %>% 
              filter(time_birth>m_start+7.5*3600, time_birth<m_start+10*3600) %>% select(-condition, -date)) +
  stat_ecdf(col=brewer_cols[1], alpha=.6) +
  coord_cartesian(xlim=c(40, 400)) +
  labs(x='doubling time (min)', y='cdf', title='after first switch (between t=1.5h and t=4h)')
  # theme(strip.text=element_text(size=6))

```

```{r fig.height=7}
mycells_btw %>% 
  filter(!date %in% discarded_dates) %>% 
  filter(!is.na(medium)) %>% 
  group_by(condition) %>% 
  mutate(m_col=as.numeric(fct_inorder(factor(medium))) %>% interaction(m_cycle),
         m_col=ifelse(condition=='lactose', '2.1', m_col),
         time_birth=ifelse(condition=='lactose', time_birth-6*3600, time_birth)) %>% 
  filter(m_col=='2.1') %>% 
  ungroup %>% 
  filter(time_birth>m_start+1.5*3600, time_birth<m_start+4*3600) %>% 
  mutate(condition=factor(condition)) %>% 
  (function(.df) {
    .dfs <- .df %>% group_by(condition, date) %>% 
      do(median_pi(.$loglength_start) %>% setNames(c('lls_med', 'lls_pi_min', 'lls_pi_max')) ) %>% 
      left_join(
        .df %>% group_by(date) %>% 
          do(median_pi(.$logl_time_slope) %>% setNames(c('lltsl_med', 'lltsl_pi_min', 'lltsl_pi_max')) )
        )
         
    ggplot(.df) +
      # facet_wrap(~condition+date) +
      # geom_point(aes(exp(loglength_start), log(2)/logl_time_slope / 60, col=factor(date)), alpha=.2, size=.2) +
      geom_point(aes(exp(lls_med), log(2)/lltsl_med / 60, col=condition), data=.dfs ) +
      
      geom_errorbar(aes(exp(lls_med), ymin=log(2)/lltsl_pi_min / 60, ymax=log(2)/lltsl_pi_max / 60, col=condition), 
                    alpha=.5, data=.dfs ) +
      geom_errorbarh(aes(exp(lls_med), log(2)/lltsl_med / 60, xmin=exp(lls_pi_min), xmax=exp(lls_pi_max), col=condition),
                     alpha=.5, data=.dfs ) +
      ggrepel::geom_text_repel(aes(exp(lls_med), log(2)/lltsl_med / 60, col=condition, label=date), alpha=0.3, data=.dfs) +
                               # force=4, point.padding=1) +
      coord_cartesian(xlim=c(1.25, 2.25), ylim=c(60, 140)) +
      labs(x='birth length (µm)', y='doubling time (min)', title='after first switch (between t=1.5h and t=4h)') +
      ggplot2::scale_color_discrete() +
      theme(legend.position='bottom')
  })

```



check heritability of growth lags at first switch


## Effect of growth rate before the switch

```{r}
mycells_switching %>% 
  filter(condition != 'switch_gly_lac') %>% 
  filter(! date %in% discarded_dates) %>% 
  ggplot() +
  geom_point(aes(logl_time_slope_pre / log(2) * 3600,  lag_200/60, size=n_preswitch), alpha=0.2) +
  geom_vline(xintercept = 4e-5 / log(2) * 3600) +
  # scale_color_gradient(low = "red", high = "blue", trans='log10') +
  # scale_size_continuous(trans='log10') +
  coord_cartesian(xlim=c(0, 1.5)) +
  labs(x='growth rate before the switch (dbl/h)', y='induction lag (min)')

mycells_switching %>% 
  filter(condition != 'switch_gly_lac') %>% 
  filter(! date %in% discarded_dates) %>% 
  filter(switch_idx == 1) %>% 
  ggplot() +
  stat_bin(aes(logl_time_slope_pre / log(2) * 3600), binwidth=.05) +
  geom_vline(xintercept = 4e-5 / log(2) * 3600) +
  coord_cartesian(xlim=c(0, 1.5)) +
  labs(x='growth rate before the switch (dbl/h)')

```

```{r eval=FALSE}
min_growth_rate <- 4e-5

mycells_switching %>% 
  filter(condition != 'switch_gly_lac') %>% 
  filter(! date %in% discarded_dates) %>% 
  filter(switch_idx == 1) %>% 
  filter(logl_time_slope_pre <= min_growth_rate) %>% 
  group_by(condition, date, switch_idx) %>% 
  summarize(n=n()) %>% 
  knitr::kable()

```


## Position / GL effect on lags

Let's verify beforehand that there is no systematic effect, such as all cells having short or long lags in a given GL, or the bottom cell taking always longer.

```{r fig.height=10}
mycells_switching %>% 
  ungroup %>% 
  filter(! date %in% discarded_dates) %>% 
  filter(condition!='switch_long_lac_hiExpr') %>% 
  filter(switch_idx==1) %>% 
  gather(variable, lag, growth_lag, gfp_lag, lag_200, factor_key=TRUE) %>% 
  # mutate(lag=ifelse(!is.infinite(lag), lag, max(lag[is.finite(lag)])+60),
  #        lag=ifelse(is.na(lag), -1, lag)) %>% 
  filter(variable=='lag_200') %>% 
  # filter(condition=='switch_∆lacA') %>% 
  ggplot() +
  facet_wrap(~date+condition, scales='free_x') +
  geom_segment(aes(x=interaction(date, pos, gl), xend=interaction(date, pos, gl), 
                   y=cell_num_from_bottom, yend=cell_num_from_bottom+1, col=lag/60),
               size=1) +
  viridis::scale_color_viridis(trans='log2', direction=-1) +
  theme(axis.text.x=element_blank()) +
  theme(legend.position='top')
  
mycells_switching %>% 
  ungroup %>% 
  filter(! date %in% discarded_dates) %>% 
  filter(condition!='switch_long_lac_hiExpr') %>% 
  filter(switch_idx==1) %>% 
  gather(variable, lag, growth_lag, gfp_lag, lag_200, factor_key=TRUE) %>% 
  mutate(lag_categ=NA, lag_categ=ifelse(is.infinite(lag), 'Inf', lag_categ),
         lag_categ=ifelse(!is.infinite(lag) & lag<48*60, 'short', lag_categ),
         lag_categ=ifelse(!is.infinite(lag) & lag>=48*60, 'long', lag_categ)) %>% 
  filter(variable=='lag_200') %>% 
  # filter(condition=='switch_∆lacA') %>% 
  ggplot() +
  facet_wrap(~date+condition, scales='free_x') + # , strip.position='right'
  geom_segment(aes(x=interaction(date, pos, gl), xend=interaction(date, pos, gl), 
                   y=cell_num_from_bottom, yend=cell_num_from_bottom+1, col=lag_categ),
               size=1) +
  viridis::scale_color_viridis(name='lag', discrete=TRUE, na.value='gray65') +
  theme(axis.text.x=element_blank()) +
  theme(legend.position='top')
# ggsave('Rplot.pdf', width=10, height=7)

```



## Control experiments

late switch 

```{r}
mycells_switching %>% ungroup %>% 
  filter(!date %in% discarded_dates) %>%
  filter(switch_idx==1) %>%
  filter(str_detect(condition, '^switch_[0-9]+h$') | 
           condition %in% c('switch_late') ) %>% # 'switch_long_lac', 
  gather(variable, lag, growth_lag, gfp_lag, lag_200, factor_key=TRUE) %>% 
  # mutate(lag=ifelse(!is.infinite(lag), lag, max(lag[is.finite(lag)])+60),
  #        lag=ifelse(is.na(lag), -1, lag)) %>% 
  mutate(cond=ifelse(condition=='switch_late', 'late switch', 'control')) %>% 
  ggplot(aes(x=lag/60)) +
  facet_grid(.~variable) +
  stat_ecdf(aes(y=1-..y.., col=cond, group=date)) +
  labs(x='lag after the switch (min)', y='reverse cumulative probability') +
  expand_limits(x=0)

```


PDMS primed with lactose

```{r}
mycells_switching %>% ungroup %>% 
  filter(!date %in% discarded_dates) %>%
  filter(switch_idx==1) %>%
  filter(str_detect(condition, '^switch_[0-9]+h$') | 
           condition %in% c('switch_lactose_priming') ) %>% # 'switch_long_lac', 
  gather(variable, lag, growth_lag, gfp_lag, lag_200, factor_key=TRUE) %>% 
  # mutate(lag=ifelse(!is.infinite(lag), lag, max(lag[is.finite(lag)])+60),
  #        lag=ifelse(is.na(lag), -1, lag)) %>% 
  mutate(cond=ifelse(condition=='switch_lactose_priming', 'lactose primed', 'control')) %>% 
  ggplot(aes(x=lag/60)) +
  facet_grid(.~variable) +
  stat_ecdf(aes(y=1-..y.., col=cond, group=date)) + #, group=date
  labs(x='lag after the switch (min)', y='reverse cumulative probability') +
  expand_limits(x=0)

```


