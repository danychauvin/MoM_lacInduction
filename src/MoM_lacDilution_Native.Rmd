---
title: "Induction lags of the native *lac* operon"
author: Thomas Julou
date: "`r format(Sys.time(), '%d %B, %Y')`"
---


```{r}
# gfp_nb offset ≈ 100 to avoid stripping values and to keep background fluctuations visually small
myframes %>% ungroup() %>% 
  filter(date==20180206) %>% 
  group_by(date, pos, gl) %>% 
  ggCustomTJ::slice_groups(c(1)) %>% 
  filter(!discard_start, !discard_top,
         time_sec>2*3600) %>%
  filter(total_cell_in_lane-cell_num_in_lane<5,
         end_type=='div') %>% 
  # ungroup() %>% mutate(gfp_nb=gfp_nb - 2*min(gfp_nb)) %>% 
  ungroup() %>% mutate(gfp_nb=gfp_nb + 135) %>% 
  gather(variable, value, length_um, gfp_nb) %>% 
  ggplot() +
  # facet_grid(pos+gl~.) +
  facet_wrap(~variable, scales='free_y', ncol=1, strip.position='left',
             labeller=as_labeller(function(.str) {
               .str <- str_replace(.str, "gfp_nb", "LacZ-GFP (molecules)")
               .str <- str_replace(.str, "length_um", "cell length (µm)")
               return(.str)
             }) ) +
  geom_line(aes(time_sec-2*3600, value, col=ugen)) +
  scale_colour_periodic(.n=3, guide='none') +
  # show medium bar
  geom_vline(aes(xintercept=t_start - 2*3600, group=1), alpha=.2, size=.5, 
            data=filter(condition_ts, condition=='switch_08h')) +
  geom_rect(aes(xmin=t_start - 2*3600, xmax=t_end - 2*3600, ymin=1.3, ymax=1.5, fill=medium, group=1), show.legend=FALSE, #size=0.2,
            data=filter(condition_ts, condition=='switch_08h') %>% mutate(variable='length_um')) +
  geom_text(aes(x=t_start+(t_end-t_start)/2 - 2*3600, y=1.3, label=medium, group=1), size=4, col='white', hjust=0.5, vjust=-0.5, 
            data=filter(condition_ts, condition=='switch_08h') %>% mutate(variable='length_um', t_start=ifelse(t_start<2*3600, 2*3600, t_start))) +
  # scale_fill_manual(values=c('glucose'=.fill[1], 'lactose'=.fill[2]), guide='none') +

  coord_cartesian(xlim=c(0, 19*3600)) +
  scale_x_hours(4) +
  scale_y_continuous(trans='log2') +
  theme(strip.placement='outside', strip.background.y=element_blank(),
        axis.title.y=element_blank(), strip.text.y=element_text(size=rel(1))) +
  NULL

```


## *lac* induction lags in naive cells

For the first switch, all experiments with variable duration in glucose before the second switch are equivalent:
  
```{r}
mycells_switching %>% ungroup() %>% 
  filter(!date %in% discarded_dates) %>%
  filter(!discard_arrested) %>% 
  filter(str_detect(condition, '^switch_[0-9]+h$')) %>%
  filter(switch_idx==1) %>%
  # mutate(lag=ifelse(lag<240*60, lag, 245*60),
         # lag=ifelse(is.na(lag), -10, lag)) %>% 
  ggplot(aes(x=lag_200/60)) +
  geom_freqpoly(aes(col=switch_idx), binwidth=3, show.legend=FALSE) +
  labs(x=lac_lags_label, title='naive cells (9 independent experiments)') +
  coord_cartesian(xlim=c(0, 240)) +
  NULL

```

```{r eval=FALSE}
mycells_switching %>% ungroup() %>% 
  filter(!date %in% discarded_dates) %>%
  filter(!discard_arrested) %>% 
  filter(str_detect(condition, '^switch_[0-9]+h$')) %>%
  filter(switch_idx==1) %>%
  gather(variable, lag, growth_lag, gfp_lag, lag_200, factor_key=TRUE) %>% 
  mutate(lag=ifelse(lag<240*60, lag, 245*60),
         lag=ifelse(is.na(lag), -10, lag)) %>% 
  ggplot(aes(x=lag/60)) +
  facet_grid(variable~.) +
  geom_freqpoly(aes(col=factor(switch_idx)), binwidth=3, position='identity') +
  labs(x='lag after the switch (min)', title='naive cells', col='switch', fill='switch') +
  # xlim(-1, 240) +
  guides(col='none', fill='none') +
  NULL

```


check for a possible day effect:

```{r}
mycells_switching %>% ungroup %>% 
  filter(!date %in% discarded_dates) %>%
  filter(!discard_arrested) %>% 
  filter(str_detect(condition, '^switch_[0-9]+h$')) %>%
  filter(switch_idx==1) %>%
  mutate(lag=lag_200,
         lag=ifelse(is.finite(lag) & lag>240*60, 240*60, lag), 
         lag=ifelse(!is.infinite(lag), lag, max(lag[is.finite(lag)])+60),
         lag=ifelse(is.na(lag), -1, lag)) %>% 
  # (function(.df) bind_rows(.df, .df %>% mutate(date=NA, condition='all')) ) %>% 
  (function(.df)
    ggplot(.df, aes(x=lag/60)) +
     facet_wrap(~condition+date, ncol=2, dir='v',
                strip.position='right', labeller=as_labeller(rename_conds)) +
     # geom_freqpoly(aes(col=lag/60 > 236), binwidth=6, show.legend=FALSE) +
     geom_freqpoly(binwidth=6, show.legend=FALSE) + 
     geom_freqpoly(aes(col=factor(date_col)), binwidth=6, show.legend=FALSE,
                   data=.df %>% mutate(date_col=date, date=NA, condition='all')) +
     labs(x=lac_lags_label, title='naive cells') +
     xlim(-10, 250) +
     scale_colour_periodic() +
     NULL
  )

```


Check the fraction of arrested cells in mother cells since they dont have the bias of long lags being more truncated:

```{r}
mycells_switching %>% ungroup() %>% 
  filter(!date %in% discarded_dates) %>%
  filter(!discard_arrested) %>% 
  filter(str_detect(condition, '^switch_[0-9]+h$') ) %>%
  filter(switch_idx==1) %>%
  filter(cell_num_from_bottom==0) %>% # keep only mother cells
  mutate(lag_200=as.character(lag_200), lag_200=ifelse(is.na(lag_200), 'NA', lag_200),
         lag_200=ifelse(is.finite(as.numeric(lag_200)) & as.numeric(lag_200)<50*60, '<50', lag_200),
         lag_200=ifelse(is.finite(as.numeric(lag_200)) & as.numeric(lag_200)>=50*60, '≥50', lag_200) ) %>%
  group_by(switch_idx, lag_200) %>% 
  summarise(n=n()) %>% 
  group_by(switch_idx) %>% mutate(p=n/sum(n)) %>% 
  knitr::kable(digits=3)

```


Distribution of *lac* induction lags are also bimodal when the transition to lactose is gradual.  
NB: since the concentration at which cells start to sense the low glucose / lactose is unknown, the lag in the gradual transition experiments are shifted so as to match the value of the step condition.

<!-- in order to have a not-too-short period with low glucose (> 0) and lactose, cells are switched from 0.002% glucose (≈100µM) to 0.2% lactose. CRP is supposed to kick in around 20-50µM (cf T. Hwa) -->


```{r}
mycells_switching %>% ungroup() %>% 
  filter(!date %in% discarded_dates) %>%
  filter(!discard_arrested) %>% 
  filter(switch_idx==1) %>%
  filter(str_detect(condition, '^switch_[0-9]+h$') | condition=='switch_ramp40min') %>% 
  mutate(condition=ifelse(str_detect(condition, '^switch_[0-9]+h$'), 'step', 'ramp (40 min)'),
         condition=fct_relevel(condition, 'step') ) %>% 
  mutate(lag=lag_200, 
         # lag=ifelse(lag>240*60, Inf, lag),
         # lag=ifelse(!is.infinite(lag), lag, 241*60),
         lag=ifelse(is.na(lag), -200, lag)) %>% 
  ggplot(aes(x=lag/60)) +
  geom_freqpoly(aes(y=..density.., col=condition), binwidth=6, position='identity') +
  labs(x=lac_lags_label) +
  # xlim(0, 240) +
  # theme(strip.background=element_rect(fill='gray95', colour='transparent'),
  #       legend.key.size=unit(.8, "lines") ) +
  theme(legend.position=c(0.99, 0.99), legend.justification=c(1, 1) ) +
  coord_cartesian(xlim=c(0, 240)) +
  NULL

```



## Memory of lag between switches

```{r}
mypairs_memory <- mycells_switching %>% 
  group_by(condition, date, pos, gl) %>% 
  do((function(.df_gl){
    # browser()
    # if(.df_gl$ugen[1]=='20150703.4.15.0:BBBBBBB') browser()
    .geneals_sw1 <- .df_gl %>% filter(switch_idx==1) %>% with(genealogy)
    if (nrow(.df_gl %>% filter(switch_idx==2)) == 0) return(data.frame())
    .df_gl %>% filter(switch_idx==2) %>% 
      select(genealogy_2=genealogy, lag_2=lag_200, discard_arrested_2=discard_arrested, 
             logl_time_slope_pre_2=logl_time_slope_pre) %>% group_by(genealogy_2) %>% 
      # with(which_is_parent_cid(genealogy, .geneals_sw1))
      mutate(genealogy_1=which_is_parent_cid(genealogy_2, .geneals_sw1),
             genealogy_1=ifelse(genealogy_1>0, .geneals_sw1[genealogy_1], NA) )
    })(.)) %>% 
  left_join(mycells_switching %>% ungroup %>% 
              select(date, pos, gl, genealogy_1=genealogy, lag_1=lag_200, discard_arrested_1=discard_arrested,
                     logl_time_slope_pre_1=logl_time_slope_pre) )

mypairs_memory %>% 
  filter(!date %in% discarded_dates) %>%
  filter(str_detect(condition, '^switch_[0-9]+h$') | condition=='switch_long_lac') %>%
  filter(!discard_arrested_1, !discard_arrested_2) %>% 
  # filter(logl_time_slope_pre_1 > min_growth_rate, logl_time_slope_pre_2 > min_growth_rate) %>% 
  ggplot() +
  facet_wrap(~condition, strip.position='right', labeller=as_labeller(rename_conds)) +
  geom_point(aes(lag_1/60, lag_2/60), alpha=.2) +
  expand_limits(x=0, y=0) +
  labs(x="ancestor's lag at first switch (min)", y="lag at second switch (min)") +
  NULL

mypairs_memory %>% 
  filter(!date %in% discarded_dates) %>%
  filter(str_detect(condition, '^switch_[0-9]+h$') | condition=='switch_long_lac') %>%
  filter(!discard_arrested_1, !discard_arrested_2) %>% 
  group_by(condition, lag_1, lag_2) %>% 
  summarise(n=n()) %>% 
  (function(.df)
    ggplot(.df) +
     facet_wrap(~condition, strip.position='right', labeller=as_labeller(rename_conds)) +
     geom_point(aes(lag_1/60, lag_2/60, size=n)) +
     scale_size_continuous(range=c(1.2/max(.df$n), 1.2), breaks=c(2, 5, 8)) +
     expand_limits(x=0, y=0) +
     labs(x="ancestor's lag at first switch (min)", y="lag at second switch (min)") +
     NULL
  )

```


```{r}
mycells_switching %>% ungroup() %>% 
  filter(!date %in% discarded_dates) %>%
  filter(str_detect(condition, '^switch_[0-9]+h$')) %>%
  filter(!discard_arrested) %>% 
  filter(cell_num_from_bottom==0) %>% # bottom_cell
  gather(variable, lag, growth_lag, gfp_lag, lag_200, factor_key=TRUE) %>% 
  select(condition, date, pos, gl, switch_idx, variable, lag) %>% 
  mutate(name_col=paste0('lag_', switch_idx), switch_idx=NULL) %>% 
  spread(name_col, lag) %>%
  filter(variable=='lag_200') %>% 
  ggplot() +
  facet_wrap(~condition+date, labeller=as_labeller(rename_conds), strip.position='right') +
  geom_abline(col='red', alpha=.5) +
  geom_point(aes(lag_1/60, lag_2/60), alpha=.5) +
  scale_x_continuous(breaks=seq(0, 1000, by=100)) +
  scale_y_continuous(breaks=seq(0, 1000, by=100)) +
  expand_limits(x=0, y=0) +
  labs(title='bottom cells', x='lag at first switch (min)', y='lag at second switch (min)') +
  NULL

```


```{r}
mycells_switching %>% ungroup() %>% 
  filter(!date %in% discarded_dates) %>%
  filter(!discard_arrested) %>% 
  filter(str_detect(condition, '^switch_[0-9]+h$')) %>%
  gather(variable, lag, growth_lag, gfp_lag, lag_200, factor_key=TRUE) %>% 
  filter(is.finite(lag)) %>% 
  # compute stats per GL, per switch, per variable
  group_by(condition, date, pos, gl, variable, switch_idx) %>% 
  summarise(mean_lag=mean(lag)) %>% 
  mutate(name_col=paste0('mean_lag_', switch_idx), switch_idx=NULL) %>% 
  spread(name_col, mean_lag) %>%
  filter(variable=='lag_200') %>% 
  ggplot(aes(mean_lag_1/60, mean_lag_2/60)) +
  facet_wrap(~condition+date, labeller=as_labeller(rename_conds), strip.position='right') +
  # facet_grid(condition~variable, labeller=as_labeller(rename_conds)) +
  geom_abline(col='red', alpha=.5) +
  geom_point(alpha=.4) +
  scale_x_continuous(breaks=seq(0, 1000, by=100)) +
  labs(title='average in growth channel', x='lag at first switch (min)', y='lag at second switch (min)') +
  NULL

```


## Effect of Lac proteins inheritance at the second switch

Focus on the second switch only:

```{r}
mycells_switching %>% ungroup() %>% 
  filter(!date %in% discarded_dates) %>%
  filter(!discard_arrested) %>% 
  filter(str_detect(condition, '^switch_[0-9]+h$') | condition=='switch_late') %>%
  mutate(lag=lag_200,
         lag=ifelse(!is.infinite(lag), lag, max(lag[is.finite(lag)])+60),
         lag=ifelse(is.na(lag), -1, lag)) %>% 
  filter(switch_idx %in% 1:2) %>% 
  ggplot(aes(x=lag/60)) +
  facet_grid(switch_idx~., labeller=as_labeller(function(.str) paste0('switch: ', .str)) ) +
  stat_ecdf(aes(y=1-..y.., col=condition, group=date), geom='line') +
  labs(x=lac_lags_label, y='reverse cumulative probability', col='condition') +
  scale_color_hue() +
  scale_color_manual(name='delay between\nlactose exposure',
                     limits=c(sprintf('switch_%02dh', seq(4, 24, 4)), 'switch_late'),
                     labels=c(sprintf('%dh', seq(4, 24, 4)), 'control (late)'),
                     values=c(scales::viridis_pal()(6), 'gray70') ) +
  NULL

```

```{r}

mycells_switching %>% ungroup() %>% 
  filter(!date %in% discarded_dates) %>%
  filter(!discard_arrested) %>% 
  filter(str_detect(condition, '^switch_[0-9]+h$') | condition=='switch_late') %>%
  mutate(lag=lag_200,
         lag=ifelse(lag>240*60, Inf, lag),
         # lag=ifelse(!is.infinite(lag), lag, max(lag[is.finite(lag)])+1e6),
         lag=ifelse(is.na(lag), -1e6, lag)) %>% 
  # group_by(condition, switch_idx) %>% summarise(n())
  (function(.df)
    ggplot(data=NULL, aes(x=lag/60, y=1-..y.., col=condition)) +
     stat_ecdf(aes(col='control'), geom='line', size=.6,
               data=filter(.df, switch_idx==1, condition != 'switch_late')) +
     stat_ecdf(geom='line', size=.6,
               data=filter(.df, switch_idx==1, condition == 'switch_late')) +
     stat_ecdf(geom='line', size=.3,
               data=.df %>% filter(switch_idx==2)) +
     geom_rect(aes(x=NULL), xmin=-Inf, xmax=0, ymin=-Inf, ymax=Inf, fill='white', col='transparent',
               data=data.frame()) +
     scale_color_manual(name='delay between\nlactose exposure',
                        limits=c(sprintf('switch_%02dh', seq(4, 24, 4)), 'control', 'switch_late'),
                        labels=c(sprintf('%dh', seq(4, 24, 4)), 'control', 'control (late)'),
                        values=c(scales::viridis_pal()(6), 'gray40', 'gray70') ) +
     coord_cartesian(xlim=c(-10, 240), ylim=c(-.01, 1.01), expand=FALSE) +
     labs(x=lac_lags_label,  y='rev. cumul. probability') +
     theme(axis.line.x=element_line(), axis.line.y=element_line(),
           strip.background=element_rect(fill='gray95', colour='transparent'), 
           legend.position = c(.99, .99), legend.justification = c(1,1),
           legend.text=element_text(size=8, face='bold'), legend.key.height=unit(0.7, "lines")) +
     NULL
  )

```



```{r}
mycells_switching_memory <- mycells_switching %>% ungroup() %>% 
  filter(!date %in% discarded_dates) %>%
  filter(!discard_arrested) %>% 
  filter(str_detect(condition, '^switch_[0-9]+h$')) %>%
  filter(switch_idx==2) %>% 
  select(date, pos, gl, ugen, genealogy) %>% 
  group_by(date, pos, gl, ugen, genealogy) %>%
  # do(parents=get_all_parents_cid(.$genealogy))
  do(tibble(parent=get_all_parents_cid(.$genealogy))) %>% 
  inner_join(
    myframes %>% ungroup %>% 
      filter(!date %in% discarded_dates) %>%
      filter(str_detect(condition, '^switch_[0-9]+h$')) %>%
      filter(medium=='lactose', m_cycle==1) %>%
      filter(abs(time_sec-(m_end-dt))<1) %>%
      select(date, pos, gl, parent=genealogy, parent_gfp=gfp_nb) %>% 
      mutate(parent=str_replace(parent, ":", "")),
    by=c("date", "pos", "gl", "parent") ) %>% 
  mutate(divs_since_par = str_length(genealogy) - str_length(parent)) %>% 
  left_join(
    mycells_switching %>% ungroup %>% 
      filter(!date %in% discarded_dates) %>%
      filter(str_detect(condition, '^switch_[0-9]+h$')) %>% 
      filter(switch_idx==2),
    by=c("date", "pos", "gl", "genealogy") )
   
```

```{r}
mycells_switching_memory %>% 
  ggplot(aes(divs_since_par, ..density.., col=condition)) + 
  geom_freqpoly(binwidth=1) +
  scale_color_manual(name='delay between\nlactose exposure',
                     limits=c(sprintf('switch_%02dh', seq(4, 24, 4))),
                     labels=c(sprintf('%dh', seq(4, 24, 4))),
                     values=c(scales::viridis_pal()(6)) ) +
  labs(x="divisions since fully induced parent") +
  NULL

```


```{r}
mycells_switching_memory %>% 
  ungroup %>% 
  mutate(gfp_inherit=parent_gfp/2^divs_since_par,
         gfp_inherit_bin=as.numeric(as.character(Hmisc::cut2(gfp_inherit, cuts=c(-Inf, 10^seq(-1.1, 3.8, .3)), levels.mean=TRUE))) ) %>% 
  gather(variable, lag, growth_lag, lag_200, factor_key=TRUE) %>% 
  filter(variable=='lag_200') %>% 
  (function(.df) 
    ggplot(.df, aes(gfp_inherit, lag/60)) + 
     # facet_grid(.~variable) +
     geom_hline(yintercept = 48, lty='dashed') +
     # geom_segment(x=0, xend=2, y=100, yend=100, data=NULL) +
     geom_segment(aes(x=pmax(0, gfp_inherit-sqrt(gfp_inherit)), xend=gfp_inherit+sqrt(gfp_inherit),
                      yend=lag/60, col=condition), alpha=.05, show.legend=FALSE) +
     geom_point(aes(col=condition), pch=20, alpha=.1) +
     stat_smooth(aes(group=1), method='loess', span=.2, col='gray60', alpha=.2) +
     geom_pointrange(aes(gfp_inherit_bin, mean, ymin=mean-se, ymax=mean+se, size=n), 
                data=.df %>% group_by(gfp_inherit_bin, variable) %>% summarise(n=n(), mean=mean(lag/60, na.rm=TRUE), se=sd(lag/60, na.rm=TRUE)/sqrt(n)),
                show.legend = FALSE) +
     scale_color_manual(name='delay between\nlactose exposure',
                        limits=c(sprintf('switch_%02dh', seq(4, 24, 4))),
                        labels=c(sprintf('%dh', seq(4, 24, 4))),
                        values=c(scales::viridis_pal()(6)) ) +
     guides(col=guide_legend(override.aes=list(alpha=1, size=2))) +
     # scale_size_continuous(range=c(0.1, 1)) +
     scale_size_continuous(range=c(0.02, 0.2)) +
     scale_x_log10() +
     coord_cartesian(xlim=c(0.1, 1.5e3), ylim=c(0, 110)) +
     labs(x='inherited GFP (molecules)', y=lac_lags_label) +
     NULL
  )

```

fraction of short/long lags

```{r}
mycells_switching_memory %>% ungroup() %>% 
  mutate(gfp_inherit=parent_gfp/2^divs_since_par,
         gfp_inherit_bin=as.numeric(as.character(Hmisc::cut2(gfp_inherit, cuts=c(-Inf, 10^seq(-1.1, 3.8, .3)), levels.mean=TRUE))) ) %>% 
  (function(.df) 
    ggplot() + 
     geom_hline(aes(yintercept=prop), lty='dashed',
                data=mycells_switching %>% ungroup %>%
                  filter(!date %in% discarded_dates) %>%
                  filter(!discard_arrested) %>% 
                  filter(str_detect(condition, '^switch_[0-9]+h$')) %>%
                  filter(switch_idx==1) %>%
                  summarise(n=n(), prop=sum(lag_200/60<48)/n)
     ) +
     geom_rect(aes(xmin=0, xmax=Inf, ymin=prop-sqrt(prop*(1-prop)/n), ymax=prop+sqrt(prop*(1-prop)/n)),
               fill='grey50', alpha=0.1,
                data=mycells_switching %>% ungroup %>% 
                  filter(!date %in% discarded_dates) %>%
                  filter(logl_time_slope_pre > min_growth_rate) %>% 
                  filter(str_detect(condition, '^switch_[0-9]+h$')) %>%
                  filter(switch_idx==1) %>% 
                  group_by(date) %>% 
                  summarise(n=n(), prop=sum(lag_200/60<48)/n)
     ) +
     geom_pointrange(aes(gfp_inherit_bin, prop, size=n, ymin=prop-se, ymax=prop+se), 
                data=.df %>% group_by(gfp_inherit_bin) %>% summarise(n=n(), prop=sum(lag_200/60<48)/n, se=sqrt(prop*(1-prop)/n))) +
     scale_size_continuous(range=c(0.05, .5), breaks=c(50, 150)) +
     scale_x_continuous(breaks=10^(0:3),
                        trans=scales::trans_new(name='log10_rev', 
                                        transform=function(x) -log(x, 10), 
                                        inverse=function(x) 10^(-x))
                        ) +
     coord_cartesian(xlim=c(0.1, 3e3)) +
     expand_limits(y=0) +
     labs(x='inherited GFP (molecules)', y='fraction of short lags', size='sample size') +
     theme(legend.position=c(0.99, 0.99), legend.justification=c(1, 1)) +
     NULL
  )

```


