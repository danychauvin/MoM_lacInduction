---
title: "Effect of growth-induced dilution on sensitivity to inducers"
author: Thomas Julou
date: "`r format(Sys.time(), '%d %B, %Y')`"
---

```{r}
myscales[['lacl_gly']] <- scale_colour_discrete(
  limits=c("switch_lactulose_TMG20", "switch_lactulose", "switch_glycerol_TMG20", "> lactose",
           "switch_lactulose_TMG20_hiIllum", "switch_lactulose_hiIllum"),
  labels=rename_conds)
  
```


## Growth arrest at the switch to lactose

All naive cells stop growing for at least 9', 99% for at least 15'.

```{r}
(myplots[['naive_arrest_cdf']] <-
   mycells_switching %>% ungroup() %>% 
   filter(!date %in% discarded_dates) %>%
   filter(!discard_arrested) %>% 
   filter(str_detect(condition, '^switch_[0-9]+h$')) %>%
   filter(switch_idx==1) %>%
   # mutate(lag=ifelse(lag<240*60, lag, 245*60),
   # lag=ifelse(is.na(lag), -10, lag)) %>% 
   ggplot(aes(x=growth_lag/60)) +
   stat_ecdf(aes(y=1-..y.., col=switch_idx), show.legend=FALSE) +
   labs(x='time after the switch (min)', y='fraction of growth arrested cells') +
   coord_cartesian(xlim=c(0, 240), ylim=c(0, 1.05)) +
   scale_x_continuous(expand = expand_scale(0, 0)) +
   scale_y_continuous(expand = expand_scale(0, 0)) +
   NULL
) +
  labs(subtitle='naive cells (9 independent experiments)')

```


```{r}
myplots[['naive_arrest_frac']] <-
  mycells_switching %>% ungroup() %>% 
  filter(!date %in% discarded_dates) %>%
  filter(!discard_arrested) %>% 
  filter(str_detect(condition, '^switch_[0-9]+h$')) %>%
  filter(switch_idx==1) %>%
  (function(.df, .delay=c(9, 15)) {
    .lags <- .df %>% pull(growth_lag)
    data.frame(delay=.delay) %>% group_by(delay) %>% 
      mutate(p_arrest=sum(.lags/60 > delay, na.rm=TRUE)/sum(!is.na(.lags)))
  }) %>% 
  (function(.df)
    ggplot(.df, aes(x=factor(1), p_arrest)) +
     geom_col(aes(y=1, fill='0'), position='identity') +
     geom_col(aes(fill=factor(delay)), position='identity') +
     geom_vline(xintercept=1.45) +
     coord_polar(theta='y') +
     scale_fill_manual(name='growth arrest', breaks=c(0, 9, 15),
                       values=c('black', 'white', 'grey'),
                       labels=c('shorter than 9 min', 'between 9 and 15 min', 'longer than 15 min')) +
     theme_void() +
     theme(legend.position = 'left') +
     NULL
  )

```


## Decoupling growth-mediated dilution and induction

In order to compare induction at a given inducer concentration in growing and arrested cells, we use lactulose. *E. coli* can metabolize lactulose when it expresses LacY and LacZ but lactulose is reported not to be an inhibitor of LacI. Hence an mixture of lactulose and TMG can be used to recapitulate the phenomenology of the induction by lactose (although at the concentration of nutrient and inducer can be decoupled).

The fraction of induced cells has been reported to increase abruptly with the (log of the) TMG concentration. We identify the upper range of TMG concentrations that are low enough that no cell induce after 5h when growing on glycerol. xxx
We predict that this concentration of TMG will be induced for cells to induce and resume growth when switched to TMG and lactulose, since cells cannot use lactulose after the switched and are foreced to transiently stop growing.


```{r eval=FALSE}
myrates_lactulose <- myframes %>% 
  ungroup %>% 
  filter(!discard_top) %>% 
  filter(str_detect(condition, 'TMG') | str_detect(condition, 'lactulose')) %>%
  filter(!(date==20181008 & pos %in% 5:9), !(date==20181009 & pos %in% c(1,3,5,7,9))) %>% 
  # loop on all cells
  # group_by(condition, date, pos, gl, id, cell) %>%
  partition(condition, strain, date, pos, gl, id, cell,
            cluster=mycluster) %>%
  do( (function(.dfc, .rate_hw=3*360){
    .dfc %>% 
      group_by(time_sec) %>% 
      do((function(.p) {
        # browser()
        .df <- filter(.dfc, between(time_sec, .p[['time_sec']]-.rate_hw, .p[['time_sec']]+.rate_hw))
        .mod_ll <- lm(log(length_um)~time_sec, .df)
        # .mod_ll <- fastLmPure( cbind(1, .df$time_sec), log(.df$length_um) )
        .mod_g_l <- fastLmPure( cbind(1, .df$length_um), .df$gfp_nb )
        data.frame(irate_npoints=nrow(.df), igfp_nb=mean(.df$gfp_nb), 
                   iloglength=predict(.mod_ll, select(.p, time_sec)),
                   islope_ll_time=.mod_ll$coefficients[2],# islopesd_ll_time=.mod_ll$stderr[2],
                   ir2_ll_time=cor(.df$time_sec, log(.df$length_um), use="complete.obs")^2,
                   islope_g_l=.mod_g_l$coefficients[2], islopesd_g_l=.mod_g_l$stderr[2],
                   ir2_g_l=cor(.df$length_um, .df$gfp_nb, use="complete.obs")^2)
      })(.) )
  })(.) ) %>% 
  collect()

```


First let's look at some raw length traces, coloured using an arbitrary fluorescence concentration threshold (to visualise cells expressing LacZ-GFP at detectable levels). It reveals that some cells can grow on lactulose without TMG (and even sometimes express LacZ-GFP weakly); however, when exposed to lactulose and TMG cells express more LacZ-GFP and grow faster. The sustained growth on lactulose without TMG can be due to nutrients traces in lactulose (in particular galactose) or to undocumented induction by lactulose (e.g. if glycerol is present in the cytoplasm, galactosyl-glycerol will be produced by LacZ similarly to allolactose synthesis).

This constitutes a confounding effect since we need to distinguish the inducing effect of the TMG from the weak spontaneous induction observed in lactulose only.

In addition, after comparing the induction by TMG in cells growing on glycerol or lactulose using our default imaging protocol (using a 2x lower acquisition frequency, condition named "stdIllum", we noticed that an unexpectdly high fraction of cells stopped growing and didn't induce in lactulose+TMG. We hypothesised that growth arrested cells were more sensitive to phototoxicity and repeated the experiments by reducing 5× the fluorescence illumination during the lactulose episode and switching cells back to glycerol in order to check whether arrested cells (if any) are still viable.


```{r fig.height=12}
(myplots[['lacl_time_series']] <-
   myframes %>% 
   ungroup() %>% 
   filter(time_sec > 2*3600, !discard_top) %>% 
   filter(str_detect(condition, 'TMG') | str_detect(condition, 'lactulose')) %>%
   group_by(date, pos, gl) %>% sample_n_groups(20) %>% 
   # filter(end_type == 'lost') %>% 
   ggplot(aes(time_sec - 2*3600, length_um, col=gfp_nb/length_um>250)) +
   facet_wrap(~ condition+date + pos+gl, dir="v", ncol=2,
              labeller=labeller(condition=as_labeller(rename_conds), .multi_line=FALSE)) +
   # geom_rect(aes(xmin=t_start - 2*3600, xmax=t_end - 2*3600, ymin=-Inf, ymax=Inf, x=NaN, y=NaN, group=1), fill=rgb(1, 0, 0, .1), col='red', data=filter(condition_ts, condition=='switch', medium=='lactose')) +
   geom_path(aes(group=ugen)) + # geom_point() +
   # scale_colour_periodic_brewer(guide='none') +
   # scale_alpha_discrete(range=c(0.1, 0.6)) +
   scale_x_hours() + #, limits=c(19*3600, 23*3600)) +
   scale_y_continuous(trans='log2') +
   labs(y='length (µm)', col='induced') +
   theme(legend.position="top")
)

```
 
```{r eval=FALSE}
myframes_switching %>% 
  filter(fit_lag) %>% 
  filter(str_detect(condition, 'TMG') | str_detect(condition, 'lactulose')) %>%
  filter(type=='cell') %>% 
  group_by(condition, date, ugen) %>% 
  slice(n()) %>% 
  ggplot(aes(time_sec - 2*3600, gfp_nb, col=end_type, alpha=type)) +
  facet_wrap(~condition+date, dir="v", ncol=2, labeller=labeller(.cols=label_value, .multi_line=FALSE)) +
  # geom_rect(aes(xmin=t_start - 2*3600, xmax=t_end - 2*3600, ymin=-Inf, ymax=Inf, x=NaN, y=NaN, group=1), fill=rgb(1, 0, 0, .1), col='red', data=filter(condition_ts, condition=='switch', medium=='lactose')) +
  geom_point() + # geom_point() +
  # scale_colour_periodic_brewer(guide='none') +
  scale_alpha_discrete(range=c(0.1, 0.6)) +
  scale_x_hours() + #, limits=c(19*3600, 23*3600)) +
  ylim(-100, 4e3) +   expand_limits(x=0, y=0) +
  labs(y='total fluorescence (GFP molecules)') +
  theme(legend.position="top") +
  NULL

```


By increasing the induction threshold (+1000 LacZ-GFP molecules instead of +200 by default; picked according to raw traces), it is possible to mesure induction lags specific for TMG in lactulose. These distributions indicate a large fraction of non inducing cells (see below for a more detailed analysis). Noticeably, using a lower induction threshold, an induction lag can be measured for more cells but at the cost of observing more cells induced by lactulose only (hence the induction lag doesn't correspond to the TMG specific induction anymore).

Importantly, the distribution of induction lags is not truncated and indicates that all induction has already taken place after 7h. In further analysis, we will compare LacZ-GFP level and instantaneous growth rate at this time.

```{r}
(myplots[['lags_hist_lacl_facets']] <-
   mycells_switching %>% 
   filter(str_detect(condition, 'TMG') | str_detect(condition, 'lactulose'), 
          condition!='switch_glycerol_TMG20') %>% 
   mutate(lag=lag_1000,
   # mutate(lag=lag_200,
          lag=ifelse(!is.infinite(lag), lag, max(lag[is.finite(lag)])+60),
          lag=ifelse(is.na(lag), -1, lag)
   ) %>% 
   ggplot(aes(lag/60)) +
   facet_wrap(~condition, scales='free_y', labeller=as_labeller(rename_conds)) +
   geom_freqpoly(aes(col=condition, group=factor(date)), alpha=.8, position='identity', binwidth=18, show.legend=FALSE) +
   myscales[['lacl_gly']] +
   expand_limits(x=0) +
   scale_y_log10() +
   labs(x=lac_lags_label)
)

```


### Growth arrest at the switch

Since length traces have more complex shapes than for the switch to lactose, it is not possible to fit a model corresponding to no growth followed by linear increase. Instead we compare the instantaneous growth rate right after the switch with growth rates measured after 7h (i.e. when induction has already taken place).

```{r}
myframes_switching %>% 
  ungroup() %>% 
  # filter(between(time_sec/3600, 6, 15.99), !discard_top) %>% 
  filter(str_detect(condition, 'TMG')) %>% #  | str_detect(condition, 'lactulose')
  filter(switch_idx==1) %>% 
  filter(time_sec>=t_lac_switch, time_sec<=t_lac_switch+3*360+10) %>% 
  group_by(condition, date, pos, gl, id) %>%
  # summarise(n=n()) %>% qplot(n, data=.)
  filter(n()==4) %>% 
  do(mod_ll_t=lm(log(length_um)~time_sec, data=.)) %>% 
  mutate(islope_ll_time=mod_ll_t$coefficients[2], 
         islope_ll_time_sd=summary(mod_ll_t)$coefficients[2,2],
         # ir2_ll_time=summary(mod_ll_t)$r.squared,
         ) %>% 
  # ggplot(aes(rate_sd, rate)) +
  # geom_point(stroke=0, alpha=.1)
  ggplot(aes(islope_ll_time/log(2)*3600, y=..density.., col=condition)) +
  geom_freqpoly(aes(lty='7 h'), binwidth=.08,
                data= myrates_lactulose %>% ungroup() %>% 
                  filter(between(time_sec/3600, 14, 15.99)) %>%
                  # filter(time_sec/3600==8+7) %>%
                  # filter(irate_npoints>3, ir2_ll_time>0.8) %>% 
                  left_join(myframes %>% select(condition, date, pos, gl, id, time_sec, length_um, gfp_nb)) %>% 
                  filter((str_detect(condition, 'lactulose_TMG20') & gfp_nb/length_um > 250) | 
                           condition=='switch_glycerol_TMG20') ) +
  geom_freqpoly(aes(lty='0 h'), binwidth=.08) +
  coord_cartesian(xlim=c(-0.4, 1.2)) +
  myscales[['lacl_gly']] + # guides(col=guide_legend()) +
  scale_linetype_manual(breaks=c('0 h', '7 h'), values=c('dotted', 'solid')) +
  labs(x='inst. growth rate (dbl/h)', lty='time after the switch') +
  # guides(col='none') +
  # theme(legend.position='top') +
  NULL

```


### LacZ-GFP expression and growth after the lag

We focus on cells seen 7h after the switch (i.e. after all inducible cells have switched on. Three expression states can be distinguised in the distributions of LacZ-GFP concentration:

- uninduced (before the switch or with glycerol; <100 molecules/µm)
- weak spontaneous induction due to lactulose (between 100 and 250 molecules)
- induction due to TMG in lactulose (>250 molecules/µm)


```{r eval=FALSE}
(myplots[['lacl_gfp_snapshot_hist']] <-
   myframes %>%
   ungroup() %>%
   filter(str_detect(condition, 'TMG') | str_detect(condition, 'lactulose')) %>%
   filter(!discard_top) %>%
   filter(time_sec/3600==8+7) %>%
   mutate(condition=rename_conds(condition)) %>%
   ggplot(aes(gfp_nb/length_um)) +
   geom_freqpoly(aes(y=..density.., col=condition, group=date), binwidth=50) +
   # coord_cartesian(xlim=c(-0.2, 1)) +
   labs(x='LacZ-GFP concentration (molecules/µm)', subtitle='7h after the switch') +
   NULL
)

```


```{r}
myrates_lactulose %>% 
  ungroup() %>% 
  # filter(between(time_sec/3600, 14, 15.99)) %>% 
  # filter(between(time_sec/3600, 16, 18)) %>%
  filter(time_sec/3600==8+7) %>%
  # filter(irate_npoints>3, ir2_ll_time>0.8) %>% 
  left_join(myframes %>% select(condition, date, pos, gl, id, time_sec, length_um, gfp_nb)) %>% 
  mutate(type=ifelse(islope_ll_time/log(2)*3600 > 0.1, 'growing', 'non growing')) %>% 
  bind_rows(., mutate(., type='all')) %>% 
  bind_rows(myframes %>% ungroup() %>%
              filter(str_detect(condition, '^switch_[0-9]+h$')) %>%
              filter(medium=='lactose', m_cycle==1, time_sec==m_start + 3.5*3600) %>%
              # filter(condition=='lactose') %>% 
              filter(!discard_start, !discard_top) %>%
              mutate(condition='> lactose', type='all')) %>% 
  mutate(condition=fct_relevel(condition, "> lactose", after=Inf)) %>% 
  ggplot(aes(gfp_nb/length_um)) +
  facet_grid(condition~., scales='free_y', labeller=as_labeller(rename_conds)) +
  geom_freqpoly(aes(col=condition, lty=type), binwidth=50) +
  myscales[['lacl_gly']] +
  # coord_cartesian(xlim=c(-0.2, 1)) +
  labs(subtitle='7h after the switch', x='LacZ-GFP concentration (molecules/µm)') +
  guides(col='none') +
  theme(legend.position='top') +
  NULL 

```


```{r}
myrates_lactulose %>% 
  ungroup() %>% 
  # filter(between(time_sec/3600, 14, 15.99)) %>% 
  # filter(between(time_sec/3600, 16, 18)) %>%
  filter(time_sec/3600==8+7) %>%
  # filter(irate_npoints>3, ir2_ll_time>0.8) %>% 
  left_join(myframes %>% select(condition, date, pos, gl, id, time_sec, length_um, gfp_nb)) %>% 
  mutate(type=ifelse(gfp_nb/length_um > 250, 'induced', 'non induced')) %>% 
  bind_rows(., mutate(., type='all')) %>% 
  mutate(condition=factor(as.character(condition))) %>% 
  ggplot(aes(islope_ll_time/log(2)*3600)) +
  facet_grid(condition~., scales='free_y', labeller=as_labeller(rename_conds)) +
  geom_freqpoly(aes(y=..count.., col=condition, lty=type), binwidth=.04) +
  myscales[['lacl_gly']] +
  coord_cartesian(xlim=c(-0.2, 1)) +
  labs(x='inst. growth rate (dbl/h)') +
  guides(col='none') +
  theme(legend.position='top') +
  NULL

# a1 <- rnorm(20)
# b1 <- ggplot2:::bin_breaks_width(range(a1), .1)
# ggplot2:::bin_vector(a1, b1)

myframes %>% 
  ungroup() %>% 
  filter(str_detect(condition, 'TMG') | str_detect(condition, 'lactulose')) %>%
  filter(!discard_top) %>% 
  filter(time_sec/3600==8+7) %>%
  group_by(condition) %>% 
  summarise(n=n(), n_induced=sum(gfp_nb/length_um>250), p_induced=n_induced/n)
  
```

Stratifying the distributions by time after the switch (using 2h windows) confirms that LacZ-GFP expression has reached steady state at 7h after the switch (between 6 and 8h).

```{r}
myframes %>% 
  ungroup() %>% 
  filter(between(time_sec/3600, 6, 8+11.99), !discard_top) %>% 
  filter(str_detect(condition, 'TMG') | str_detect(condition, 'lactulose')) %>%
  mutate(time_bin=cut(time_sec/3600-8, breaks=seq(-2,100,2), right=FALSE)) %>% 
  # filter(end_type == 'lost') %>% 
  ggplot(aes(gfp_nb/length_um, col=condition)) +
  facet_grid(time_bin~., labeller=labeller(.multi_line=FALSE)) +
  geom_freqpoly(aes(y=..density.., group=date), binwidth=50) +
  # geom_freqpoly(aes(group=date), binwidth=40) +
  myscales[['lacl_gly']] +
  # theme(legend.position="top") +
  scale_y_log10() +
  labs(x='LacZ-GFP concentration (molecules/µm)') +
  NULL

```

Since lactulose is not an inducer of the *lac* operon, the quantity of catabolic Lac enzymes is limiting growth at low TMG concentration. As a result, the instantaneous growth rate depends strongly on the LacZ-GFP concentration.
<!-- Importantly, for cells spontaneously inducing in lactulose, their instantaneous growth rate doesn't depend on the LacZ-GFP concentration while it does for cells exposed to TMG. This suggest that the weak induction comes from another mechanisms?!? xxx -->

NB: not all data is shown.

```{r}
myrates_lactulose %>% 
  ungroup() %>% 
  # filter(condition!='switch_glycerol_TMG20') %>% 
  left_join(myframes) %>% 
  # filter(between(time_sec/3600, 8+18/60, 15.99)) %>% 
  # filter(between(time_sec/3600, 8+18/60, 8.99+18/60)) %>%
  filter(between(time_sec/3600, 14+18/60, 15.99+18/60)) %>%
  # filter(irate_npoints>3, ir2_ll_time>0.8) %>%
  mutate(condition=fct_relevel(fct_drop(condition), "switch_glycerol_TMG20", after=2)) %>%
  group_by(condition) %>%
  mutate(gfp_conc_cut=Hmisc::cut2(gfp_nb/length_um, cuts=seq(-100, 2e4, 100), levels.mean=TRUE)) %>% 
  # summarise(n=n(), r2=cor(igfp_nb, islope_ll_time)^2)
  (function(.df) 
    ggplot(.df, aes(gfp_nb/length_um, islope_ll_time/log(2)*3600, col=condition)) +
     facet_wrap(~condition, labeller=as_labeller(rename_conds)) +
     # geom_density2d() +  
     # geom_point(alpha=.1, stroke=0, data=.df) +
     geom_point(alpha=.2, stroke=0, data=sample_n(ungroup(.df), 5e3)) +
     stat_summary(aes(as.numeric(as.character(gfp_conc_cut))), fun.data=mean_se, geom="pointrange", col='black') +
     geom_hline(yintercept=0.1, lty='dotted') + geom_vline(xintercept = 250, lty='dotted') +
     myscales[['lacl_gly']] +
     coord_cartesian(xlim=c(-50, 1500), ylim=c(-0.15, 1)) +
     guides(col='none') +
     labs(x='LacZ-GFP concentration (molecules/µm)', y='inst. growth rate (dbl/h)') +
     NULL
  )

```


```{r eval=FALSE}
# trying to work out the delay between LacZ-GFP level and growth
myrates_lactulose %>% 
  ungroup() %>% 
  # filter(condition!='switch_glycerol_TMG20') %>% 
  left_join(myframes) %>% 
  # ggplot(aes(length_um, exp(iloglength))) + geom_point(stroke=0, alpha=.1, position = position_jitter())
  filter(between(time_sec/3600, 10+18/60, 14.99+18/60)) %>% 
  group_by(condition, date, pos, gl, id) %>% 
  # mutate(keep = ir2_ll_time > 0.8 & n() > 4) %>% 
  mutate(keep = between(islope_ll_time/log(2)*3600, -.15, 1), 
         keep = keep & sum(keep) > 4) %>% 
  # group_by(date) %>% summarise(ntot=n(), n=sum(!is.na(keep)), keep=sum(keep, na.rm=T))
  # ggplot(aes(islope_ll_time/log(2)*3600, col=condition, group=date)) + geom_freqpoly(binwidth=.02) + coord_cartesian(xlim=c(-0.1, 1))
  # filter(keep) %>% 
  filter(n() > 4) %>% 
  do((function(.df){
    # browser()
    .ccf <- ccf(.df$islope_ll_time, exp(.df$iloglength), lag.max=NULL, na.action=na.pass, plot=FALSE)
    data.frame(lag=.ccf$lag*6, ccf=.ccf$acf)
  })(.)) %>% 
  ggplot(aes(lag, ccf)) +
  geom_hline(yintercept = 0, lty='dotted') +
  # geom_path(aes(col=interaction(date, pos, gl, id)), alpha=.1) +
  stat_summary(aes(fill=condition, group=date), alpha=0.1, geom="ribbon", 
               fun.data=mean_se) +
               # fun.data=mean_sdl, fun.args = list(mult = 1)) +
  stat_summary(aes(col=condition, group=date), geom="smooth", 
               fun.data=mean_se) +
               # fun.data=mean_sdl, fun.args = list(mult = 1)) +
  # scale_colour_periodic_brewer(guide='none') +
  xlim(-60, 60) +
  labs(x='lag (min)', y='coss-correlation gr(t+lag), [GFP](t)',
       subtitle='NB: the growth rate is computed over ±18min!')

```


Summarizing with proportions

```{r}
# myplots[['lacl_arrest_induction_fracs']] <-
bind_rows(
  myframes %>% 
    ungroup() %>% 
    filter(str_detect(condition, 'TMG')) %>% 
    filter(!discard_top) %>% 
    filter(time_sec/3600==8+7) %>%
    group_by(condition) %>% 
    summarise(variable='lac induction', n_true=sum(gfp_nb/length_um>250), n=n(), 
              # p_induced=n_true/n,
    ),
  # tribble(
  #   ~variable, ~condition, ~n_true, ~n,
  #   'growth arrest', 'switch_glycerol_TMG20', 0, 110,
  #   'growth arrest', 'switch_lactulose_TMG20', 101, 105)
) %>% 
  group_by(condition, variable) %>% 
  mutate(p_true=n_true/n, p_false=1-p_true, n_true, n=NULL) %>% 
  
  gather(type, value, p_true, p_false) %>% 
  mutate(type=str_replace(type, 'p_', '')) %>% 
  ggplot() +
  facet_grid(variable~condition, labeller=as_labeller(rename_conds), switch='y') +
  geom_col(aes(x=factor(1), value, fill=factor(type))) +
  geom_rect(
    aes(xmin=.55, xmax=1.45, ymin=p_min, ymax=p_max), fill='white', alpha=.8,
    data=myrates_lactulose %>% 
      ungroup() %>% 
      filter(str_detect(condition, 'lactulose_TMG')) %>% 
      filter(time_sec/3600==8+7) %>%
      # filter(irate_npoints>3, ir2_ll_time>0.8) %>% 
      left_join(myframes %>% select(condition, date, pos, gl, id, time_sec, length_um, gfp_nb)) %>%
      mutate(arrested=islope_ll_time/log(2)*3600<0.1, induced=gfp_nb/length_um>250) %>% 
      group_by(condition, arrested, induced) %>% 
      summarise(n=n()) %>% 
      group_by(condition, induced) %>% 
      summarise(n_arrest=n[arrested], n=sum(n)) %>% 
      group_by(condition) %>% 
      do((function(.df) 
        with(.df, data.frame(p_min=c(0, 1-n_arrest[!induced]/sum(n)), 
                             p_max=c(n_arrest[induced]/sum(n), 1)) ))(.)) %>% 
      mutate(variable='lac induction')
  ) +
  coord_polar(theta='y') +
  theme_void() +
  theme(strip.text.x=element_text(size=rel(1.2)),
        strip.text.y=element_text(size=rel(1.2), angle=180),
        legend.position='bottom', 
        legend.title = element_blank(),
  ) +
  NULL

```


### Summary

We focus on low illumination data.

```{r eval=FALSE}
myplots[['lags_hist_lacl']] <-
   mycells_switching %>% 
   filter(condition=='switch_lactulose_TMG20') %>% 
   mutate(lag=lag_1000,
          # mutate(lag=lag_200,
          # lag=ifelse(!is.infinite(lag), lag, max(lag[is.finite(lag)])+60),
          # lag=ifelse(is.na(lag), -1, lag)
   ) %>% 
   ggplot(aes(lag/60)) +
   geom_freqpoly(aes(col=rename_conds(condition)), alpha=.8, binwidth=18) +
   expand_limits(x=0) +
   labs(x=lac_lags_label, col='') +
   theme(legend.position = c(1,1), legend.justification = c(1,1), legend.title = element_blank()) +
   NULL

```

```{r SM_figs, results='hide'}
(myplots[['TMG_switch_gr_hist']] <-
myframes_switching %>% 
  ungroup() %>% 
  # filter(between(time_sec/3600, 6, 15.99), !discard_top) %>% 
  filter(str_detect(condition, 'TMG') | str_detect(condition, 'lactulose'), 
         !str_detect(condition, 'Illum')) %>% 
  filter(switch_idx==1) %>% 
  filter(time_sec>=t_lac_switch, time_sec<=t_lac_switch+3*360+10) %>% 
  group_by(condition, date, pos, gl, id) %>%
  # summarise(n=n()) %>% qplot(n, data=.)
  filter(n()==4) %>% 
  do(mod_ll_t=lm(log(length_um)~time_sec, data=.)) %>% 
  mutate(islope_ll_time=mod_ll_t$coefficients[2], 
         islope_ll_time_sd=summary(mod_ll_t)$coefficients[2,2],
         # ir2_ll_time=summary(mod_ll_t)$r.squared,
         ) %>% 
  # ggplot(aes(rate_sd, rate)) +
  # geom_point(stroke=0, alpha=.1)
  ggplot(aes(islope_ll_time/log(2)*3600, y=..density.., col=condition)) +
  geom_freqpoly(aes(lty='7 h'), binwidth=.08,
                data= myrates_lactulose %>% ungroup() %>% 
                  filter(between(time_sec/3600, 14, 15.99)) %>%
                  # filter(time_sec/3600==8+7) %>%
                  # filter(irate_npoints>3, ir2_ll_time>0.8) %>% 
                  left_join(myframes %>% select(condition, date, pos, gl, id, time_sec, length_um, gfp_nb)) %>% 
                  filter((str_detect(condition, 'lactulose_TMG20$') & gfp_nb/length_um > 250) |
                           condition %in% c('switch_glycerol_TMG20', 'switch_lactulose'))
                  # filter(str_detect(condition, 'TMG') | str_detect(condition, 'lactulose'), 
                         # !str_detect(condition, 'Illum'))
                ) +
  geom_freqpoly(aes(lty='0 h'), binwidth=.08) +
  coord_cartesian(xlim=c(-0.4, 1.2)) +
  scale_colour_discrete(
    limits=c("switch_lactulose_TMG20", "switch_lactulose", "switch_glycerol_TMG20"),
    labels=rename_conds) +
  scale_linetype_manual(breaks=c('0 h', '7 h'), values=c('solid', 'dotted')) +
  labs(x='inst. growth rate (dbl/h)', lty='time after the switch') +
  # guides(col='none') +
  # theme(legend.position='top') +
  NULL
)

(myplots[['lacl_gr_lacz']] <-
   myrates_lactulose %>% 
   ungroup() %>% 
   filter(str_detect(condition, 'TMG') | str_detect(condition, 'lactulose'), 
          !str_detect(condition, 'Illum')) %>% 
   left_join(myframes) %>% 
   filter(between(time_sec/3600, 14+18/60, 15.99+18/60)) %>%
   # mutate(condition=fct_relevel(fct_drop(condition), "switch_glycerol_TMG20", after=2)) %>%
   mutate(condition=factor(as.character(condition))) %>% 
   group_by(condition) %>%
   mutate(gfp_conc_cut=Hmisc::cut2(gfp_nb/length_um, cuts=seq(-100, 2e4, 100), levels.mean=TRUE)) %>% 
   # summarise(n=n(), r2=cor(igfp_nb, islope_ll_time)^2)
   (function(.df) 
     ggplot(.df, aes(gfp_nb/length_um, islope_ll_time/log(2)*3600, col=condition)) +
      facet_wrap(~condition, labeller=as_labeller(rename_conds)) +
      # geom_density2d() +  
      # geom_point(alpha=.1, stroke=0, data=.df) +
      geom_point(alpha=.2, stroke=0, data=sample_n(ungroup(.df), 5e3)) +
      stat_summary(aes(as.numeric(as.character(gfp_conc_cut))), fun.data=mean_se, geom="pointrange", col='black') +
      geom_hline(yintercept=0.1, lty='dotted') + geom_vline(xintercept = 250, lty='dotted') +
      myscales[['lacl_gly']] +
      coord_cartesian(xlim=c(-50, 1500), ylim=c(-0.15, 1)) +
      guides(col='none') +
      labs(x='LacZ-GFP concentration (molecules/µm)', y='inst. growth rate (dbl/h)') +
      NULL
   ))

(myplots[['lacl_gfp_facets']] <-
   myrates_lactulose %>% 
   ungroup() %>% 
   filter(str_detect(condition, 'TMG') | str_detect(condition, 'lactulose'), 
          !str_detect(condition, 'Illum')) %>% 
   # filter(between(time_sec/3600, 14, 15.99)) %>% 
   # filter(between(time_sec/3600, 16, 18)) %>%
   filter(time_sec/3600==8+7) %>%
   # filter(irate_npoints>3, ir2_ll_time>0.8) %>% 
   left_join(myframes %>% select(condition, date, pos, gl, id, time_sec, length_um, gfp_nb)) %>% 
   mutate(type=ifelse(islope_ll_time/log(2)*3600 > 0.1, 'growing', 'non growing')) %>% 
   bind_rows(., mutate(., type='all')) %>% 
   bind_rows(myframes %>% ungroup() %>%
               filter(str_detect(condition, '^switch_[0-9]+h$')) %>%
               filter(medium=='lactose', m_cycle==1, time_sec==m_start + 3.5*3600) %>%
               # filter(condition=='lactose') %>% 
               filter(!discard_start, !discard_top) %>%
               mutate(condition='> lactose', type='all')) %>% 
   mutate(condition=fct_relevel(condition, "> lactose", after=Inf)) %>% 
   ggplot(aes(gfp_nb/length_um)) +
   facet_grid(condition~., scales='free_y', labeller=as_labeller(
        function(.x) rename_conds(.x) %>% str_replace(" TMG20", "\nTMG20")) ) +
   geom_freqpoly(aes(col=condition, lty=type), binwidth=100) +
   geom_vline(aes(xintercept=250), lty='dashed', 
              data=data.frame(condition=c('switch_lactulose_TMG20', 'switch_lactulose'))) +
   scale_colour_discrete(
     limits=c("switch_lactulose_TMG20", "switch_lactulose", "switch_glycerol_TMG20", "> lactose"),
     labels=rename_conds) +
   # coord_cartesian(xlim=c(-0.2, 1)) +
   labs(x='LacZ-GFP concentration (molecules/µm)') +
   guides(col='none') +
   theme(legend.position='top') +
   NULL
) +
  labs(subtitle='7h after the switch')

(myplots[['lacl_gr_facets']] <-
   myrates_lactulose %>% 
   ungroup() %>% 
   filter(str_detect(condition, 'TMG') | str_detect(condition, 'lactulose'), 
          !str_detect(condition, 'Illum')) %>% 
   # filter(between(time_sec/3600, 14, 15.99)) %>% 
   # filter(between(time_sec/3600, 16, 18)) %>%
   filter(time_sec/3600==8+7) %>%
   # filter(irate_npoints>3, ir2_ll_time>0.8) %>% 
   left_join(myframes %>% select(condition, date, pos, gl, id, time_sec, length_um, gfp_nb)) %>% 
   mutate(type=ifelse(gfp_nb/length_um > 250, 'induced', 'non induced')) %>% 
   bind_rows(., mutate(., type='all')) %>% 
   mutate(condition=factor(as.character(condition))) %>% 
   ggplot(aes(islope_ll_time/log(2)*3600)) +
   facet_grid(condition~., scales='free_y', labeller=as_labeller(
        function(.x) rename_conds(.x) %>% str_replace(" TMG20", "\nTMG20")) ) +
   geom_freqpoly(aes(y=..count.., col=condition, lty=type), binwidth=.04) +
   geom_vline(aes(xintercept=0.1), lty='dashed', 
              data=data.frame(condition=c('switch_lactulose_TMG20', 'switch_lactulose'))) +
   myscales[['lacl_gly']] +
   coord_cartesian(xlim=c(-0.2, 1)) +
   labs(x='inst. growth rate (dbl/h)') +
   guides(col='none') +
   theme(legend.position='top') +
   NULL
)

```


```{r}
(myplots[['lacl_gr_hist']] <-
   myframes_switching %>% 
  ungroup() %>% 
  # filter(between(time_sec/3600, 6, 15.99), !discard_top) %>% 
  filter(condition %in% c('switch_glycerol_TMG20', 'switch_lactulose_TMG20')) %>%
  filter(switch_idx==1) %>% 
  filter(time_sec>=t_lac_switch, time_sec<=t_lac_switch+3*360+10) %>% 
  group_by(condition, date, pos, gl, id) %>%
  # summarise(n=n()) %>% qplot(n, data=.)
  filter(n()==4) %>% 
  do(mod_ll_t=lm(log(length_um)~time_sec, data=.)) %>% 
  mutate(islope_ll_time=mod_ll_t$coefficients[2], 
         islope_ll_time_sd=summary(mod_ll_t)$coefficients[2,2],
         # ir2_ll_time=summary(mod_ll_t)$r.squared,
  ) %>% 
   mutate(condition=fct_relevel(condition, 'switch_glycerol_TMG20')) %>% 
   # ggplot(aes(rate_sd, rate)) +
   # geom_point(stroke=0, alpha=.1)
   ggplot(aes(islope_ll_time/log(2)*3600, y=..density.., col=condition)) +
   facet_grid(condition~., scales='free_y') +
   geom_freqpoly(aes(lty='7 h'), binwidth=.08,
                 data= myrates_lactulose %>% ungroup() %>% 
                   filter(between(time_sec/3600, 14, 15.99)) %>%
                   # filter(time_sec/3600==8+7) %>%
                   # filter(irate_npoints>3, ir2_ll_time>0.8) %>% 
                   left_join(myframes %>% select(condition, date, pos, gl, id, time_sec, length_um, gfp_nb)) %>% 
                   mutate(condition=fct_relevel(condition, 'switch_glycerol_TMG20')) %>% 
                   filter((condition=='switch_lactulose_TMG20' & gfp_nb/length_um > 250) | 
                            condition=='switch_glycerol_TMG20') ) +
   geom_freqpoly(aes(lty='0 h'), binwidth=.08) +
   coord_cartesian(xlim=c(-0.2, 1.1)) +
   # scale_colour_discrete(labels=rename_conds, guide='none') +
   scale_linetype_manual(breaks=c('0 h', '7 h'), values=c('dotted', 'solid')) +
   labs(x='inst. growth rate (dbl/h)', lty='time after the switch') +
   guides(col='none') +
   theme(legend.position='top') +
   NULL
)

(myplots[['lacl_lacGFP_hist']] <- myframes %>% select(condition, date, pos, gl, id, time_sec, length_um, gfp_nb) %>% 
    ungroup() %>% 
    filter(condition %in% c('switch_glycerol_TMG20', 'switch_lactulose_TMG20')) %>%
    filter(between(time_sec/3600, 8+7, 8+8)) %>%
    mutate(condition=fct_relevel(condition, 'switch_glycerol_TMG20')) %>% 
    ggplot(aes(gfp_nb/length_um, ..density..)) +
    facet_grid(condition~., scales='free_y') +
    geom_freqpoly(aes(col=condition), binwidth=50) +
    geom_vline(aes(xintercept=250), data.frame(condition='switch_lactulose_TMG20'), lty='dashed') +
    scale_y_continuous(breaks=function(.l){ if (.l[2] > 0.01) {c(0, 5, 10, 15)*1e-3} else {c(0, 5, 10)*1e-4} },
                       # labels=scales::number_format(NULL),
                       ) +
    # coord_cartesian(xlim=c(-0.2, 1)) +
    labs(x='[LacZ-GFP] (molecules/µm)') +
    guides(col='none') +
    theme(legend.position='top') +
    NULL
)

```


