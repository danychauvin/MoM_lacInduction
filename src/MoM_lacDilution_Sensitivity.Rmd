---
title: "Effect of growth-induced dilution on sensitivity to inducers"
author: Thomas Julou
date: "`r format(Sys.time(), '%d %B, %Y')`"
---

## Growth arrest at the switch to lactose

All cells stop growing for at least 9', 99% for at least 15'.

```{r}
mycells_switching %>% ungroup() %>% 
  filter(!date %in% discarded_dates) %>%
  filter(!discard_arrested) %>% 
  filter(str_detect(condition, '^switch_[0-9]+h$')) %>%
  filter(switch_idx==1) %>%
  # mutate(lag=ifelse(lag<240*60, lag, 245*60),
         # lag=ifelse(is.na(lag), -10, lag)) %>% 
  ggplot(aes(x=growth_lag/60)) +
  stat_ecdf(aes(y=1-..y.., col=switch_idx), show.legend=FALSE) +
  labs(x='time after the switch (min)', y='fraction of growth arrested cells',
       title='naive cells (9 independent experiments)') +
  coord_cartesian(xlim=c(0, 220)) +
  NULL

mycells_switching %>% ungroup() %>% 
  filter(!date %in% discarded_dates) %>%
  filter(!discard_arrested) %>% 
  filter(str_detect(condition, '^switch_[0-9]+h$')) %>%
  filter(switch_idx==1) %>%
  # mutate(lag=ifelse(lag<240*60, lag, 245*60),
         # lag=ifelse(is.na(lag), -10, lag)) %>% 
  ggplot(aes(x=growth_lag/60)) +
  stat_ecdf(aes(y=1-..y.., col=switch_idx), show.legend=FALSE) +
  geom_hline(yintercept = 0.99) +
  labs(x='time after the switch (min)', y='fraction of growth arrested cells') +
  coord_cartesian(xlim=c(0, 30), ylim=c(0.95, 1)) +
  NULL

```


## Decoupling growth-mediated dilution and induction

xxx intro


```{r eval=FALSE}
myrates_lactulose <- myframes %>% 
  ungroup %>% 
  filter(!discard_top) %>% 
  filter(str_detect(condition, 'TMG') | str_detect(condition, 'lactulose')) %>%
  # loop on all cells
  # group_by(condition, date, pos, gl, id, cell) %>%
  partition(condition, strain, date, pos, gl, id, cell,
            cluster=mycluster) %>%
  do( (function(.dfc, .rate_hw=3*360){
    .dfc %>% 
      group_by(time_sec) %>% 
      do((function(.p) {
        # browser()
        .df <- filter(.dfc, between(time_sec, .p[['time_sec']]-.rate_hw, .p[['time_sec']]+.rate_hw))
        .mod_ll <- fastLmPure( cbind(1, .df$time_sec), log(.df$length_um) )
        .mod_g_l <- fastLmPure( cbind(1, .df$length_um), .df$gfp_nb )
        data.frame(irate_npoints=.mod_ll$df.residual+1, igfp_nb=mean(.df$gfp_nb), 
                   islope_ll_time=.mod_ll$coefficients[2], islopesd_ll_time=.mod_ll$stderr[2],
                   ir2_ll_time=cor(.df$time_sec, log(.df$length_um), use="complete.obs")^2,
                   islope_g_l=.mod_g_l$coefficients[2], islopesd_g_l=.mod_g_l$stderr[2],
                   ir2_g_l=cor(.df$length_um, .df$gfp_nb, use="complete.obs")^2)
      })(.) )
  })(.) ) %>% 
  collect()

```


First let's look at some raw length traces, coloured using an arbitrary fluorescence concentration threshold (to visualise cells expressing LacZ-GFP at detectable levels). It reveals that some cells can grow on lactulose without TMG (and even sometimes express LacZ-GFP weakly); however, when exposed to lactulose and TMG cells express GFP and grow faster.

This constitutes a confounding effect since we need to distinguish the inducing effect of the TMG from the weak spontaneous induction observed in lactulose only.

```{r fig.height=12}
myframes %>% 
  ungroup() %>% 
  filter(time_sec > 2*3600, !discard_top) %>% 
  filter(str_detect(condition, 'TMG') | str_detect(condition, 'lactulose')) %>%
  group_by(date, pos, gl) %>% sample_n_groups(20) %>% 
  # filter(end_type == 'lost') %>% 
  ggplot(aes(time_sec - 2*3600, length_um, col=gfp_nb/length_um>250)) +
  facet_wrap(~ condition+date + pos+gl, dir="v", ncol=2,
             labeller=labeller(condition=as_labeller(rename_conds), .multi_line=FALSE)) +
  # geom_rect(aes(xmin=t_start - 2*3600, xmax=t_end - 2*3600, ymin=-Inf, ymax=Inf, x=NaN, y=NaN, group=1), fill=rgb(1, 0, 0, .1), col='red', data=filter(condition_ts, condition=='switch', medium=='lactose')) +
  geom_path(aes(group=ugen)) + # geom_point() +
  # scale_colour_periodic_brewer(guide='none') +
  # scale_alpha_discrete(range=c(0.1, 0.6)) +
  scale_x_hours() + #, limits=c(19*3600, 23*3600)) +
  scale_y_continuous(trans='log2') +
  labs(y='length (µm)', col='induced') +
  theme(legend.position="top")

```

```{r eval=FALSE}
myframes_switching %>% 
  filter(fit_lag) %>% 
  filter(str_detect(condition, 'TMG') | str_detect(condition, 'lactulose')) %>%
  filter(type=='cell') %>% 
  group_by(condition, date, ugen) %>% 
  slice(n()) %>% 
  ggplot(aes(time_sec - 2*3600, gfp_nb, col=end_type, alpha=type)) +
  facet_wrap(~condition+date, dir="v", ncol=2, labeller=labeller(.cols=label_value, .multi_line=FALSE)) +
  # geom_rect(aes(xmin=t_start - 2*3600, xmax=t_end - 2*3600, ymin=-Inf, ymax=Inf, x=NaN, y=NaN, group=1), fill=rgb(1, 0, 0, .1), col='red', data=filter(condition_ts, condition=='switch', medium=='lactose')) +
  geom_point() + # geom_point() +
  # scale_colour_periodic_brewer(guide='none') +
  scale_alpha_discrete(range=c(0.1, 0.6)) +
  scale_x_hours() + #, limits=c(19*3600, 23*3600)) +
  ylim(-100, 4e3) +   expand_limits(x=0, y=0) +
  labs(y='total fluorescence (GFP molecules)') +
  theme(legend.position="top") +
  NULL

```


By increasing the induction threshold (+1000 LacZ-GFP molecules instead of +200 by default; picked according to raw traces), it is possible to mesure induction lags specific for TMG in lactulose:


```{r}
mycells_switching %>% 
  filter(str_detect(condition, 'TMG') | str_detect(condition, 'lactulose'), 
         condition!='switch_glycerol_TMG20') %>% 
  mutate(lag=growth_lag,
         # mutate(lag=lag_200,
         lag=ifelse(!is.infinite(lag), lag, max(lag[is.finite(lag)])+60),
         lag=ifelse(is.na(lag), -1, lag)
  ) %>% 
  ggplot(aes(lag/60)) +
  facet_wrap(~condition, scales='free_y', labeller=as_labeller(rename_conds)) +
  geom_freqpoly(aes(col=condition, group=factor(date)), alpha=.8, position='identity', binwidth=18, show.legend=FALSE) +
  expand_limits(x=0) +
  scale_y_log10() +
  labs(x=lac_lags_label)

```

We focus on cells seen 7h after the switch (i.e. after all inducible cells have switched on. Three expression states can be distinguised in the distributions of LacZ-GFP concentration:

- uninduced (before the switch or with glycerol; <100 molecules / µm)
- weak spontaneous induction due to lactulose ()
- induction due to TMG in lactulose (>250 molecules/µm)


```{r}
myframes %>% 
  ungroup() %>% 
  filter(str_detect(condition, 'TMG') | str_detect(condition, 'lactulose')) %>%
  filter(!discard_top) %>% 
  filter(time_sec/3600==8+7) %>%
  mutate(condition=rename_conds(condition)) %>% 
  ggplot(aes(gfp_nb/length_um)) +
  geom_freqpoly(aes(y=..density.., col=condition, group=date), binwidth=50) +
  # coord_cartesian(xlim=c(-0.2, 1)) +
  labs(x='LacZ-GFP concentration (molecules/µm)', title='7h after the switch') +
  NULL

```

```{r}
myrates_lactulose %>% 
  ungroup() %>% 
  # filter(between(time_sec/3600, 14, 15.99)) %>% 
  # filter(between(time_sec/3600, 16, 18)) %>%
  filter(time_sec/3600==8+7) %>%
  # filter(irate_npoints>3, ir2_ll_time>0.8) %>% 
  left_join(myframes %>% select(condition, date, pos, gl, id, time_sec, length_um, gfp_nb)) %>% 
  ggplot(aes(islope_ll_time/log(2)*3600)) +
  facet_grid(condition~., labeller=as_labeller(rename_conds)) +
  geom_freqpoly(aes(y=..count.., col=gfp_nb/length_um>250), binwidth=.025) +
  coord_cartesian(xlim=c(-0.2, 1)) +
  labs(x='inst. growth rate (dbl/h)', col='induced') +
  NULL

# a1 <- rnorm(20)
# b1 <- ggplot2:::bin_breaks_width(range(a1), .1)
# ggplot2:::bin_vector(a1, b1)

myframes %>% 
  ungroup() %>% 
  filter(str_detect(condition, 'TMG') | str_detect(condition, 'lactulose')) %>%
  filter(!discard_top) %>% 
  filter(time_sec/3600==8+7) %>%
  group_by(condition) %>% 
  summarise(n=n(), n_induced=sum(gfp_nb/length_um>250), p_induced=n_induced/n)
  
```


```{r}

```


```{r eval=FALSE}
myframes %>% 
  ungroup() %>% 
  filter(between(time_sec/3600, 6, 15.99), !discard_top) %>% 
  filter(str_detect(condition, 'TMG') | str_detect(condition, 'lactulose')) %>%
  mutate(time_bin=cut(time_sec/3600-8, breaks=seq(-2,100,2), right=FALSE),
         condition=rename_conds(condition)) %>% 
  # filter(end_type == 'lost') %>% 
  ggplot(aes(gfp_nb/length_um, col=condition)) +
  facet_grid(time_bin~., labeller=labeller(.multi_line=FALSE)) +
  geom_freqpoly(aes(y=..density.., group=date), binwidth=20) +
  # geom_freqpoly(aes(group=date), binwidth=40) +
  # theme(legend.position="top") +
  scale_y_log10() +
  labs(x='LacZ-GFP concentration (molecules/µm)') +
  NULL

```

Since lactulose is not an inducer of the *lac* operon, the quantity of catabolic Lac enzymes is limiting growth at low TMG concentration. As a result, the instantaneous growth rate depends strongly on the LacZ-GFP concentration.
<!-- Importantly, for cells spontaneously inducing in lactulose, their instantaneous growth rate doesn't depend on the LacZ-GFP concentration while it does for cells exposed to TMG. This suggest that the weak induction comes from another mechanisms?!? xxx -->

NB: not all data is shown.

```{r}
myrates_lactulose %>% 
  ungroup() %>% 
  filter(condition!='switch_glycerol_TMG20') %>% 
  left_join(myframes) %>% 
  filter(between(time_sec/3600, 8+18/60, 15.99)) %>% 
  # filter(irate_npoints>3, ir2_ll_time>0.8) %>%
  group_by(condition) %>%
  mutate(gfp_conc_cut=Hmisc::cut2(gfp_nb/length_um, cuts=seq(-100, 2e4, 100), levels.mean=TRUE)) %>% 
  # summarise(n=n(), r2=cor(igfp_nb, islope_ll_time)^2)
  (function(.df)
    ggplot(.df, aes(gfp_nb/length_um, islope_ll_time/log(2)*3600, col=condition)) +
     facet_wrap(~condition, labeller=as_labeller(rename_conds)) +
     geom_point(alpha=.2, size=.2, data=sample_n(ungroup(.df), 5e3)) +
     stat_summary(aes(as.numeric(as.character(gfp_conc_cut))), fun.data=mean_se, geom="pointrange", col='black') +
     coord_cartesian(xlim=c(-50, 1500), ylim=c(-0.2, 1)) +
     guides(col='none') +
     labs(x='LacZ-GFP concentration (molecules/µm)', y='inst. growth rate (dbl/h)') +
     NULL
  )
   
```


```{r}
bind_rows(
  myframes %>% 
    ungroup() %>% 
    filter(str_detect(condition, 'TMG')) %>% 
    filter(!discard_top) %>% 
    filter(time_sec/3600==8+7) %>%
    group_by(condition) %>% 
    summarise(variable='induction',n_true=sum(gfp_nb/length_um>250), n=n(), 
              # p_induced=n_induced/n,
            ),
  tribble(
    ~variable, ~condition, ~n_true, ~n,
    'arrest', 'switch_glycerol_TMG20', 0, 110,
    'arrest', 'switch_lactulose_TMG20', 101, 105) 
) %>% 
  group_by(condition, variable) %>% 
  mutate(p_true=n_true/n, p_false=1-p_true, n=NULL) %>% 

# tribble(
#   ~variable, ~condition, ~n, ~n_not,
#   'arrest', 'gly', 0, 1,
#   'arrest', 'lacl', 0.95, 0.05,
#   'induction', 'gly', 0, 1,
#   'induction', 'lacl', 0.45, 0.55
# ) %>% 
# mutate(n_not=n_tot-n, n_tot=NULL) %>% 

  gather(type, value, p_true, p_false) %>% 
  ggplot() +
  facet_grid(variable~condition, labeller=as_labeller(rename_conds), switch='y') +
  geom_bar(aes(x=factor(1), value, fill=factor(type)), stat='identity') +
  geom_rect(aes(xmin=.55, xmax=1.45, ymin=pmin, ymax=pmax), fill='black', alpha=.4,
            data=data.frame(condition='switch_lactulose_TMG20', variable='induction', pmin=c(0, 0.9), pmax=c(0.05, 1))) +
  coord_polar(theta='y') +
  theme_void() +
  theme(legend.position='bottom', 
        strip.text.y=element_text(angle=180)) +
  NULL
 
```


