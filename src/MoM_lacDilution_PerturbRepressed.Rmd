---
title: "Perturbations of the repressed *lac* operon expression"
author: Thomas Julou
date: "`r format(Sys.time(), '%d %B, %Y')`"
---


## Perturbing LacI activity

hypothesized to explain how the positive feedback kicks off.
can be manipulated by titrating a given fraction of LacI with IPTG.

how to titrate LacI with IPTG?

```{r}
mycells_switching %>% ungroup() %>% 
  filter(!date %in% discarded_dates) %>%
  filter(!discard_arrested) %>% 
  filter(switch_idx==1) %>%
  filter(str_detect(condition, '^switch_[0-9]+h$') | 
           str_detect(condition, 'withIPTG5uM') |  str_detect(condition, 'lacIPTG5uM') | 
           str_detect(condition, 'preIPTG5uM') ) %>% 
  mutate(condition=fct_relabel(condition, function(.x) ifelse(str_detect(.x, '^switch_[0-9]+h$'), 'lactose', .x)),
         laci=factor(ifelse(condition=='lactose', 'control', 'lower')) %>% fct_relevel('lower', 'control') ) %>%
  mutate(lag=lag_200,
         lag=ifelse(!is.infinite(lag), lag, max(lag[is.finite(lag)])+60),
         lag=ifelse(is.na(lag), -200, lag)) %>% 
  ggplot(aes(x=condition, y=lag/60)) +
  geom_violin(aes(group=date, col=laci, fill=laci), adjust=0.7, 
              alpha=.4, position='identity') +
  geom_hline(yintercept=48, lty='dashed') +
  # ylim(0, 240) +
  scale_x_discrete(breaks=c('lactose', 'switch_withIPTG5uM', 'switch_lacIPTG5uM', 'switch_preIPTG5uM'), 
                   labels=c('glucose\n> lactose', 'glucose+IPTG\n> lactose+IPTG', 
                            'glucose\n> lactose+IPTG', 'glucose+IPTG\n> lactose') )+ 
  expand_limits(y=0) +
  labs(title='with [IPTG] = 5µM', y=lac_lags_label, col='LacI activity', fill='LacI activity') +
  theme(#axis.text.x=element_text(angle=45, hjust=1.25, vjust=1.1), 
        axis.text.x=element_text(size=rel(1), colour='black'),
        axis.title.x=element_blank(),
        legend.position='top') +
  NULL

```



```{r eval=FALSE}
mycells_switching %>% ungroup() %>% 
  filter(!date %in% discarded_dates) %>%
  filter(!discard_arrested) %>% 
  filter(switch_idx==1) %>%
  filter(str_detect(condition, '^switch_[0-9]+h$') | 
           str_detect(condition, 'withIPTG') |  str_detect(condition, 'lacIPTG') | 
           str_detect(condition, 'lacIoe$') | str_detect(condition, 'lacIoe_withIPTG')) %>% 
  mutate(condition=fct_relabel(condition, function(.x) ifelse(str_detect(.x, '^switch_[0-9]+h$'), 'lactose', .x)) ) %>%
  mutate(lag=lag_200,
         lag=ifelse(!is.infinite(lag), lag, max(lag[is.finite(lag)])+60),
         lag=ifelse(is.na(lag), -1, lag)) %>% 
  ggplot(aes(x=lag/60)) +
  stat_ecdf(aes(y=1-..y.., col=condition)) +
  labs(x=lac_lags_label, y='reverse cumulative probability', title='naive cells') +
  expand_limits(x=0) + 
  xlim(0, 240)

mycells_switching %>% ungroup() %>% 
  filter(!date %in% discarded_dates) %>%
  filter(!discard_arrested) %>% 
  filter(switch_idx==1) %>%
  filter(str_detect(condition, '^switch_[0-9]+h$') | condition=='switch_long_lac' | 
           str_detect(condition, 'withIPTG') |  str_detect(condition, 'lacIPTG') | 
           str_detect(condition, 'lacIoe$') | str_detect(condition, 'lacIoe_withIPTG')) %>% 
  mutate(condition=fct_relabel(condition, function(.x) ifelse(str_detect(.x, '^switch_[0-9]+h$'), 'lactose', .x)) ) %>%
  gather(variable, lag, growth_lag, gfp_lag, lag_200, factor_key=TRUE) %>% 
  mutate(lag=ifelse(!is.infinite(lag), lag, max(lag[is.finite(lag)])+60),
         lag=ifelse(is.na(lag), -200, lag)) %>% 
  ggplot(aes(x=condition, y=lag/60)) +
  facet_grid(variable~.) +
  geom_violin(aes(group=date, fill=condition), col='transparent', alpha=.4, position='identity') +
  geom_hline(yintercept=48, lty='dashed') +
  labs(y=lac_lags_label) +
  ylim(0, 240)

```


```{r}
mycells_switching %>% ungroup() %>% 
  filter(!date %in% discarded_dates) %>%
  filter(!discard_arrested) %>% 
  filter(switch_idx==1) %>%
  filter(str_detect(condition, '^switch_[0-9]+h$') |
           str_detect(condition, 'preIPTG') | str_detect(condition, 'lacIoe$')) %>% 
  mutate(condition=fct_relabel(condition, function(.x) ifelse(str_detect(.x, '^switch_[0-9]+h$'), 'control', .x)),
         laci=fct_recode(condition, 'lower'='switch_preIPTG5uM',
                         'higher'='switch_lacIoe', 'higher'='switch_lacIoe_preIPTG10uM') %>% 
           fct_relevel('lower', 'control'),
         condition=fct_relevel(condition, 'switch_lacIoe', 'switch_lacIoe_preIPTG10uM', 
                               "control", 'switch_preIPTG5uM') %>% 
           fct_recode('with 5µM IPTG'='switch_preIPTG5uM',
                      'with LacI plasmid'='switch_lacIoe', 
                      'with LacI plasmid\n+ 10µM IPTG'='switch_lacIoe_preIPTG10uM') ) %>% 
  mutate(lag=lag_200,
         lag=ifelse(lag>240*60, Inf, lag)
  #        lag=ifelse(!is.infinite(lag), lag, max(lag[is.finite(lag)])+60),
  #        lag=ifelse(is.na(lag), -200, lag)
  ) %>% 
  ggplot(aes(x=condition, y=lag/60)) +
  geom_hline(yintercept=48, lty='dashed') +
  geom_violin(aes(group=date, fill=laci, col=laci), alpha=.4, position='identity') +
  labs(y=lac_lags_label, col='LacI activity', fill='LacI activity') +
  # expand_limits(y=0) + 
  theme(axis.title.x=element_blank(),
        # axis.text.x=element_text(angle=45, hjust=0.8, vjust=0.9), 
        axis.text.x=element_text(size=rel(1), colour='black'),
        legend.position='top') +
  NULL

```


A similar picture is obtained when IPTG Is added before and after the switch:

```{r}
mycells_switching %>% ungroup() %>% 
  filter(!date %in% discarded_dates) %>%
  filter(!discard_arrested) %>% 
  filter(switch_idx==1) %>%
  filter(str_detect(condition, '^switch_[0-9]+h$') |
           str_detect(condition, 'withIPTG') | str_detect(condition, 'lacIoe$')) %>% 
  mutate(condition=fct_relabel(condition, function(.x) ifelse(str_detect(.x, '^switch_[0-9]+h$'), 'control', .x)),
         laci=fct_recode(condition, 'lower'='switch_withIPTG5uM', 'lower'='switch_withIPTG1uM',
                         'higher'='switch_lacIoe', 'higher'='switch_lacIoe_withIPTG10uM') %>% 
           fct_relevel('lower', 'control'),
         condition=fct_relevel(condition, 'switch_lacIoe', 'switch_lacIoe_withIPTG10uM', 
                               "control", 'switch_withIPTG1uM', 'switch_withIPTG5uM') %>% 
           fct_recode('with 5µM IPTG'='switch_withIPTG5uM', 'with 1µM IPTG'='switch_withIPTG1uM',
                      'with LacI plasmid'='switch_lacIoe', 
                      'with LacI plasmid\n+ 10µM IPTG'='switch_lacIoe_withIPTG10uM') ) %>% 
  mutate(lag=lag_200,
         lag=ifelse(lag>240*60, Inf, lag)
  #        lag=ifelse(!is.infinite(lag), lag, max(lag[is.finite(lag)])+60),
  #        lag=ifelse(is.na(lag), -200, lag)
  ) %>% 
  ggplot(aes(x=condition, y=lag/60)) +
  geom_hline(yintercept=48, lty='dashed') +
  geom_violin(aes(group=date, fill=laci, col=laci), alpha=.4, position='identity') +
  labs(y=lac_lags_label, col='LacI activity', fill='LacI activity') +
  # expand_limits(y=0) + 
  theme(axis.title.x=element_blank(),
        # axis.text.x=element_text(angle=45, hjust=0.8, vjust=0.9), 
        axis.text.x=element_text(size=rel(1), colour='black'),
        legend.position='top') +
  NULL

```


Let's check that the *lac* promoter is not induced before the switch:

```{r}
mycells_switching %>% ungroup() %>% 
  filter(!date %in% discarded_dates) %>%
  filter(!discard_arrested) %>% 
  filter(switch_idx==1) %>%
  filter(str_detect(condition, '^switch_[0-9]+h$') | str_detect(condition, 'preIPTG') ) %>% 
  mutate(condition=fct_relabel(condition, function(.x) ifelse(str_detect(.x, '^switch_[0-9]+h$'), 'control', .x)),
         laci=fct_recode(condition, 'lower'='switch_preIPTG5uM', 'higher'='switch_lacIoe_preIPTG10uM') %>% 
           fct_relevel('lower', 'control'),
         condition=fct_relevel(condition, 'switch_lacIoe', 'switch_lacIoe_preIPTG10uM', 
                               "control", 'switch_preIPTG5uM') %>% 
           fct_recode('with 5µM IPTG'='switch_preIPTG5uM', 'no IPTG'='control',
                      'with LacI plasmid\n+ 10µM IPTG'='switch_lacIoe_preIPTG10uM') ) %>% 
  mutate(lag=lag_200,
         lag=ifelse(!is.infinite(lag), lag, max(lag[is.finite(lag)])+60),
         lag=ifelse(is.na(lag), -200, lag)) %>% 
  ggplot(aes(condition, gfp_ini)) +
  geom_violin(aes(group=date, col=laci, fill=laci), alpha=.4, position='identity') +
  labs(x='', y='LacZ-GFP at the switch (molecules / cell)', col='LacI activity', fill='LacI activity') +
  theme(axis.title.x=element_blank(),
        # axis.text.x=element_text(angle=20, hjust=0.8, vjust=0.9), 
        axis.text.x=element_text(size=rel(1), colour='black'),
        legend.position='top') +
  NULL

```


## Perturbing repressed expression with different media

```{r eval=FALSE}
mycells_switching %>% ungroup %>% 
  filter(! date %in% discarded_dates) %>% 
  filter(!discard_arrested) %>%
  filter(switch_idx==1) %>% 
  filter(str_detect(condition, '^switch_[0-9]+h$') | condition %in% c('switch_glcLac_lac') ) %>%
  mutate(lag=lag_200, 
         lag=ifelse(is.na(lag), -10, lag) ) %>% 
  mutate(condition=fct_relabel(condition, function(.x) ifelse(str_detect(.x, '^switch_[0-9]+h$'), 'control', .x)),
         condition=fct_recode(factor(condition), 'glucose + lactose > lactose'='switch_glcLac_lac',
                              'glucose > lactose (control)'='control') ) %>%
  ggplot(aes(lag/60, ..density..)) +
  geom_freqpoly(aes(col=condition), binwidth=6) +
  coord_cartesian(xlim=c(0, 240)) +
  labs(x=lac_lags_label, title='naive cells')

mycells_switching %>% ungroup %>% 
  filter(! date %in% discarded_dates) %>% 
  # filter(!discard_arrested) %>%
  filter(switch_idx==1) %>% 
  filter(str_detect(condition, '^switch_[0-9]+h$') | condition=='switch_gly_lac' ) %>%
  mutate(lag=lag_200, 
         lag=ifelse(is.na(lag), -1, lag) ) %>% 
  mutate(condition=fct_relabel(condition, function(.x) ifelse(str_detect(.x, '^switch_[0-9]+h$'), 'control', .x)),
         condition=fct_recode(factor(condition), 'glycerol > lactose'='switch_gly_lac',
                              'glucose > lactose (control)'='control') ) %>%
  ggplot(aes(lag/60, ..density..)) +
  geom_freqpoly(aes(col=condition), binwidth=6) +
  coord_cartesian(xlim=c(0, 240)) +
  labs(x=lac_lags_label, title='naive cells')

```

```{r}
mycells_switching %>% ungroup %>% 
  filter(! date %in% discarded_dates) %>% 
  # filter(!discard_arrested) %>%
  filter(switch_idx==1) %>% 
  filter(str_detect(condition, '^switch_[0-9]+h$') | condition %in% c('switch_glcLac_lac', 'switch_gly_lac') ) %>%
  mutate(lag=lag_200, 
         lag=ifelse(is.na(lag), -1000, lag) ) %>% 
  mutate(condition=fct_relabel(condition, function(.x) ifelse(str_detect(.x, '^switch_[0-9]+h$'), 'control', .x)),
         condition=fct_recode(factor(condition), 'glucose + lactose > lactose'='switch_glcLac_lac',
                              'glycerol > lactose'='switch_gly_lac',
                              'glucose > lactose (control)'='control') ) %>%
  ggplot(aes(lag/60, ..density..)) +
  geom_freqpoly(aes(col=condition), binwidth=6) +
  coord_cartesian(xlim=c(0, 240)) +
  labs(x=lac_lags_label, title='naive cells')


```

```{r}
# mycells_switching %>% ungroup %>% 
#   filter(! date %in% discarded_dates) %>% 
#   # filter(!discard_arrested) %>%
#   filter(switch_idx==1) %>% 
#   filter(str_detect(condition, '^switch_[0-9]+h$') | condition %in% c('switch_glcLac_lac', 'switch_gly_lac') ) %>%
#   mutate(lag=lag_200) %>% 
#   mutate(condition=fct_relabel(condition, function(.x) ifelse(str_detect(.x, '^switch_[0-9]+h$'), 'control', .x)),
#          condition=fct_recode(factor(condition), 'glucose + lactose > lactose'='switch_glcLac_lac',
#                               'glycerol > lactose'='switch_gly_lac',
#                               'glucose > lactose (control)'='control') ) %>%
#   group_by(condition) %>% 
#   summarise(n=n(), p_short=sum(lag/60<48, na.rm=TRUE)/sum(!is.na(lag)), p_short_se=sqrt(p_short*(1-p_short)/n)) %>% 
#   ggplot(aes(x=condition, y=p_short)) +
#   geom_bar(stat='identity') +
#   geom_errorbar(aes(ymin=p_short-p_short_se, ymax=p_short+p_short_se), width=.4) +
#   geom_text(aes(y=0.65, label=sprintf('n=%d', n)), vjust=1.1) +
#   # coord_cartesian(xlim=c(0, 240)) +
#   labs(y='fraction of short lags') +
#   theme(axis.text.x=element_text(size=rel(1), colour='black'), axis.title.x=element_blank()) +
#   NULL

mycells_switching %>% ungroup %>% 
  filter(! date %in% discarded_dates) %>% 
  # filter(!discard_arrested) %>%
  filter(switch_idx==1) %>% 
  filter(str_detect(condition, '^switch_[0-9]+h$') | condition %in% c('switch_glcLac_lac', 'switch_gly_lac') ) %>%
  mutate(lag=lag_200) %>% 
  mutate(condition=fct_relabel(condition, function(.x) ifelse(str_detect(.x, '^switch_[0-9]+h$'), 'control', .x)),
         condition=fct_recode(factor(condition), 'glucose + lactose > lactose'='switch_glcLac_lac',
                              'glycerol > lactose'='switch_gly_lac',
                              'glucose > lactose (control)'='control') ) %>%
  group_by(condition) %>% 
  summarise(n=n(), type='short', prop=sum(lag/60<48, na.rm=TRUE)/sum(!is.na(lag)), 
            prop_se=sqrt(prop*(1-prop)/n)) %>% 
  (function(.df) 
    bind_rows(.df, .df %>% mutate(type='long', prop=1-prop, prop_se=NA, n=NA)) %>% 
     ggplot(aes(x=condition, y=prop)) +
     geom_bar(aes(fill=type), stat='identity') +
     geom_rect(aes(xmin=as.numeric(condition)-.45, xmax=as.numeric(condition)+.45, 
                   ymin=prop-prop_se, ymax=prop+prop_se), data=.df) +
     geom_text(aes(y=0, label=sprintf('n=%d', n)), vjust=-0.3, data=.df) +
     # coord_cartesian(xlim=c(0, 240)) +
     labs(y='proportion', fill=expression(paste("type of ", italic("lac"), " induction lag")) ) +
     theme(axis.text.x=element_text(size=rel(1), colour='black'), 
           axis.title.x=element_blank(),
           legend.position='top') +
     NULL
  )

```

NB: 2 independent replicates per condition
