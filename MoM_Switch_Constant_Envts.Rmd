---
title: "Constant environments"
author: Thomas Julou
date: "`r format(Sys.time(), '%d %B, %Y')`"
---

## Growth in constant environments

```{r}
myframes <- myframes %>% 
  # group_by(date, pos, gl, id) %>% 
  partition(date, pos, gl, id, cluster=mycluster) %>%
  do((function(.df){
    .n <- dim(.df)[1]
    .cell_cycle <- NA
    if (!any(.df$discard_start) && unique(.df$end_type)=='div')
      .cell_cycle <- ((1:.n)-.5) / .n
    .logl <- NA
    if (unique(.df$condition) %in% c('glucose', 'lactose')  &&  .n > 4) {
      .mod_ll_t <- lm( log(length_um)~time_sec, .df)  # use lm() for predict with se
      .pred_ll <- predict(.mod_ll_t, se.fit=TRUE)
      .logl <- .pred_ll$fit
    }
    mutate(.df, cell_cycle=.cell_cycle, length_predict=exp(.logl),
          gfp_deriv=(gfp_nb-lag(gfp_nb))/(time_sec-lag(time_sec)))
  })(.)) %>% 
  collect()

```


Let's compute stats over the cell cycle for each cell:

```{r}
mycells <- filter(myframes, condition %in% c('glucose', 'lactose', 'lactose_lowillum'), !discard_top) %>%
  # group_by(condition, date, pos, gl, id, cell, parent_id, genealogy) %>%
  partition(condition, date, pos, gl, id, cell, parent_id, genealogy, cluster=mycluster) %>%
  filter(!any(discard_start), end_type=='div') %>% # full cell cycles only
  filter(n()>4) %>% # at least 4 time points
  do((function(.df) {
    # browser()
    
    .mod_ll_t <- lm( log(length_um)~time_sec, .df)  # use fastLm() for predict
    # .mod_ll_t <- fastLmPure( cbind(1, .df$time_sec), log(.df$length_um) )
    .mod_lg_t <- fastLmPure( cbind(1, .df$time_sec), log(.df$gfp_nb) )
    .mod_l_t <- fastLmPure( cbind(1, .df$time_sec), .df$length_um )
    .mod_g_t <- fastLmPure( cbind(1, .df$time_sec), .df$gfp_nb )
    .mod_g_l <- fastLmPure( cbind(1, .df$length_um), .df$gfp_nb )

    .time_birth <- first(.df$time_sec)
    .time_div <- last(.df$time_sec)
    .logl <- predict(.mod_ll_t, se.fit=TRUE)
    data.frame(npoints=.mod_ll_t$df.residual+1,
               time_birth=.time_birth, time_div=.time_div, 
               cell_num_from_top=mean(.df$cell_num_in_lane),
               cell_num_from_bottom=mean(.df$total_cell_in_lane-.df$cell_num_in_lane), 
               loglength_start=first(.logl$fit), loglength_startse=first(.logl$se.fit), 
               loglength_end=last(.logl$fit), loglength_endse=last(.logl$se.fit), 
               logl_time_slope=.mod_ll_t$coefficients[2], logl_time_slopesd=summary(.mod_ll_t)$coefficients[2,2], 
               # logl_time_slope=.mod_ll_t$coefficients[2], logl_time_slopesd=.mod_ll_t$stderr[2], 
               logl_time_r2=cor(.df$time_sec, log(.df$length_um))^2,
               logg_time_slope=.mod_lg_t$coefficients[2], logg_time_slopesd=.mod_lg_t$stderr[2], 
               logg_time_r2=cor(.df$time_sec, log(.df$gfp_nb))^2,
               l_time_slope=.mod_l_t$coefficients[2], l_time_slopesd=.mod_l_t$stderr[2], 
               l_time_r2=cor(.df$time_sec, .df$length_um)^2,
               g_first=first(.df$gfp_nb), g_last=last(.df$gfp_nb),
               g_time_slope=.mod_g_t$coefficients[2], g_time_slopesd=.mod_g_t$stderr[2], 
               g_time_r2=cor(.df$time_sec, .df$gfp_nb)^2,
               g_l_slope=.mod_g_l$coefficients[2], g_l_slopesd=.mod_g_l$stderr[2], 
               g_l_r2=cor(.df$length_um, log(.df$gfp_nb))^2)
  })(.) ) %>% 
  collect() %>% 
  arrange(condition, date, pos, gl, id) %>% 
  mutate(gl_id=gsub('\\.[0-9]+$', '', cell))


```

Print an example of what cell traces look like and r2 CDF to show that elongation is more exponential than linear:

```{r}
ggplot(filter(myframes, !discard_start, !discard_top, condition=='glucose', end_type=='div', start_time>=2*3600) %>% ungroup %>%  filter(cell %in% cell[c(1, 100, 30, 300, 400)]),
       aes((time_sec-start_time)/60, length_um, col=cell)) +
  stat_smooth(method='lm', se=FALSE) +
  geom_path(alpha=0.8, size=1) +
  scale_colour_periodic_brewer(guide='none') +
  scale_x_continuous(breaks=seq(0, 80, 40)) +
  scale_y_continuous(trans='log2', breaks=2:4) +
  expand_limits(y=4) +
  labs(x='time after division (min)', y='length (µm)')
ggsave('plots/asc_loglength_time.pdf', width=2.5, height=3)

ggplot(mycells %>% filter(condition %in% c('glucose', 'lactose')) ) +
  stat_ecdf(aes(logl_time_r2, col=condition, lty='exponential')) +
  stat_ecdf(aes(l_time_r2, col=condition, lty='linear')) +
  labs(x='Pearson correlation r2', y='cumulative probability', lty='fit') +
  xlim(0.94, 1) +
  theme(legend.justification=c(0, 1), legend.position=c(0, 1))
ggsave('plots/asc_loglength_time_r2ecdf.pdf', width=3, height=3)


```


Neither the cell length nor the doubling time increases during experiments in constant conditions, indicating limited photodamage and physiological aging.

```{r}
ggplot(myframes %>% filter(condition %in% c('glucose', 'lactose')) %>% 
         filter(!discard_start, !discard_top, end_type=='div', start_time>=2*3600) %>%
         sample_frac(.1, replace=FALSE), 
       aes(time_sec - 2*3600, length_um, col=condition)) +
  facet_grid(condition~.) +
  # stat_density2d()
  geom_point(alpha=.1) +
  scale_x_hours()
# geom_point(aes(time_sec, length_um), alpha=0.1)

ggplot(filter(myframes, condition %in% c('glucose', 'lactose'), !discard_top), 
       aes(time_sec, length_um, col=condition)) +
  geom_smooth()

```



```{r}
# table(mycells %>% filter(condition %in% c('glucose', 'lactose'))$Rsize_vs_time^2>.95)
mycells %>% filter(condition %in% c('glucose', 'lactose'), logl_time_r2>.95) %>% 
  ( function(.df)
    ggplot(.df, aes(time_div - 2*3600, log(2)/logl_time_slope / 60, col=condition)) +
      geom_point(alpha=0.2, size=1) +
      # stat_smooth(method='loess', span=.7, se=FALSE, size=1) +
      stat_smooth(method='lm', size=1,
                  data=filter(.df, time_birth > 5*3600)) +
      scale_x_hours(6, name='time at division (h)') +
      labs(y='doubling time (min)') +
      expand_limits(x=c(0, 24*3600), y=0) +
      theme(legend.justification=c(0, 1), legend.position=c(0, 1)) )
ggsave('plots/asc_dt_divtime.pdf', width=6, height=3)

```


Let's look at the distribution of doubling times.

```{r}
ggplot(mycells %>% filter(condition %in% c('glucose', 'lactose')), 
       # %>% filter(Rsize_vs_time^2>.98),
       aes(log(2)/logl_time_slope / 60)) +
  stat_bin(aes(y=..density.., fill=condition), geom='bar', position='identity', col='transparent', alpha=.2) + 
  geom_step_hist(aes(y=..density.., col=condition), position='identity') +
    # stat_ecdf() +
  xlim(0, 300) +
  labs(x='doubling time (min)') +
  theme(legend.justification=c(0, 1), legend.position=c(0, 1))
ggsave('plots/asc_dt.pdf', width=5.5, height=2)

```

NB: the decrease is the quality of the elongation fit is only moderate for cells with long doubling time (for dt>100, r2 <= 5% for r2 propto dt)
 
```{r eval=FALSE}
ggplot(mycells %>% filter(condition %in% c('glucose', 'lactose')),
       aes(log(2)/logl_time_slope / 60, logl_time_r2, col=condition)) +
  facet_wrap(~condition) +
  geom_point(alpha=.2) +
  geom_smooth(method='lm') +
  # stat_density2d() +
  labs(x='doubling time (min)') +
  xlim(50, 200) + ylim(0.95, 1)

mycells %>% filter(condition %in% c('glucose', 'lactose')) %>% 
  group_by(condition) %>% 
  mutate(dt=log(2)/logl_time_slope / 60 ) %>% 
  filter(dt > 100) %>% 
  do((function(.df){
    .mod <- fastLmPure( cbind(1, .df$dt), .df$logl_time_r2 )
    data.frame(slope=.mod$coefficients[2],
            r2=cor(.df$dt, .df$logl_time_r2)^2)
    })(.)) %>% kable

```


Let's check that cells with long doubling time are not filamentous: the slowest 10% in each condition have a similar length but they tend to be slightly longer. 

```{r}
l_end <- select(mycells, date, pos, gl, id, time_sec=time_div) %>%
  left_join(select(myframes, date, pos, gl, id, time_sec, length_um)) %>%
  rename(length_um_end=length_um)
mycells <- left_join(mycells, l_end %>% select(-time_sec)) %>% ungroup

mycells %>% filter(condition %in% c('glucose', 'lactose')) %>% 
  group_by(condition) %>% 
  mutate(dt=log(2)/logl_time_slope / 60,
         is_long_dt= dt>quantile(dt, 0.9)) %>% 
  ( function(.df)
    ggplot(.df, aes(length_um_end, ..density.., col=condition)) +
      facet_wrap(~condition) +
      geom_step_hist(aes(linetype='all'), position='identity') +
      geom_step_hist(aes(linetype='long dt (10%)'), position='identity', 
                     data=filter(.df, is_long_dt)) +
      labs(linetype='subset') )

```

```{r eval=FALSE}
ggplot(mycells %>% filter(condition %in% c('glucose', 'lactose')), 
       aes(length_um_end, log(2)/logl_time_slope / 60, col=condition)) +
  facet_wrap(~condition) +
  geom_point(alpha=0.2)

mycells %>% filter(condition %in% c('glucose', 'lactose')) %>% 
  group_by(condition) %>% 
  mutate(dt=log(2)/logl_time_slope / 60,
         is_long_dt= dt>quantile(dt, 0.9)) %>% 
  filter(is_long_dt) %>% 
  do((function(.df){
    .mod <- fastLmPure( cbind(1, .df$length_um_end), .df$dt )
    data.frame(slope=.mod$coefficients[2],
            r2=cor(.df$length_um_end, .df$dt)^2)
    })(.)) %>% kable

```


### Residuals over the cell cycle

```{r}
ggplot(myframes %>% filter(!discard_top, !discard_start, condition %in% c('glucose', 'lactose')),
       aes((time_sec-start_time)/60, length_um-length_predict)) +
  facet_wrap(~condition) +
  geom_hline(yintercept=0, col='red') +
  # geom_path(aes(col=interaction(date, pos), group=cell), size=.5, alpha=.1) +
  stat_summary(fun.data=mean_sdl, geom="pointrange") +
  xlim(0, 200)

```


### Growth rate inheritance 

Is there a genealogical signal on growth rate in constant environment?
NB: Growth rate is show in doubling time units…

```{r}
mypairs_constant <- mycells %>% filter(condition %in% c('glucose', 'lactose')) %>% 
  # group_by(gl_id) %>% 
  partition(gl_id, cluster=mycluster %>% cluster_assign_func(genealogy_relationship) %>% cluster_assign_func(genealogy_ontology)) %>% 
  do((function(.df) {
    # browser()
    if (dim(.df)[1]<2) 
      return(data.frame())
    return( combn(.df$genealogy, 2, simplify=FALSE) %>% 
      lapply(function(.x) as.data.frame(genealogy_relationship(.x), stringsAsFactors=FALSE)) %>% 
      do.call(rbind, .) )
  })(.)) %>% 
  collect() %>% 
  # mutate(rel=factor(rel, levels=c("sisters", "cousins1", "cousins2", "niece"))) %>% 
  left_join(mycells %>% ungroup %>% 
              setNames(., paste(names(.), "1", sep="_")) %>% rename(gl_id=gl_id_1) ) %>% 
  left_join(mycells %>% ungroup %>% 
              setNames(., paste(names(.), "2", sep="_")) %>% rename(gl_id=gl_id_2) ) %>% 
  # compute "ordered" doubling times
  group_by(div_min, div_max) %>% 
  mutate(
    dt_upstream = ifelse(div_1<div_2, log(2)/logl_time_slope_1 / 60, log(2)/logl_time_slope_2 / 60),
    dt_downstream = ifelse(div_1<div_2, log(2)/logl_time_slope_2 / 60, log(2)/logl_time_slope_1 / 60),
    dt_upstream2 = mycut(dt_upstream, seq(0, 1000, 10)))


ggplot(filter(mypairs_constant, TRUE), aes(log(2)/logl_time_slope_1 / 60, log(2)/logl_time_slope_2 / 60, col=factor(rel))) +
  geom_point(alpha=.5, size=.5) +
  expand_limits(x=0, y=0)


filter(mypairs_constant, TRUE) %>% 
  group_by(div_min, div_max) %>% 
  summarise(r2=cor(log(2)/logl_time_slope_1 / 60,  log(2)/logl_time_slope_2 / 60, use="complete.obs", method="pearson")^2, n=n()) %>% 
  mutate(rel=(Vectorize(genealogy_ontology))(div_min, div_max)) %>% 
  (function(.df) ggplot(.df, aes(div_min, div_max)) +
     # facet_grid(.~switch_idx) +
     geom_tile(aes(fill=r2), stat='identity', show.legend=FALSE) +
     geom_text(aes(label=sprintf("%s\nr2 = %.3f", rel, r2))) +
     geom_text(aes(y=div_max-.4, label=sprintf("(n = %d)", n))) +
     scale_fill_gradient(high='red', low='lightblue') +
     scale_x_continuous(breaks=0:10, expand=c(0,0)) + scale_y_continuous(trans="reverse", breaks=0:10, expand=c(0,0)) +
     expand_limits(fill=0) + coord_fixed() +
     labs(x='divs since common ancestor (cell 1)', y='div since common ancestor (cell 2)')
  )

```

Let's look at the corresponding distributions:

```{r}
ggplot(mypairs_constant, aes(dt_upstream, dt_downstream)) +
  facet_grid(div_max~div_min) +
  geom_point(size=.2, alpha=.1) +
  # geom_smooth(col=brewer_cols[1]) +
  stat_summary(aes(x=dt_upstream2), fun.data=mean_sdl, geom="pointrange", col=brewer_cols[1]) +
  xlim(0, 200) + ylim(0, 200)


```


## Fluo in lactose

Plot an example of GFP traces:

```{r}
(function() {
  .df <- filter(myframes, date=='20150624', pos==0, gl==4)
  # .df <- filter(myframes, date=='20150703', pos==3, gl==1)
  .df_div <- filter(.df, !discard_top, !discard_start) %>% 
    group_by(id) %>% 
    do((function(.dfgl, .dfc) { # compute_div_between_facets
        # .dfgl: dataframe of the entire GL
        # .dfc: dataframe of the current cell
        if (unique(.dfc$parent_id) < 0) return(data.frame())
        .dfp <- filter(.dfgl, id==unique(.dfc$parent_id))
        
        if (unique(.dfc$b_rank) == unique(.dfp$b_rank)) {
          .length_ump <- filter(.dfp, time_sec==max(time_sec))$length_um
          .gfp_nbp <- filter(.dfp, time_sec==max(time_sec))$gfp_nb
          .out <- filter(.dfc, time_sec==min(time_sec)) %>%
            select(id, b_rank, time_sec, length_um, gfp_nb) %>%
            mutate(time_secp=time_sec-dt*60, length_ump=.length_ump, gfp_nbp=.gfp_nbp)
        }
        if (unique(.dfc$b_rank) > unique(.dfp$b_rank)) {
          .out <- bind_rows(
            filter(ungroup(.dfc), time_sec==min(time_sec)) %>%
              select(id, b_rank, time_sec, length_um, gfp_nb) %>%
              mutate(time_secp=time_sec-dt*60/2, length_ump=0, gfp_nbp=-Inf),
            filter(ungroup(.dfp), time_sec==max(time_sec)) %>%
              select(id, b_rank, time_sec, length_um, gfp_nb) %>%
              mutate(id=unique(.dfc$id), time_secp=time_sec+dt*60/2, length_ump=Inf, gfp_nbp=Inf) )
          if(diff(.out$b_rank) < -1) {
            .out <- rbind(.out,
                          data.frame(id=unique(.dfc$id), b_rank=(min(.out$b_rank)+1):(max(.out$b_rank)-1),
                                     time_sec=min(.dfc$time_sec)-dt*60/2, time_secp=min(.dfc$time_sec)-dt*60/2,
                                     length_um=0, length_ump=Inf, gfp_nb=-Inf, gfp_nbp=Inf))
          }
        }
        return(.out)
      })(.df, .))
  
  ggplot() +
    facet_grid(b_rank~., as.table=FALSE) +
    # facets alternated background
    geom_rect(aes(xmin=-Inf, xmax=Inf, ymin=-Inf, ymax=Inf), alpha=.05, data=data.frame(b_rank=seq(0, 3, 2))) +
    # show divisions (lty='11' means densely dotted line using hex notation)
    geom_segment(aes(x=time_sec - 2*3600, xend=time_secp - 2*3600, y=gfp_nb, yend=gfp_nbp), col='darkgreen', alpha=.3, lty='11', data=filter(.df_div, b_rank<4) %>% filter(!(b_rank==3 & gfp_nbp==Inf))) + 
    # show cell traces
    geom_path(aes(time_sec - 2*3600, gfp_nb, group=id), col='darkgreen', data=filter(.df, !discard_top, !discard_start, b_rank<4)) +
    scale_x_hours(4) +
    scale_y_continuous(breaks=c(0, 5000, 10000)) +
    expand_limits(y=0) +
    labs(y='total GFP per cell (molecules)') +
    theme(panel.margin = unit(0, "lines"), panel.border=element_blank(),
          strip.background = element_blank(), strip.text = element_blank())
})()
# ggsave('plots/asc_gfp_time.pdf', width=8, height=5)

```

In this case, r2 CDFs don't help concluding whether the GFP increase over the cell cycle is more exponential (null model assuming concentration homeostasis) or linear:

```{r}
ggplot(mycells %>% filter(condition %in% 'lactose') ) +
  stat_ecdf(aes(logg_time_r2, col='fluo', lty='exponential')) +
  stat_ecdf(aes(g_time_r2, col='fluo', lty='linear')) +
  stat_ecdf(aes(logl_time_r2, col='length', lty='exponential')) +
  stat_ecdf(aes(l_time_r2, col='length', lty='linear')) +
  labs(x='Pearson correlation r2', y='cumulative probability', lty='fit', col='variable') +
  xlim(0.74, 1) +
  theme(legend.justification=c(0, 1), legend.position=c(0, 1))

```


```{r eval=FALSE}
ggplot(mycells %>% filter(condition %in% 'lactose'),
       aes(l_time_r2, logl_time_r2) ) +
  geom_point(size=.5, alpha=.5) +
  geom_abline(col='red') +
  xlim(0.94, 1) + ylim(0.94, 1)

```

Surprisingly, most cells are described as accurately by a linear or an exponential fit (with r2>0.97). For cells which cannot be captured by such a model (r2<0.95), it looks like that the fit is either exponential or linear (but not equally good):

```{r}
ggplot(mycells %>% filter(condition %in% 'lactose'),
       aes(g_time_r2, logg_time_r2) ) +
  geom_point(size=.5, alpha=.5) +
  geom_abline(col='red') +
  # xlim(0.94, 1) + ylim(0.94, 1) +
  xlim(0.84, 1) + ylim(0.84, 1) +
  coord_equal()
  # labs(x='Pearson correlation r2', y='cumulative probability', lty='fit') +
  # theme(legend.justification=c(0, 1), legend.position=c(0, 1))

ggplot(mycells %>% filter(condition %in% 'lactose'),
       aes(1-g_time_r2, 1-logg_time_r2)) +
  geom_point(size=.5, alpha=.5) +
  # stat_density2d() +
  geom_abline(col='red') +
  scale_x_log10() + scale_y_log10() +
  coord_equal()

```

This suggests that it's simply not relevant to try to describe the GFP increase with such a model (and hence to compare increase rates over the entire cell cycle). 


### Regression to the mean between consecutive divisions

For total GFP, there is no dependance of the GFP increase to the initial GFP (r2=`r with(mycells %>% filter(condition %in% 'lactose'), corPearson(g_first, g_last-g_first))^2`). Nonetheless, the initial / final GFP concentration scatter has a slope < 1, due to a "regression to the mean dynamics, i.e. if a cell starts high, it's likely to divide high but less than at birth).

```{r}
ggplot(mycells %>% filter(condition %in% 'lactose'),
       aes(g_first, g_last-g_first)) +
  geom_point(size=.5, alpha=.5) +
  geom_abline(col='red') +
  expand_limits(x=0, y=0) +
  labs(x='initial total GFP', y='added total GFP')

with(mycells %>% filter(condition %in% 'lactose'),
     corPearson(g_first, g_last-g_first))^2

ggplot(mycells %>% filter(condition %in% 'lactose'),
       aes(g_first/exp(loglength_start), g_last/exp(loglength_end) )) +
  geom_point(size=.5, alpha=.5) +
  stat_smooth(method=lm) +
  geom_abline(col='red') +
  expand_limits(x=0, y=0) +
  labs(x='initial GFP concentration', y='final GFP concentration')

with(mycells %>% filter(condition %in% 'lactose'),
     corPearson(g_first/exp(loglength_start), g_last/exp(loglength_end) ))^2


```

Moreover, the GFP added per unit length is independent of the initial GFP concentration:

```{r}
ggplot(mycells %>% filter(condition %in% 'lactose'),
       aes(g_first/exp(loglength_start), (g_last-g_first) / (exp(loglength_end)-exp(loglength_start)))) +
  geom_point(size=.5, alpha=.5) +
  geom_abline(col='red') +
  expand_limits(x=0, y=0) +
  labs(x='initial GFP concentration', y='added GFP / added length')

with(mycells %>% filter(condition %in% 'lactose'), 
     corPearson(g_first/exp(loglength_start), (g_last-g_first) / (exp(loglength_end)-exp(loglength_start))))^2
```

Also, the initial GFP concentration correlates only weakly with the (fitted) initial cell size:

```{r}
ggplot(mycells %>% filter(condition %in% 'lactose'),
       aes(exp(loglength_start), g_first/exp(loglength_start))) +
  geom_point(size=.5, alpha=.5) +
  expand_limits(x=0, y=0) +
  labs(x='initial length', y='initial GFP concentration')
  
with(mycells %>% filter(condition %in% 'lactose'),
     corPearson(exp(loglength_start), g_first/exp(loglength_start)))^2

```

Noticeably, the added total GFP correlates more with the added volume (as expected assuming that fluctuation in division time are driven by fluctuations in growth rate) than with the division time (as predicted assuming a constant production rate):

```{r}
ggplot(mycells %>% filter(condition %in% 'lactose'),
       aes((time_div-time_birth)/60, g_last-g_first)) +
  geom_point(size=.5, alpha=.5) +
  # geom_density2d(size=.5, alpha=.5) +
  expand_limits(x=0, y=0) +
  labs(x='division time (min)', y='added total GFP')

with(mycells %>% filter(condition %in% 'lactose'),
     corPearson((time_div-time_birth)/60, g_last-g_first))^2

ggplot(mycells %>% filter(condition %in% 'lactose'),
       aes(exp(loglength_end)-exp(loglength_start), g_last-g_first)) +
  geom_point(size=.5, alpha=.5) +
  # geom_density2d(size=.5, alpha=.5) +
  expand_limits(x=0, y=0) +
  labs(x='added volume', y='added total GFP')

with(mycells %>% filter(condition %in% 'lactose'),
     corPearson(exp(loglength_end)-exp(loglength_start), g_last-g_first))^2

```


### GFP during the cell cycle

```{r}
myframes %>% 
  filter(!discard_top, condition=='lactose') %>% 
  group_by(date, pos, gl, id) %>% 
  filter(!any(discard_start), end_type=='div') %>% # full cell cycles only
  filter(n()>4) %>% 
  arrange(time_sec) %>%
  mutate(gfp_aligned=gfp_nb-first(gfp_nb)+lacgfp_birth_avg) %>% 
  (function(.df)
    ggplot(.df, aes((time_sec-start_time)/60, gfp_nb)) +
  geom_path(aes(col=interaction(date, pos), group=cell), size=.5, alpha=.1,
            data=.df %>% group_by(date, pos) %>% slice(1:1e4)) +
  stat_summary(fun.data=mean_sdl, geom="point") +
  xlim(0, 150) + 
  scale_y_continuous(trans='log2') )
# expand_limits(y=0)

```

It's tempting to shift all traces so that they start at the average GFP level at birth. However, it doesn't change the mean. Let's write $g_i(t)$ the total GFP of cell i at time t after division, and $s_i(t)$ its shifted counterpart: $s_i(t) = g_i(t) - g_i(0) + <g(0)>$. Due to the linearity of the mean operator, $<s(t)> = <g(t)> - <g(0)> + <g(0)> = <g(t)>$


Let's shift all traces so that they start at the average GFP level at birth:

```{r}
lacgfp_birth_avg <- myframes %>% 
  filter(!discard_top, condition=='lactose') %>% 
  group_by(date, pos, gl, id) %>% 
  filter(!any(discard_start), end_type=='div') %>% # full cell cycles only
  filter(n()>4) %>% 
  filter(time_sec==start_time) %>% 
  .[['gfp_nb']] %>% mean


myframes %>% 
  filter(!discard_top, condition=='lactose') %>% 
  group_by(date, pos, gl, id) %>% 
  filter(!any(discard_start), end_type=='div') %>% # full cell cycles only
  filter(n()>4) %>% 
  arrange(time_sec) %>%
  mutate(gfp_aligned=gfp_nb-first(gfp_nb)+lacgfp_birth_avg) %>% 
ggplot(aes((time_sec-start_time)/60, gfp_aligned)) +
  # geom_path(aes(col=interaction(date, pos), group=cell), size=.5, alpha=.1) +
  stat_summary(aes(col='aligned'), fun.y=mean, geom="point") +
  stat_summary(aes(y=gfp_nb, col='raw'), fun.y=mean, geom="point") +
  xlim(0, 150) +
  # scale_y_continuous(trans='log2') +
  coord_cartesian(ylim=c(4000, 8500))

```


```{r}
# myframes %>% 
#   filter(!discard_top, !discard_start, condition=='lactose') %>% 
#   group_by(date, pos) %>% slice(1:1e4) %>% 
# ggplot(aes(mycut(length_um, seq(0, 5,.1)), gfp_nb)) +
#   geom_path(aes(col=interaction(date, pos), group=cell), size=.5, alpha=.1) +
#   stat_summary(fun.data=mean_sdl, geom="pointrange") +
#   ylim(0, 2e4)
#   # scale_y_continuous(trans='log2')

myframes %>% 
  filter(!discard_top, !discard_start, condition=='lactose') %>% 
  group_by(date, pos) %>% slice(1:1e4) %>% 
ggplot(aes(y=gfp_nb)) +
  # geom_path(aes(col=interaction(date, pos), group=cell), size=.5, alpha=.1) +
  stat_summary(aes(x=mycut(length_um, seq(0, 5,.1)), col='raw'), alpha=0.5,
               fun.data=mean_sdl, geom="pointrange") +
  stat_summary(aes(x=mycut(length_predict, seq(0, 5,.1)), col='fit'), alpha=0.5,
               fun.data=mean_sdl, geom="pointrange") +
  xlim(0.85, 5) + expand_limits(y=0) + labs(x='length (µm)', col='length')
  # scale_y_continuous(trans='log2')

```

Total GFP relative to the level at birth over the cell cycle:

```{r}
myframes %>% 
  filter(!discard_top, !discard_start, condition=='lactose', gfp_nb<2e4) %>% 
  group_by(date, pos) %>% slice(1:1e4) %>% 
  group_by(date, pos, gl, id) %>% arrange(time_sec) %>% mutate(gfp_rel=gfp_nb/first(gfp_nb)) %>% 
ggplot(aes(cell_cycle, gfp_rel)) +
  geom_path(aes(col=interaction(date, pos), group=cell), size=.5, alpha=.1) + 
  stat_summary(aes(mycut(cell_cycle, seq(0,1,.01))), fun.data=mean_sdl, geom="pointrange") +
  # expand_limits(y=0) +
  scale_y_continuous(trans='log2')


```

for concentration:

```{r}
# ggplot(myframes %>% filter(!discard_top, !discard_start, condition=='lactose', gfp_nb<2e4) %>% 
#          group_by(date, pos) %>% slice(1:1e4),
#        aes((time_sec-start_time)/60, gfp_nb/length_um)) +
#   geom_path(aes(col=interaction(date, pos), group=cell), size=.5, alpha=.1) +
#   stat_summary(fun.data=mean_sdl, geom="pointrange") +
#   xlim(0, 200) + expand_limits(y=0) 

ggplot(myframes %>% filter(!discard_top, !discard_start, condition=='lactose'),
       aes((time_sec-start_time)/60)) +
  stat_summary(aes(y=gfp_nb/length_um, col='raw'), alpha=0.5, fun.data=mean_sdl, geom="pointrange") +
  stat_summary(aes(y=gfp_nb/length_predict, col='fit'), alpha=0.5, fun.data=mean_sdl, geom="pointrange") +
  xlim(0, 200) + expand_limits(y=0) +
  labs(y='GFP concentration (molecules/µm)', col='length')

# myframes %>% 
#   filter(!discard_top, !discard_start, condition=='lactose', gfp_nb<2e4) %>% 
#   group_by(date, pos) %>% slice(1:1e4) %>% 
#   group_by(date, pos, gl, id) %>% arrange(time_sec) %>% 
#   mutate(gfp_conc_rel=gfp_nb/length_um*first(length_um)/first(gfp_nb)) %>% 
# ggplot(aes((time_sec-start_time)/60, gfp_conc_rel)) +
#   geom_path(aes(col=interaction(date, pos), group=cell), size=.5, alpha=.1) +
#   stat_summary(fun.data=mean_sdl, geom="pointrange") +
#   xlim(0, 200) + expand_limits(y=0) 

myframes %>% 
  filter(!discard_top, !discard_start, condition=='lactose', gfp_nb<2e4) %>% 
  group_by(date, pos, gl, id) %>% arrange(time_sec) %>% 
  mutate(gfp_conc_relr1=gfp_nb/length_um*first(length_um)/first(gfp_nb),
         gfp_conc_relrm=gfp_nb/length_um*mean(length_um)/mean(gfp_nb),
         gfp_conc_relp1=gfp_nb/length_predict*first(length_predict)/first(gfp_nb),
         gfp_conc_relpm=gfp_nb/length_predict*mean(length_predict)/mean(gfp_nb)) %>% 
ggplot(aes((time_sec-start_time)/60)) +
  stat_summary(aes(y=gfp_conc_relr1, col='raw_first'), alpha=0.5, fun.data=mean_sdl, geom="pointrange") +
  stat_summary(aes(y=gfp_conc_relrm, col='fit_first'), alpha=0.5, fun.data=mean_sdl, geom="pointrange") +
  stat_summary(aes(y=gfp_conc_relp1, col='raw_mean'), alpha=0.5, fun.data=mean_sdl, geom="pointrange") +
  stat_summary(aes(y=gfp_conc_relpm, col='fit_mean'), alpha=0.5, fun.data=mean_sdl, geom="pointrange") +
  xlim(0, 200) + expand_limits(y=0) +
  labs(y='relative GFP concentration', col='length_norm')

myframes %>% 
  filter(!discard_top, !discard_start, condition=='lactose', gfp_nb<2e4) %>% 
  group_by(date, pos, gl, id) %>% arrange(time_sec) %>% 
  mutate(gfp_conc_relr1=gfp_nb/length_um*first(length_um)/first(gfp_nb),
         gfp_conc_relrm=gfp_nb/length_um*mean(length_um)/mean(gfp_nb),
         gfp_conc_relp1=gfp_nb/length_predict*first(length_predict)/first(gfp_nb),
         gfp_conc_relpm=gfp_nb/length_predict*mean(length_predict)/mean(gfp_nb)) %>% 
ggplot(aes((time_sec-start_time)/60)) +
  stat_summary(aes(y=gfp_conc_relr1, col='raw_first'), alpha=0.5, fun.data=mean_sdl, geom="point") +
  stat_summary(aes(y=gfp_conc_relrm, col='raw_mean'), alpha=0.5, fun.data=mean_sdl, geom="point") +
  stat_summary(aes(y=gfp_conc_relp1, col='fit_first'), alpha=0.5, fun.data=mean_sdl, geom="point") +
  stat_summary(aes(y=gfp_conc_relpm, col='fit_mean'), alpha=0.5, fun.data=mean_sdl, geom="point") +
  xlim(0, 200) + coord_cartesian(ylim=c(0.75, 1.1)) +
  labs(y='relative GFP concentration', col='length_norm')


# myframes %>% 
#   filter(!discard_top, !discard_start, condition=='lactose', gfp_nb<2e4) %>% 
#   group_by(date, pos) %>% slice(1:1e4) %>% 
#   group_by(date, pos, gl, id) %>% arrange(time_sec) %>% mutate(gfp_conc_rel=gfp_nb/length_um*first(length_um)/first(gfp_nb)) %>% 
# ggplot(aes(cell_cycle, gfp_conc_rel)) +
#   geom_path(aes(col=interaction(date, pos), group=cell), size=.5, alpha=.1) +
#   geom_hline(yintercept=1, alpha=.7) +
#   stat_summary(aes(mycut(cell_cycle, seq(0, 1, length.out=41))), fun.data=mean_sdl, geom="pointrange") +
#   expand_limits(y=0) 

myframes %>% 
  filter(!discard_top, !discard_start, condition=='lactose', gfp_nb<2e4) %>% 
  group_by(date, pos, gl, id) %>% arrange(time_sec) %>% 
  mutate(gfp_conc_relr1=gfp_nb/length_um*first(length_um)/first(gfp_nb),
         gfp_conc_relrm=gfp_nb/length_um*mean(length_um)/mean(gfp_nb),
         gfp_conc_relp1=gfp_nb/length_predict*first(length_predict)/first(gfp_nb),
         gfp_conc_relpm=gfp_nb/length_predict*mean(length_predict)/mean(gfp_nb)) %>% 
ggplot(aes(mycut(cell_cycle, seq(0, 1, length.out=41)))) +
  stat_summary(aes(y=gfp_conc_relr1, col='raw_first'), alpha=0.5, fun.data=mean_sdl, geom="point") +
  stat_summary(aes(y=gfp_conc_relrm, col='raw_mean'), alpha=0.5, fun.data=mean_sdl, geom="point") +
  stat_summary(aes(y=gfp_conc_relp1, col='fit_first'), alpha=0.5, fun.data=mean_sdl, geom="point") +
  stat_summary(aes(y=gfp_conc_relpm, col='fit_mean'), alpha=0.5, fun.data=mean_sdl, geom="point") +
  coord_cartesian(ylim=c(0.85, 1.1)) +
  labs(x='cell cycle', y='relative GFP concentration', col='length_norm')

```


```{r, eval=FALSE}
myframes %>% filter(!discard_top, !discard_start, condition=='lactose', gfp_nb<2e4) %>% 
  mutate(time_cell=time_sec-start_time) %>% 
  group_by(date, pos, time_cell) %>% 
  summarise(mean=mean(gfp_nb/length_um), sd=sd(gfp_nb/length_um), cov=sd/mean) %>% 
  gather(variable, value, -date, -pos, -time_cell) %>% 
ggplot(aes(time_cell, value, col=interaction(date, pos))) + 
  facet_grid(variable~., scales='free_y') + 
  geom_path() +
  xlim(0, 5e3)
```


Autocorrelation of concentration for mother cells:

```{r}
myframes %>% filter(!discard_top, !discard_start, condition=='lactose',
                    cell_num_in_lane==total_cell_in_lane) %>% 
  ggplot() +
  geom_line(aes(time_sec, gfp_nb/length_um, col=interaction(date, pos, gl)), alpha=.25) +
  scale_colour_periodic_brewer(guide='none')

myframes %>% filter(!discard_top, !discard_start, condition=='lactose',
                    cell_num_in_lane==total_cell_in_lane) %>% 
  group_by(date, pos, gl) %>% 
  do((function(.df){
    # browser()
    .acf <- acf(.df$gfp_nb/.df$time_sec, lag.max=100, plot=FALSE)
    data.frame(lag=.acf$lag*dt, acf=.acf$acf)
    })(.)) %>% 
  ggplot(aes(lag, acf)) +
  geom_line(aes(col=interaction(date, pos, gl)), alpha=.25) +
  stat_summary(fun.data=mean_sdl, geom="pointrange") +
  scale_colour_periodic_brewer(guide='none')

last_plot() + scale_y_log10()

```


### GFP production rate

Computed per sec and normalized per cell length.

```{r}
ggplot(myframes %>% filter(!discard_top, !discard_start, condition %in% 'lactose'),
       aes(x=gfp_deriv/length_predict, y=..density..)) +
  geom_histogram(binwidth=.1) +
  geom_step_hist(aes(col=factor(date)), binwidth=.1, position='identity') 

last_plot() + scale_y_log10()

```


Plot over the cell cycle in physical time unit:
NB: lacZ position 364kb; oriC position 3924kb
hence distance to origin = 4640 - (3924-364) = 1080kb
i.e. 47% of total replication path: 1080 / (4640/2)
NB: Ter sites at ≈1470, 3924-1470=2454kb vs 2185kb

```{r}
ggplot(myframes %>% filter(!discard_top, !discard_start, condition %in% 'lactose'),
       aes(x=(time_sec-start_time)/60)) +
  # stat_smooth(aes(y=gfp_deriv/length_predict, col='predict')) +
  # stat_smooth(aes(y=gfp_deriv/length_um, col='raw')) +
  stat_summary(aes(y=gfp_deriv/length_predict, col='predict'), fun.y=mean, geom="point") +
  stat_summary(aes(y=gfp_deriv/length_um, col='raw'), fun.y=mean, geom="point") +
  xlim(0, 200) +
  expand_limits(y=0)

ggplot(myframes %>% filter(!discard_top, !discard_start, condition %in% 'lactose'),
       aes(x=(time_sec-start_time)/60)) +
  stat_summary(aes(y=gfp_deriv/length_predict, col='predict'), fun.data=mean_sdl, geom="pointrange") +
  stat_summary(aes(y=gfp_deriv/length_um, col='raw'), fun.data=mean_sdl, geom="pointrange") +
  xlim(0, 200)

```


Plot as a function of the cell cycle progression:

```{r}
ggplot(myframes %>% filter(!discard_top, !discard_start, condition %in% 'lactose'),
       aes(x=mycut(cell_cycle, seq(0, 1, length.out=30)))) +
  # stat_smooth(aes(x=cell_cycle, y=gfp_deriv/length_predict, col='predict')) +
  # stat_smooth(aes(x=cell_cycle, y=gfp_deriv/length_um, col='raw')) +
  stat_summary(aes(y=gfp_deriv/length_predict, col='predict'), fun.y=mean, geom="point") +
  stat_summary(aes(y=gfp_deriv/length_um, col='raw'), fun.y=mean, geom="point") +
  labs(x="cell cycle") +
  expand_limits(y=0)

ggplot(myframes %>% filter(!discard_top, !discard_start, condition %in% 'lactose'),
       aes(x=mycut(cell_cycle, seq(0, 1, length.out=30)))) +
  stat_summary(aes(y=gfp_deriv/length_predict, col='predict'), fun.data=mean_sdl, geom="pointrange") +
  stat_summary(aes(y=gfp_deriv/length_um, col='raw'), fun.data=mean_sdl, geom="pointrange") +
  labs(x="cell cycle") +
  expand_limits(y=0)

```



```{r}
ggplot(myframes %>% filter(!discard_top, !discard_start, condition %in% 'lactose'),
       aes(x=mycut(length_predict, seq(0,10,.1)))) +
  # stat_smooth(aes(x=cell_cycle, y=gfp_deriv/length_predict, col='predict')) +
  # stat_smooth(aes(x=cell_cycle, y=gfp_deriv/length_um, col='raw')) +
  stat_summary(aes(y=gfp_deriv), fun.y=mean, geom="point") +
  labs(x="length (um)") +
  xlim(0, 4) +
  expand_limits(y=0)

ggplot(myframes %>% filter(!discard_top, !discard_start, condition %in% 'lactose'),
       aes(x=mycut(cell_cycle, seq(0, 1, length.out=30)))) +
  # stat_smooth(aes(x=cell_cycle, y=gfp_deriv/length_predict, col='predict')) +
  # stat_smooth(aes(x=cell_cycle, y=gfp_deriv/length_um, col='raw')) +
  stat_summary(aes(y=gfp_deriv), fun.y=mean, geom="point") +
  labs(x="cell cycle") +
  expand_limits(y=0)

```


Autocorrelation of production for mother cells:

```{r}
myframes %>% filter(!discard_top, !discard_start, condition=='lactose',
                    cell_num_in_lane==total_cell_in_lane) %>% 
  ggplot() +
  geom_line(aes(time_sec, gfp_deriv/length_predict, col=interaction(date, pos, gl)), alpha=.05) +
  scale_colour_periodic_brewer(guide='none')

myframes %>% filter(!discard_top, !discard_start, condition=='lactose',
                    cell_num_in_lane==total_cell_in_lane) %>% 
  group_by(date, pos, gl) %>% 
  do((function(.df){
    # browser()
    .acf <- acf(.df$gfp_deriv/.df$length_predict, lag.max=100, na.action=na.pass, plot=FALSE)
    data.frame(lag=.acf$lag*dt, acf=.acf$acf)
    })(.)) %>% 
  # filter(acf<.5) %>% 
  ggplot(aes(lag, acf)) +
  geom_path(aes(col=interaction(date, pos, gl)), alpha=.25) +
  stat_summary(fun.data=mean_sdl, geom="pointrange") +
  scale_colour_periodic_brewer(guide='none') 

last_plot() +
  scale_y_log10()

```





## Instantaneous rates

```{r}
rate_width <- 10 # number of frames used for fitting
rate_hw <- round(rate_width/2) * dt * 60

myrates <- filter(myframes, !discard_top, condition=='lactose') %>% # head(1e4) %>%
  # first loop on all growth lanes
  # group_by(date, pos, gl) %>%
  partition(date, pos, gl,
            cluster=mycluster %>% cluster_assign_obj(dt) %>% cluster_assign_obj(rate_hw) %>%
              cluster_assign_func(get_parent_cid) %>% cluster_assign_func(get_daughters_cid)) %>%
  do( (function(.df){
    .df_full <- .df
    filter(.df, !discard_start) %>%
      # then loop on all cells
      group_by(id, cell) %>%
      do( (function(.dfgl, .df){
        # browser()
        .time_ini <- first(.df$time_sec)
        .time_end <- last(.df$time_sec)
        .cid <- unique(.df$cid)
        # bind data with parent and offspring
        .df2 <- bind_rows(
          filter(.dfgl, between(time_sec, .time_ini-rate_hw, .time_ini-dt*60),
                 cid %in% c(.cid, get_parent_cid(.cid))) %>%
            select(cid, time_sec, length_um, gfp_nb) %>%
            mutate(length_um=ifelse(cid!=.cid, length_um/2, length_um),
                   gfp_nb=ifelse(cid!=.cid, gfp_nb/2, gfp_nb)) %>%
            select(-cid) %>%
            mutate(type='parent'),
          select(.df, time_sec, length_um, gfp_nb) %>%
            mutate(type='cell'),
          filter(.dfgl, between(time_sec, .time_end+dt*60, .time_end+rate_hw),
                 cid %in% c(.cid, get_daughters_cid(.cid))) %>%
            select(time_sec, length_um, gfp_nb) %>%
            group_by(time_sec) %>%
            summarise(length_um=ifelse(n()==2, sum(length_um), 2*length_um),
                      gfp_nb=ifelse(n()==2, sum(gfp_nb), 2*gfp_nb)) %>%
            mutate(type='daughters')
        )
        # if(.cid=='0BBBB') browser()
        # if(dim(.df)[1] > 10) browser()
        ggplot(.df2)+
          geom_path(aes(time_sec, gfp_nb, col=type))

        filter(.df2, type=='cell') %>%
          group_by(time_sec) %>%
          do((function(.p) {
            # browser()
            .df <- filter(.df2, between(time_sec, .p[['time_sec']]-rate_hw, .p[['time_sec']]+rate_hw))
            .mod_ll <- fastLmPure( cbind(1, .df$time_sec), log(.df$length_um) )
            .mod_lg <- fastLmPure( cbind(1, .df$time_sec), log(.df$gfp_nb) )
            .mod_g_l <- fastLmPure( cbind(1, .df$length_um), .df$gfp_nb )
            data.frame(irate_npoints=.mod_ll$df.residual+1,
                       islope_ll_time=.mod_ll$coefficients[2], islopesd_ll_time=.mod_ll$stderr[2],
                       ir2_ll_time=corPearson(.df$time_sec, log(.df$length_um))^2,
                       ir2_l_time=corPearson(.df$time_sec, .df$length_um)^2,
                       islope_lg_time=.mod_lg$coefficients[2], islopesd_lg_time=.mod_lg$stderr[2],
                       ir2_lg_time=corPearson(.df$time_sec, log(.df$gfp_nb))^2,
                       ir2_g_time=corPearson(.df$time_sec, .df$gfp_nb)^2,
                       islope_g_l=.mod_g_l$coefficients[2], islopesd_g_l=.mod_g_l$stderr[2],
                       ir2_g_l=corPearson(.df$length_um, .df$gfp_nb)^2)
          })(.) )
      })(.df_full, .) )
  })(.) ) %>% 
  collect()


myrates <- left_join(myrates, myframes %>% select(cell, start_time) %>% distinct) %>% 
  left_join(myframes %>% select(cell, time_sec, length_um, gfp_nb))


```


```{r eval=FALSE}
i <- 15

myrates %>% ungroup %>%  filter(cell==nth(unique(cell), i)) %>% 
  select(cell, time_sec, gfp_nb, ir2_g_time, ir2_lg_time) %>% 
  gather(var, value, -cell, -time_sec) %>% 
  mutate(type=ifelse(var=='ir2_lg_time', 'exponential', 'linear'),
         var=ifelse(var!='gfp_nb', 'r2', var)) %>% # todo: rather use a regex
ggplot() +
  facet_grid(var~., scales='free_y') +
  geom_path(aes(time_sec, value, col=cell, linetype=type)) +
  geom_rug(aes(time_sec))

```



```{r eval=FALSE}
# to do : clean up / delete
ggplot(myrates, aes(irate_height)) +
  stat_bin()
ggplot(myrates, aes(irate_gfp)) +
  stat_bin()

ggplot(myrates, aes(irate_height, irate_gfp)) +
  geom_abline() +
  # geom_point(size=.1, alpha=.1) +
  geom_density2d()



ggplot(myrates) +
  geom_step_hist(aes(irate_r2_height, col='log(height)=f(time)')) +
  geom_step_hist(aes(irate_r2_gfp, col='log(gfp)=f(time)')) +
  geom_step_hist(aes(islope_r2_gfp_height, col='gfp=f(height)'))


ggplot(myrates, aes((time_sec-start_time)/60, irate_height)) +
  geom_point(size=.1, alpha=.1) +
  geom_smooth() +
  xlim(0, 300) +
  expand_limits(y=0)

ggplot(myrates, aes((time_sec-start_time)/60, irate_gfp)) +
  geom_point(size=.1, alpha=.1) +
  geom_smooth() +
  xlim(0, 300) +
  expand_limits(y=0)

ggplot(myrates, aes((time_sec-start_time)/60, islope_gfp_height)) +
  geom_point(size=.1, alpha=.1) +
  geom_smooth() +
  xlim(0, 300) +
  expand_limits(y=0)


```

