---
title: "Growth control for the constitutive expression of Lac genes"
author: "Thomas Julou"
output: html_document
---

The synthetic promoter p2_B08 from Luise’s experiments has been chosen since it is close (mean(log)≈8) to the expression of the lac promoter of the Alon library in lactose (≈ 2x lower to compensate for the fact that there are several copies of the plasmid).

For weak constitutive expression, we use p2_D07 (mean(log)≈6.1) which is the lowest medium expresser that has been isolated; it is ca. 2x above background (for pUA66, mean(log)≈5.35).


```{r}
read_spec_kinetic <- function(.path) {
#  read_spec_kinetic() is written such as to call read.table only once 
# (much faster than calling it for each timepoint and channel)
  .lines <- readLines(.path)
  .l_idx <- str_detect(.lines, "Kinetic read (\\d+) (.*)") %>% which %>% (function(.x) .x-1)
  
  .data <- lapply(.l_idx, function(.i) {
    # extract the channel name
    .m <- str_match(.lines[.i], "(?:Read \\d+:)*(.+)")
    .ch <- .m[2]
    # extract timelapse step and timestamp
    .m <- str_match(.lines[.i+1], "Kinetic read (\\d+) \\((.*)\\)")
    .time <- .m[3]
    .step <- .m[2] # add time step (because different channels are recorded at different times)
    # prepend to rows and concatenate
    paste(.ch, .time, .step, .lines[(.i+3):(.i+10)], sep='\t') %>% 
      paste(collapse='\n')
  }) %>% 
    paste(collapse='\n') %>% 
    read.table(text=., sep="\t", header=FALSE, stringsAsFactors=FALSE) %>% 
    setNames(c("channel", "time", "step", "row", 1:12, 'last_col')) %>% 
    select(-last_col) %>% 
    # convert time to float
    extract(time, c('hours', 'min', 'sec'), '(\\d+):(\\d+):(\\d+)') %>%
    mutate(time=as.numeric(hours)*3600 + as.numeric(min)*60 + as.numeric(sec)) %>%
    select(-hours, -min, -sec) %>% 
    # reshape wide to long
    gather(col, value, matches("\\d+")) %>% 
    mutate(well=paste0(row, col), col=as.numeric(col), channel=as.character(channel))
  return(.data)
}

logfit_lims <- c(min=3e-3, max=3e-2)

```



## Growth curves


```{r}
myplates <- bind_rows(
  left_join(data.frame(date="20160922", a=1, row=LETTERS[1:8]), data.frame(a=1, col=1:12)) %>% select(-a) %>% 
  mutate(strain='ASC662', 
         strain=ifelse(col %in% c(1, 4, 7) & row %in% LETTERS[1:4], 'MG1655', strain),
         strain=ifelse(col %in% 10:12, NA, strain),
         plasmid=NA,
         # plasmid=ifelse(col %in% c(1, 4, 7), '-', plasmid),
         plasmid=ifelse(col %in% c(2, 5, 8) & row %in% LETTERS[1:4], 'pUA66_p2B8-LacZ', plasmid),
         plasmid=ifelse(col %in% c(2, 5, 8) & row %in% LETTERS[5:8], 'pUA66_p2B8-LacY', plasmid),
         plasmid=ifelse(col %in% c(3, 6, 9) & row %in% LETTERS[1:4], 'pUA66_p2B8-LacZLacY', plasmid),
         plasmid=ifelse(col %in% c(3, 6, 9) & row %in% LETTERS[5:8], 'pUA66_p2B8-LacA', plasmid),
         condition=NA, 
         condition=ifelse(col %in% 1:3, 'M9glc', condition),
         condition=ifelse(col %in% 4:6, 'M9glc+IPTG50µM', condition),
         condition=ifelse(col %in% 7:9, 'M9lac', condition) ),
  
  left_join(data.frame(date="20160929", a=1, row=LETTERS[1:8]), data.frame(a=1, col=1:12)) %>% select(-a) %>% 
    mutate(strain='ASC662', 
           strain=ifelse(col %in% c(1, 5, 9), 'MG1655', strain),
           plasmid=NA,
           # plasmid=ifelse(col %in% c(1, 2, 5, 6, 9, 10), '-', plasmid),
           plasmid=ifelse(col %in% c(3, 7, 11) & row %in% LETTERS[1:4], 'pUA66_p2B8-LacZ', plasmid),
           plasmid=ifelse(col %in% c(3, 7, 11) & row %in% LETTERS[5:8], 'pUA66_p2B8-LacY', plasmid),
           plasmid=ifelse(col %in% c(4, 8, 12) & row %in% LETTERS[1:4], 'pUA66_p2B8-LacZLacY', plasmid),
           plasmid=ifelse(col %in% c(4, 8, 12) & row %in% LETTERS[5:8], 'pUA66_p2B8-LacA', plasmid),
           condition=NA, 
           condition=ifelse(col %in% 1:4, 'M9glc', condition),
           condition=ifelse(col %in% 5:8, 'M9glc+IPTG50µM', condition),
           condition=ifelse(col %in% 9:12, 'M9lac', condition) ),
  
  readxl::read_excel("plasmids_lac_genes/Lacgenes_growth_control_plates_layout.xlsx", sheet="20170110") %>% 
    gather(col, val, -row) %>% 
    separate(val, c("strain", "plasmid"), sep=":")  %>% 
    mutate(date="20170110", col=as.numeric(col), condition=NA, 
           condition=ifelse(row %in% LETTERS[1:2], 'M9glc', condition),
           condition=ifelse(row %in% LETTERS[3:4], 'M9glc+IPTG50µM', condition),
           condition=ifelse(row %in% LETTERS[5:8], 'M9lac', condition) ),

  readxl::read_excel("plasmids_lac_genes/Lacgenes_growth_control_plates_layout.xlsx", sheet="20170110") %>% 
    gather(col, val, -row) %>% 
    separate(val, c("strain", "plasmid"), sep=":")  %>% 
    mutate(date="20170111", col=as.numeric(col), condition=NA, 
           condition=ifelse(row %in% LETTERS[1:2], 'M9glc', condition),
           condition=ifelse(row %in% LETTERS[3:4], 'M9glc+IPTG50µM', condition),
           condition=ifelse(row %in% LETTERS[5:8], 'M9lac', condition) ),
  
  readxl::read_excel("plasmids_lac_genes/Lacgenes_growth_control_plates_layout.xlsx", sheet="20170110") %>% 
    gather(col, val, -row) %>% 
    separate(val, c("strain", "plasmid"), sep=":")  %>% 
    mutate(date="20170117", col=as.numeric(col), condition=NA, 
           condition=ifelse(row %in% LETTERS[1:2], 'M9glc', condition),
           condition=ifelse(row %in% LETTERS[3:4], 'M9glc+IPTG50µM', condition),
           condition=ifelse(row %in% LETTERS[5:8], 'M9lac', condition) ),
  
  left_join(data.frame(date="20170112", a=1, row=LETTERS[1:8]), data.frame(a=1, col=1:12)) %>% select(-a) %>% 
    mutate(strain=NA, 
           strain=ifelse(col %in% c(1:2, 5:6), 'ASC662', strain),
           strain=ifelse(col %in% c(3:4, 7:10), 'F3', strain),
           plasmid=NA,
           plasmid=ifelse(col %in% c(1, 3, 5, 7), 'pZA31_LacY', plasmid),
           plasmid=ifelse(col %in% c(2, 4, 6, 8), 'pZA31_LacZ', plasmid),
           # plasmid=ifelse(col %in% c(9:10), '-', plasmid),
           condition=NA, 
           condition=ifelse(row %in% LETTERS[1:2] & col %in% 1:10, 'M9glc', condition),
           condition=ifelse(row %in% LETTERS[3:4] & col %in% 1:10, 'M9glc+IPTG50µM', condition),
           condition=ifelse(row %in% LETTERS[5:8] & col %in% 1:10, 'M9lac', condition) ),

    
  left_join(data.frame(date="20170119", a=1, row=LETTERS[1:8]), data.frame(a=1, col=1:12)) %>% select(-a) %>% 
    mutate(strain=NA, 
           strain=ifelse(col %in% c(1:2, 5:6), 'ASC662', strain),
           strain=ifelse(col %in% c(3:4, 7:10), 'F3', strain),
           plasmid=NA,
           plasmid=ifelse(col %in% c(1, 3, 5, 7), 'pZA31_LacY', plasmid),
           plasmid=ifelse(col %in% c(2, 4, 6, 8), 'pZA31_LacZ', plasmid),
           # plasmid=ifelse(col %in% c(9:10), '-', plasmid),
           condition=NA, 
           condition=ifelse(row %in% LETTERS[1:2] & col %in% 1:10, 'M9glc', condition),
           condition=ifelse(row %in% LETTERS[3:4] & col %in% 1:10, 'M9glc+IPTG50µM', condition),
           condition=ifelse(row %in% LETTERS[5:8] & col %in% 1:10, 'M9lac', condition) )
  
)

mydata <- bind_rows(read_spec_kinetic("plasmids_lac_genes/20160922_lacgenes_growth_control.txt") %>% mutate(date="20160922"),
                    read_spec_kinetic("plasmids_lac_genes/20160929_lacgenes_growth_control.txt") %>% mutate(date="20160929"),
                    read_spec_kinetic("plasmids_lac_genes/20170110_lacgenes_growth_control.txt") %>% mutate(date="20170110"),
                    read_spec_kinetic("plasmids_lac_genes/20170111_lacgenes_growth_control.txt") %>% mutate(date="20170111"),
                    read_spec_kinetic("plasmids_lac_genes/20170112_lacgenes_growth_control.txt") %>% mutate(date="20170112"),
                    read_spec_kinetic("plasmids_lac_genes/20170112_lacgenes_growth_control.txt") %>% mutate(date="20170117"),
                    read_spec_kinetic("plasmids_lac_genes/20170117_lacgenes_growth_control.txt") %>% mutate(date="20170119")) %>% 
  left_join(myplates) %>% 
  group_by(date, well) %>% 
  mutate(time_h=time/3600,
    value2=value-mean(sort(value)[1:10])) %>% 
  # separate(plasmid, c('vector', 'insert'), sep='_', remove=FALSE) %>% 
  # extract(insert, c('promoter', 'gene'), '(p[0-9][A-Z][0-9])-(.*)', remove=FALSE) %>%
  # separate(insert, c('promoter', 'gene'), sep='-', remove=FALSE) %>% 
  mutate(plasmid=ifelse(!is.na(strain) & is.na(plasmid), '-', plasmid),
         strain=ifelse(date=="20160929" & row=='H' & col==1, NA, strain),
         condition=ifelse(date=="20160929" & row=='H' & col==1, NA, condition) )
         
         # ,
         # # strain=factor(strain, levels=c('MG1655', 'ASC662')),
         # plasmid=factor(plasmid, levels=c('-', 'pUA66_p2B8-LacZ', 'pUA66_p2B8-LacY', 'pUA66_p2B8-LacZLacY', 'pUA66_p2B8-LacA')))

myrates <- mydata %>% 
  filter(!is.na(strain)) %>% 
  filter(between(value2, logfit_lims['min'], logfit_lims['max'])) %>% 
  group_by(date, condition, strain, plasmid, row, col) %>% 
  do(mod=MASS::rlm(log(value2)~time_h, data=.)) %>% 
  mutate(rate=coef(mod)[2], 
         itc=coef(mod)[1],
         n_points=length(residuals)) %>% 
  separate(plasmid, c('vector', 'insert'), sep='_', remove=FALSE) %>% 
  extract(insert, c('promoter', 'gene'), '(p[0-9][A-Z][0-9])-(.*)', remove=FALSE) %>% 
  mutate(gene=ifelse(is.na(gene) & !is.na(insert), insert, gene),
         gene=ifelse(is.na(gene) & !is.na(strain), '-', gene))

```


```{r eval=FALSE}
pdf('plasmids_lac_genes/plasmid_lac_genes_overview.pdf', 12, 8)
for (.date in unique(mydata$date)) {
pl <- mydata %>% filter(!is.na(strain)) %>% 
  filter(date==.date) %>% 
  ggplot(aes(time/3600, log(value2))) + 
  facet_grid(row~col) +
  geom_abline(aes(slope=rate, intercept=itc), data=myrates %>% filter(date==.date)) +
  geom_path(col='red', alpha=.3) +
  geom_path(col='red', alpha=.8, 
            data=mydata %>% filter(date==.date) %>% filter(!is.na(strain)) %>% filter(between(value2, logfit_lims['min'], logfit_lims['max']))) +
  geom_text(aes(Inf, -Inf, label=interaction(condition, strain, plasmid, sep='\n')), hjust=1.1, vjust=-0.1, nudge_y=1, size=2,
            data=mydata %>% filter(date==.date) %>% filter(!is.na(strain)) %>% group_by(date, row, col) %>% slice(1)) +
  # scale_y_log10() + xlim(2, 8) +
  labs(x="time (h)", title=sprintf('date: %s', .date)) 
print(pl)
}
dev.off()

```


```{r eval=FALSE}
mydata %>% 
  filter(is.na(strain), is.na(plasmid), value2>.05) %>% 
  group_by(date, well, condition) %>% 
  slice(1)

```


```{r}
# mydata %>% filter(!is.na(strain)) %>% 
#   ggplot(aes(time/3600, log(value2))) + 
#   facet_grid(date+row~col) +
#   geom_abline(aes(slope=rate, intercept=itc), data=myrates) +
#   geom_path(col='red', alpha=.3) +
#   geom_path(col='red', alpha=.8, data=mydata %>% filter(!is.na(strain)) %>% filter(between(value2, logfit_lims['min'], logfit_lims['max']))) +
#   # scale_y_log10() + xlim(2, 8) +
#   labs(x="time (h)")

ggplot(mydata %>% filter(!is.na(condition))) + 
  facet_grid(strain~plasmid) +
  geom_path(aes(time/3600, value2, col=condition, group=interaction(date, well)), alpha=.3) +
  # geom_path(aes(time/3600, value2, col=condition, group=interaction(date, well), lty=date), alpha=.6, 
  #           data=filter(mydata, !is.na(condition), between(value2, logfit_lims['min'], logfit_lims['max']))) +
  scale_y_log10() + xlim(2, 10) +
  scale_colour_brewer(palette="Set1") +
  labs(x="time (h)")

mydata %>% 
  filter(!is.na(condition), strain %in% c('ASC662', 'F3'), !str_detect(plasmid, 'LacA')) %>% 
ggplot() + 
  facet_grid(strain~plasmid) +
  geom_path(aes(time/3600, value2, col=condition, group=interaction(date, well)), alpha=.3) +
  # geom_path(aes(time/3600, value2, col=condition, group=interaction(date, well), lty=date), alpha=.6, 
  #           data=filter(mydata, !is.na(condition), between(value2, logfit_lims['min'], logfit_lims['max']))) +
  scale_y_log10() + xlim(2, 10) +
  scale_colour_brewer(palette="Set1") +
  labs(x="time (h)", y='OD - OD_bg')


# ggplot(mydata %>% filter(!is.na(condition))) + 
#   facet_wrap(~condition, nrow=2, dir='v') +
#   geom_path(aes(time/3600, value2, col=strain, group=interaction(date, well)), alpha=.3) +
#   geom_path(aes(time/3600, value2, col=strain, group=interaction(date, well)), alpha=.6, data=filter(mydata, !is.na(condition), between(value2, logfit_lims['min'], logfit_lims['max']))) +
#   scale_y_log10() + xlim(2, 10) +
#   scale_colour_brewer(palette="Set1") +
#   labs(x="time (h)")


```

Comparing the growth of the strains without plasmids:

```{r}
# mydata %>% filter(!is.na(strain)) %>% 
#   filter(plasmid=='-') %>% 
#   ggplot(aes(time/3600, log(value2))) + 
#   facet_grid(date+row~col) +
#   geom_abline(aes(slope=rate, intercept=itc), data=myrates %>% filter(!is.na(strain)) %>% 
#   filter(plasmid=='-')) +
#   geom_path(col='red', alpha=.3) +
#   geom_path(col='red', alpha=.8, data=mydata %>% filter(plasmid=='-') %>% filter(!is.na(strain)) %>% filter(between(value2, logfit_lims['min'], logfit_lims['max']))) +
#   # scale_y_log10() + xlim(2, 8) +
#   labs(x="time (h)")


myrates %>% filter(!is.na(strain)) %>% 
  filter(plasmid=='-') %>% 
  ggplot() +
  facet_grid(.~strain) +
  geom_jitter(aes(condition, rate, col=date), size=1, position=position_dodge(width=0.5)) +
  scale_colour_brewer(palette="Set1") +
  expand_limits(y=0) +
  ggplot2::scale_color_discrete() +
  labs(y='growth rate (/h)', title='without plasmid') +
  theme(axis.text.x=element_text(angle=45, hjust=1, vjust=1))

myrates %>% filter(!is.na(strain)) %>% 
  filter(plasmid=='-') %>% 
  ggplot(.) +
  geom_boxplot(aes(strain, rate, col=condition), width=.4, position=position_dodge(width=0.5)) +
  geom_text(aes(strain, 1, label=n, col=condition), position=position_dodge(width=0.5), show.legend=FALSE,
            data=. %>% group_by(condition, strain) %>% summarise(n=n()) ) +
  scale_colour_brewer(palette="Set1") +
  expand_limits(y=0) +
  labs(y='growth rate (/h)', title='without plasmid') +
  theme(axis.text.x=element_text(angle=45, hjust=1, vjust=1),
        legend.position='bottom')
ggsave('plots/Rplot.pdf', width=3.5, height=3)

```

Effect of the plasmids for ASC662:

```{r}
myrates %>% filter(strain=='ASC662', gene!='LacA') %>% # select(gene, plasmid)
ggplot(.) +
  geom_boxplot(aes(plasmid, rate, col=condition), width=.5, position=position_dodge(width=0.5)) +
  geom_text(aes(plasmid, 1, label=n, col=condition), position=position_dodge(width=0.5), 
            angle=90, hjust=1.1, show.legend=FALSE,
            data=. %>% group_by(condition, plasmid) %>% summarise(n=n()) ) +
  scale_colour_brewer(palette="Set1") +
  expand_limits(y=0) +
  labs(y='growth rate (/h)', title='strain: ASC662') +
  theme(axis.text.x=element_text(angle=45, hjust=1, vjust=1),
        legend.position=c(1, 0), legend.justification=c(1, 0))

```

Effect of the plasmids for F3:

```{r}
myrates %>% filter(strain=='F3', gene!='LacA') %>% # select(gene, plasmid)
ggplot() +
  geom_boxplot(aes(plasmid, rate, col=condition), width=.5, position=position_dodge(width=0.5)) +
  geom_text(aes(plasmid, 1, label=n, col=condition), position=position_dodge(width=0.5), 
            angle=90, hjust=1.1, show.legend=FALSE,
            data=. %>% group_by(condition, plasmid) %>% summarise(n=n()) ) +
  scale_colour_brewer(palette="Set1") +
  expand_limits(y=0) +
  labs(y='growth rate (/h)', title='strain: F3') +
  theme(axis.text.x=element_text(angle=45, hjust=1, vjust=1),
        legend.position='none')
ggsave('plots/Rplot.pdf', width=7, height=4)

```




