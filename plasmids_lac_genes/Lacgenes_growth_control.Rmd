---
title: "Growth control for the constitutive expression of Lac genes"
author: "Thomas Julou"
output: html_document
---

The synthetic promoter p2_B08 from Luise’s experiments has been chosen since it is close (mean(log)≈8) to the expression of the lac promoter of the Alon library in lactose (≈ 2x lower to compensate for the fact that there are several copies of the plasmid).

For weak constitutive expression, we use p2_D07 (mean(log)≈6.1) which is the lowest medium expresser that has been isolated; it is ca. 2x above background (for pUA66, mean(log)≈5.35).


```{r}
read_spec_kinetic <- function(.path) {
#  read_spec_kinetic() is written such as to call read.table only once 
# (much faster than calling it for each timepoint and channel)
  .lines <- readLines(.path)
  .l_idx <- str_detect(.lines, "Kinetic read (\\d+) (.*)") %>% which %>% (function(.x) .x-1)
  
  .data <- lapply(.l_idx, function(.i) {
    # extract the channel name
    .m <- str_match(.lines[.i], "(?:Read \\d+:)*(.+)")
    .ch <- .m[2]
    # extract timelapse step and timestamp
    .m <- str_match(.lines[.i+1], "Kinetic read (\\d+) \\((.*)\\)")
    .time <- .m[3]
    .step <- .m[2] # add time step (because different channels are recorded at different times)
    # prepend to rows and concatenate
    paste(.ch, .time, .step, .lines[(.i+3):(.i+10)], sep='\t') %>% 
      paste(collapse='\n')
  }) %>% 
    paste(collapse='\n') %>% 
    read.table(text=., sep="\t", header=FALSE, stringsAsFactors=FALSE) %>% 
    setNames(c("channel", "time", "step", "row", 1:12, 'last_col')) %>% 
    select(-last_col) %>% 
    # convert time to float
    extract(time, c('hours', 'min', 'sec'), '(\\d+):(\\d+):(\\d+)') %>%
    mutate(time=as.numeric(hours)*3600 + as.numeric(min)*60 + as.numeric(sec)) %>%
    select(-hours, -min, -sec) %>% 
    # reshape wide to long
    gather(col, value, matches("\\d+")) %>% 
    mutate(well=paste0(row, col), col=as.numeric(col), channel=as.character(channel))
  return(.data)
}


```



## Growth curves


```{r}
myplates <- bind_rows(
  left_join(data.frame(date="20160922", a=1, row=LETTERS[1:8]), data.frame(a=1, col=1:12)) %>% select(-a) %>% 
  mutate(strain=NA, 
         strain=ifelse(col %in% c(1, 4, 7) & row %in% LETTERS[1:4], 'MG1655', strain),
         strain=ifelse(col %in% c(1, 4, 7) & row %in% LETTERS[5:8], 'ASC662', strain),
         strain=ifelse(col %in% c(2, 5, 8) & row %in% LETTERS[1:4], 'LacZ', strain),
         strain=ifelse(col %in% c(2, 5, 8) & row %in% LETTERS[5:8], 'LacY', strain),
         strain=ifelse(col %in% c(3, 6, 9) & row %in% LETTERS[1:4], 'LacZLacY', strain),
         strain=ifelse(col %in% c(3, 6, 9) & row %in% LETTERS[5:8], 'LacA', strain),
         condition=NA, 
         condition=ifelse(col %in% 1:3, 'M9glc', condition),
         condition=ifelse(col %in% 4:6, 'M9glc+IPTG50µm', condition),
         condition=ifelse(col %in% 7:9, 'M9lac', condition) ),
  left_join(data.frame(date="20160929", a=1, row=LETTERS[1:8]), data.frame(a=1, col=1:12)) %>% select(-a) %>% 
  mutate(strain=NA, 
         strain=ifelse(col %in% c(1, 5, 9), 'MG1655', strain),
         strain=ifelse(col %in% c(2, 6, 10), 'ASC662', strain),
         strain=ifelse(col %in% c(3, 7, 11) & row %in% LETTERS[1:4], 'LacZ', strain),
         strain=ifelse(col %in% c(3, 7, 11) & row %in% LETTERS[5:8], 'LacY', strain),
         strain=ifelse(col %in% c(4, 8, 12) & row %in% LETTERS[1:4], 'LacZLacY', strain),
         strain=ifelse(col %in% c(4, 8, 12) & row %in% LETTERS[5:8], 'LacA', strain),
         condition=NA, 
         condition=ifelse(col %in% 1:4, 'M9glc', condition),
         condition=ifelse(col %in% 5:8, 'M9glc+IPTG50µm', condition),
         condition=ifelse(col %in% 9:12, 'M9lac', condition) )
)

mydata <- bind_rows(read_spec_kinetic("plasmids_lac_genes/20160922_lacgenes_growth_control.txt") %>% mutate(date="20160922"),
                    read_spec_kinetic("plasmids_lac_genes/20160929_lacgenes_growth_control.txt") %>% mutate(date="20160929")) %>% 
  left_join(myplates) %>% 
  group_by(date, well) %>% 
  mutate(time_h=time/3600,
    value2=value-mean(sort(value)[1:10])) %>% 
  mutate(strain=ifelse(date=="20160929" & row=='H' & col==1, NA, strain),
         condition=ifelse(date=="20160929" & row=='H' & col==1, NA, condition),
         strain=factor(strain, levels=c('MG1655', 'ASC662', 'LacZ', 'LacY', 'LacZLacY', 'LacA')))

myrates <- mydata %>% 
  filter(between(value2, 1e-3, 3e-2)) %>% 
  group_by(date, condition, strain, row, col) %>% 
  do(mod=lm(log(value2)~time_h, data=.)) %>% 
  mutate(rate=coef(mod)[2], 
         itc=coef(mod)[1])

ggplot(mydata, aes(time/3600, log(value2))) + 
  facet_grid(date+row~col) +
  geom_abline(aes(slope=rate, intercept=itc), data=myrates) +
  geom_path(col='red', alpha=.3) +
  geom_path(col='red', alpha=.8, data=mydata %>% filter(between(value2, 1e-3, 3e-2))) +
  # scale_y_log10() + xlim(2, 8) +
  labs(x="time (h)")

ggplot(mydata %>% filter(!is.na(condition))) + 
  facet_wrap(~strain, nrow=2, dir='v') +
  geom_path(aes(time/3600, value2, col=condition, group=interaction(date, well)), alpha=.3) +
  geom_path(aes(time/3600, value2, col=condition, group=interaction(date, well), lty=date), alpha=.6, 
            data=filter(mydata, !is.na(condition), between(value2, 1e-3, 3e-2))) +
  scale_y_log10() + xlim(2, 10) +
  scale_colour_brewer(palette="Set1") +
  labs(x="time (h)")

ggplot(mydata %>% filter(!is.na(condition))) + 
  facet_wrap(~condition, nrow=2, dir='v') +
  geom_path(aes(time/3600, value2, col=strain, group=interaction(date, well)), alpha=.3) +
  geom_path(aes(time/3600, value2, col=strain, group=interaction(date, well)), alpha=.6, data=filter(mydata, !is.na(condition), between(value2, 1e-3, 3e-2))) +
  scale_y_log10() + xlim(2, 10) +
  scale_colour_brewer(palette="Set1") +
  labs(x="time (h)")

```

```{r}
ggplot(myrates %>% filter(!is.na(strain))) +
  geom_jitter(aes(strain, rate, col=condition, shape=date), size=1, position=position_dodge(width=0.5)) + 
  scale_colour_brewer(palette="Set1") +
  expand_limits(y=0) +
  labs(y='growth rate (/h)') +
  theme(axis.text.x=element_text(angle=45, hjust=1, vjust=1))
# ggsave('Rplot.pdf', width=4, height=4)

ggplot(myrates %>% filter(!is.na(strain))) +
  geom_boxplot(aes(strain, rate, col=condition), width=.5, position=position_dodge(width=0.5)) +
  scale_colour_brewer(palette="Set1") +
  expand_limits(y=0) +
  labs(y='growth rate (/h)') +
  theme(axis.text.x=element_text(angle=45, hjust=1, vjust=1),
        legend.position=c(1, 0), legend.justification=c(1, 0))

```


