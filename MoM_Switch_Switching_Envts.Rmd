---
title: "Switching environment"
author: Thomas Julou
date: "`r format(Sys.time(), '%d %B, %Y')`"
---

## Growth lag

```{r}
gl_idx <- 11
ggplot(filter(myframes, !discard_start, !discard_top, condition=='switch_4h', end_type=='div') %>% mutate(glid=paste(date, pos, gl, sep='.')) %>% ungroup %>% filter(glid %in% nth(unique(glid), gl_idx)),
       aes(time_sec - 2*3600, length_um, col=cell)) +
  geom_rect(aes(xmin=t_start*60 - 2*3600, xmax=t_end*60 - 2*3600, ymin=0, ymax=Inf, x=NaN, y=NaN, group=1), fill=rgb(1, 0, 0, .1), size=0.2, col='red', data=filter(condition_ts, condition=='switch_4h', medium=='lactose')) +
  geom_path(alpha=0.6) +
  scale_colour_periodic_brewer(guide='none') +
  scale_x_hours(4) +
  scale_y_continuous(trans='log2') +
  labs(y='length (µm)') +
  expand_limits(x=0, y=0)

ggsave('plots/asc_switch_length.pdf', width=8, height=3)

# xxx average before switch
# select cells that exist at switch and divide more than 50' after
# normalize by avg length around the switch


```

## Fluo induction

```{r}

ggplot(filter(myframes, !discard_start, !discard_top, condition=='switch_4h', end_type=='div') %>% mutate(glid=paste(date, pos, gl, sep='.')) %>% filter(glid %in% nth(unique(glid), gl_idx)),
       aes(time_sec - 2*3600, gfp_nb / length_um, col=cell)) +
  geom_rect(aes(xmin=t_start*60 - 2*3600, xmax=t_end*60 - 2*3600, ymin=-Inf, ymax=Inf, x=NaN, y=NaN, group=1), fill=rgb(1, 0, 0, .1), size=0.2, col='red', data=filter(condition_ts, condition=='switch_4h', medium=='lactose')) +
  geom_path(alpha=0.6) +
  scale_colour_periodic_brewer(guide='none') +
  scale_x_hours(4) +
  labs(y='fluorescence concentration (GFP molecules / µm)') +
  expand_limits(x=0, y=0)
ggsave('plots/asc_switch_fluoconc.pdf', width=8, height=3)

ggplot(filter(myframes, !discard_start, !discard_top, condition=='switch_4h', end_type=='div') %>% mutate(glid=paste(date, pos, gl, sep='.')) %>% filter(glid %in% nth(unique(glid), gl_idx)),
       aes(time_sec - 2*3600, gfp_nb , col=cell)) +
  geom_rect(aes(xmin=t_start*60 - 2*3600, xmax=t_end*60 - 2*3600, ymin=-Inf, ymax=Inf, x=NaN, y=NaN, group=1), fill=rgb(1, 0, 0, .1), size=0.2, col='red', data=filter(condition_ts, condition=='switch_4h', medium=='lactose')) +
  geom_path(alpha=0.6) +
  scale_colour_periodic_brewer(guide='none') +
  scale_x_hours(4) +
  labs(y='total fluorescence (GFP molecules)') +
  expand_limits(x=0, y=0)
ggsave('plots/asc_switch_fluotot.pdf', width=8, height=3)


ggplot(filter(myframes, !discard_start, !discard_top, condition=='switch_4h', end_type=='div') %>% head(1e4),
       aes(time_sec - 2*3600, gfp_nb, col=cell)) +
  geom_rect(aes(xmin=t_start*60 - 2*3600, xmax=t_end*60 - 2*3600, ymin=-Inf, ymax=Inf, x=NaN, y=NaN, group=1), fill=rgb(1, 0, 0, .1), col='red', data=filter(condition_ts, condition=='switch_4h', medium=='lactose')) +
  geom_path(alpha=0.5) +
  scale_colour_periodic_brewer(guide='none') +
  scale_x_hours(5) +
  labs(y='total fluorescence (GFP molecules)') +
  expand_limits(x=0, y=0)


```

Distribution of induction times:
- I checked visually that no induction happens in the first 10' after the switch (for all 3 switches)
-


```{r}
ts <- lapply(unique(condition_ts$condition), function(.c) 
  filter(condition_ts, condition==.c, medium!='glucose')$t_start) %>% 
  setNames(unique(condition_ts$condition))
# te <- lapply(unique(condition_ts$condition), function(.c) 
#   filter(condition_ts, condition==.c, medium!='glucose')$t_end) %>% 
#   setNames(unique(condition_ts$condition))

myframes_switching <- filter(myframes, !discard_start, !discard_top, !(condition %in% c('glucose', 'lactose')), time_sec>2*3600) %>%
  mutate(ts1=60*sapply(condition, function(.c) ts[[.c]][1]), 
         ts2=60*sapply(condition, function(.c) ts[[.c]][2]), 
         ts3=60*sapply(condition, function(.c) ts[[.c]][3]) ) %>% 
  group_by(date, pos, gl, id) %>%
  filter( (first(time_sec) < ts1 & last(time_sec) > ts1+30*60) |
            (first(time_sec) < ts2 & last(time_sec) > ts2+30*60) |
            (first(time_sec) < ts3 & last(time_sec) > ts3+30*60) ) %>%
  mutate(nframes=n(), pre_switch = (time_sec>ts1+60 & time_sec<ts1+10*60) |
           (time_sec>ts2+60 & time_sec<ts2+10*60) |
           (time_sec>ts3+60 & time_sec<ts3+10*60) )

ggplot(data=filter(myframes_switching, T), aes(time_sec - 2*3600, gfp_nb, col=cell)) +
  # geom_rect(aes(xmin=t_start*60 - 2*3600, xmax=t_end*60 - 2*3600, ymin=-Inf, ymax=Inf, x=NaN, y=NaN, group=1), fill=rgb(1, 0, 0, .1), col='red', data=filter(condition_ts, condition=='switch', medium=='lactose')) +
  facet_wrap(~condition) +
  geom_path(alpha=0.5) + # geom_point() +
  scale_colour_periodic_brewer(guide='none') +
  scale_x_hours() + #, limits=c(19*3600, 23*3600)) +
  ylim(0, 1e4) +   expand_limits(x=0, y=0) +
  labs(y='total fluorescence (GFP molecules)')
ggsave('plots/asc_gfp_induction_facetcond.pdf', width=7, height=4)

mycells_switching <- myframes_switching %>%
  group_by(condition, cell) %>%
  do((function(.df){
    .preswitch_gfp <- mean(filter(.df, pre_switch)$gfp_nb)
    .preswitch_length <- mean(filter(.df, pre_switch)$length_um)
    .tmin <- filter(.df, pre_switch)$time_sec %>% max
    .ts <- ts[[unique(.df$condition)]]*60
    .switch_idx <- (.tmin - .ts) %>% abs %>% which.min
    .t_200 <- filter(.df, time_sec>.tmin, gfp_nb > .preswitch_gfp+200)$time %>% first
    .t_200_fail <- filter(.df, time_sec>.t_200, gfp_nb < .preswitch_gfp+200)$time %>% first
    # if (.switch_idx==2) browser()
    return(data.frame(genealogy=gsub(":", "", unique(.df$genealogy)), time_switch=.ts[.switch_idx],
                      switch_idx=.switch_idx, time_birth=unique(.df$start_time), time_div=unique(.df$end_time), 
                      gfp_ini=.preswitch_gfp, length_ini=.preswitch_length, cell_num=mean(.df$cell_num_in_lane),
                      lac_200=.t_200, lac_200_fail=.t_200_fail))
    })(.)) %>%
  mutate(gl_id=gsub('\\.[0-9]+$', '', cell),
         lag_200 = ifelse(is.na(lac_200_fail) | lac_200_fail-lac_200 > 20*60,
                          lac_200-time_switch, as.numeric(NA)) )


ggplot(filter(mycells_switching, condition %in% c('switch_4h', 'switch_iptg')), aes(x=lag_200/60, y=..density..)) +
  facet_grid(condition~.) +
  geom_histogram(aes(fill=factor(switch_idx)), binwidth=3, alpha=.2, position='identity', show.legend=FALSE) +
  geom_step_hist(aes(col=factor(switch_idx)), binwidth=3, position='identity') +
  # scale_y_continuous(breaks=seq(0, 1, 0.05)) +
  labs(x='time to induction (+200 GFP molecules; min)', col='switch')
ggsave('plots/asc_gfp_lag200_iptg.pdf', width=7, height=4)

ggplot(filter(mycells_switching, condition %in% c('switch_4h', 'switch_iptg')), aes(x=lag_200/60)) +
  facet_grid(condition~.) +
  stat_ecdf(aes(y=1-..y.., col=factor(switch_idx))) +
  labs(x='time to induction (+200 GFP molecules; min)', y='reverse cumulative probability', col='switch')
ggsave('plots/asc_gfp_lag200_rcdf_iptg.pdf', width=7, height=4)

ggplot(filter(mycells_switching, str_detect(condition, 'switch_[0-9]+h')), aes(x=lag_200/60, y=..density..)) +
  facet_grid(condition~.) +
  geom_histogram(aes(fill=factor(switch_idx)), binwidth=3, alpha=.2, position='identity', show.legend=FALSE) +
  geom_step_hist(aes(col=factor(switch_idx)), binwidth=3, position='identity') +
  scale_y_continuous(breaks=seq(0, 1, 0.05)) +
  labs(x='time to induction (+200 GFP molecules; min)', col='switch')
ggsave('plots/asc_gfp_lag200_facetcond.pdf', width=7, height=4)

ggplot(filter(mycells_switching, str_detect(condition, 'switch_[0-9]+h')), aes(x=lag_200/60)) +
  facet_grid(condition~.) +
  stat_ecdf(aes(y=1-..y.., col=factor(switch_idx))) +
  labs(x='time to induction (+200 GFP molecules; min)', y='reverse cumulative probability', col='switch')
ggsave('plots/asc_gfp_lag200_rcdf_facetcond.pdf', width=7, height=4)

```

Compare variance within growth lane versus global variance:

```{r}
# histogram of number of estimated lags per GL
mycells_switching %>% group_by(switch_idx, gl_id) %>%
  mutate(lag200_mean=mean(lag_200, na.rm=TRUE), lag200_sd=sd(lag_200, na.rm=TRUE),
         lag200_n=sum(!is.na(lag_200))) %>% 
  ( function(.df)
    ggplot(.df, aes(lag200_n) ) +
      facet_grid(.~switch_idx) +
      geom_histogram(binwidth=1) )
    
# correlation lag and avg lag in GL
mycells_switching %>% group_by(switch_idx, gl_id) %>%
  mutate(lag200_mean=mean(lag_200, na.rm=TRUE), lag200_sd=sd(lag_200, na.rm=TRUE),
         lag200_n=sum(!is.na(lac_200)), lag200_se=lag200_sd/sqrt(lag200_n)) %>% 
  filter(lag200_n>2) %>% 
  filter(!(switch_idx==2 & lag200_mean/60>100)) %>% #group_by(switch_idx) %>% 
  # summarise(n=n(), r2=cor(lag200_mean, lag_200, use="complete.obs", method="pearson")^2)
  ( function(.df) { #browser()
    ggplot(.df, aes(lag200_mean/60, lag_200/60, col=factor(switch_idx)) ) +
      facet_wrap(~switch_idx, scales="free") +
      # stat_smooth(method='lm', fullrange=TRUE) +
      geom_abline(lty="dashed") +
      geom_segment(aes(x=(lag200_mean-lag200_se)/60, xend=(lag200_mean+lag200_se)/60, yend=lag_200/60), alpha=0.5, show.legend=FALSE) +
      geom_point(size=0.5, alpha=0.5) +
        scale_colour_brewer(palette='Set1', # breaks=1:3, 
                            labels=.df %>% group_by(switch_idx) %>% summarise(n=n(), r2=cor(lag200_mean, lag_200, use="complete.obs", method="pearson")^2) %>% (function(.df) sprintf('%d (r2=%.2f)', .df$switch_idx, .df$r2)) ) +
      labs(x='induction lag average in GL (min)', y='induction lag (min)', col='switch_4h') +
      expand_limits(x=0, y=0) + 
      theme(legend.position='top') + guides(col=guide_legend(override.aes = list(size=3, alpha=1)))
    })
ggsave('plots/asc_gfp_lag200_gl.pdf', width=6, height=3.5)

# compare variance within GL versus global variance
mycells_switching %>% group_by(switch_idx, gl_id) %>%
  mutate(lag200_mean=mean(lag_200, na.rm=TRUE), lag200_sd=sd(lag_200, na.rm=TRUE),
         lag200_n=sum(!is.na(lag_200))) %>% 
  filter(lag200_n>2) %>% 
  ( function(.df)
    ggplot(.df) +
      geom_histogram(aes(lag200_sd/lag200_mean, ..density.., fill=factor(switch_idx)), 
                     binwidth=.05, position='identity', alpha=.2, col='transparent', show.legend=FALSE) +
      geom_step_hist(aes(lag200_sd/lag200_mean, ..density.., col=factor(switch_idx), lty='GLs'), binwidth=.05, position='identity') +
      geom_vline(aes(xintercept=lag200_sd/lag200_mean, col=factor(switch_idx), lty='all'),  show.legend=FALSE,
                 data=.df %>% group_by(switch_idx) %>%
                   summarise(lag200_mean=mean(lag_200, na.rm=TRUE)/60, lag200_sd=sd(lag_200, na.rm=TRUE)/60)) +
      scale_linetype_manual(name='group', values=2:1) +
      labs(x='induction lag c.o.v.', col='switch_4h')
  )
ggsave('plots/asc_gfp_lag200_cov.pdf', width=6, height=3)

```


### Position effect 

Position effect in the growth lane on induction lag:

```{r}
# within GL correlation makes it irrelevant to look at the position/lag correl:
ggplot(mycells_switching, aes(x=cell_num, y=lag_200/60, col=factor(switch_idx))) +
  geom_point(alpha=.33, size=.5, show.legend=FALSE) +
  stat_smooth(method='lm', se=FALSE) +
  scale_x_reverse() + 
  expand_limits(y=0) +
  labs(x='position (closed end -- exit)', y='time to induction \n(+200 GFP molecules; min)', col='switch_4h') +
  scale_colour_brewer(palette='Set1', # breaks=1:3, 
                      labels=mycells_switching %>% group_by(switch_idx) %>% summarise(n=n(), r2=cor(cell_num, lag_200/60, use="complete.obs", method="pearson")^2) %>% (function(.df) sprintf('%d (r2=%.1e)', .df$switch_idx, .df$r2)) ) +
  theme(legend.justification=c(0, 1), legend.position=c(0, 1))

# relative to exit cell
ggplot(mycells_switching %>% group_by(switch_idx, gl_id) %>%
         mutate(gl_exit_lag=lag_200/lag_200[which.min(cell_num)],
                gl_exit_cdist=cell_num-cell_num[which.min(cell_num)]),
       aes(gl_exit_cdist, gl_exit_lag, col=factor(switch_idx))) +
  geom_point(alpha=0.25, size=.5) +
  stat_smooth(method='lm', se=FALSE, show.legend=FALSE, size=0.5) +
  scale_x_reverse() + scale_y_continuous(trans='log2', breaks=c(0.25, 0.5, 1, 2, 4)) +
  theme(legend.position='top') + guides(col=guide_legend(override.aes=list(size=3, alpha=1))) + 
  labs(x='distance to "exit" cell (cell position)', y='induction lag relative to exit cell', col='switch_4h')
ggsave('plots/asc_gfp_lag200_position_exit.pdf', width=3, height=3.5)


ggplot(mycells_switching %>% group_by(switch_idx, gl_id) %>%
         mutate(gl_rel_lag200=lag_200/mean(lag_200, na.rm=TRUE),
                gl_exit_cdist=cell_num-cell_num[which.min(cell_num)]),
       aes(cell_num, gl_rel_lag200, col=factor(switch_idx))) +
  geom_point(alpha=0.25, size=.5) +
  stat_smooth(method='lm', se=FALSE, show.legend=FALSE, size=0.5) +
  scale_x_reverse() + scale_y_continuous(trans='log2', breaks=c(0.25, 0.5, 1, 2, 4)) +
  expand_limits(y=2) +
  theme(legend.position='top') + guides(col=guide_legend(override.aes=list(size=3, alpha=1))) + 
  labs(x='position (closed end -- exit)', y='induction lag relative to GL average', col='switch_4h')
ggsave('plots/asc_gfp_lag200_position_avg.pdf', width=3, height=3.5)


# plot time btw cell 1 and cell k in each gl
```


### Effect of initial cell state

Does the induction lag depends on the initial amount of GFP?

```{r}
ggplot(filter(mycells_switching, str_detect(condition, 'switch_[0-9]+h')), aes(x=gfp_ini, y=lag_200/60, col=factor(switch_idx))) +
  facet_grid(condition~switch_idx) +
  geom_point(alpha=.5, size=.5) +
  # scale_x_continuous(trans='log2') +
  scale_y_continuous(breaks=seq(0, 500, 100)) +
  expand_limits(y=0) +
  labs(x='initial GFP level (molecules)', y='induction lag (+200 GFP molecules; min)', col='switch') +
  theme(legend.position='top') + guides(col=guide_legend(override.aes=list(size=3, alpha=1)))
ggsave('plots/asc_gfp_lag200_gfpini_facetcond.pdf', width=7, height=4)

mycells_switching %>% mutate(switch_idx2=ifelse(switch_idx==2 & gfp_ini<190, '2_low', as.character(switch_idx))) %>% 
  group_by(switch_idx2) %>% 
  summarise(r2 = cor(gfp_ini, lag_200, use="complete.obs", method="pearson")^2)

# cor_df <- function(.df, .x, .y, ...) {
#   .df <- .df %>%
#     select_(.dots=list(.x, .y)) %>%
#     na.omit
#   cor(.df[[.x]], .df[[.y]], ...)
# }

```


Does the induction lag depends on the cell cycle state at the switch?

```{r}
glc_dt <- filter(mycells, condition=='glucose') %>% 
  mutate(dt=time_div-time_birth) %>% 
  .[['dt']] %>% mean

ggplot(filter(mycells_switching, !is.na(lag_200)), aes(x=(time_switch-time_birth)/glc_dt, y=lag_200/60, col=factor(switch_idx))) +
  facet_grid(switch_idx~.) +
  geom_point(alpha=.5, size=.5) +
  expand_limits(y=0) + scale_y_continuous(breaks=seq(0, 500, 100)) +
  labs(x='cell cycle progression at switch', y='induction lag (+200 GFP molecules; min)', col='switch_4h') +
  theme(legend.position='top') + guides(col=guide_legend(override.aes=list(size=3, alpha=1)))
ggsave('plots/asc_gfp_lag200_cellcycle.pdf', width=6, height=4)

filter(mycells_switching, !is.na(lag_200), (time_switch-time_birth)/glc_dt<= 1) %>% 
  group_by(switch_idx) %>% 
  summarise(r2=cor((time_switch-time_birth)/glc_dt, lag_200, use="complete.obs", method="pearson")^2)

```


### Lag inheritance

```{r}

mypairs_switching <- mycells_switching %>% group_by(gl_id, switch_idx) %>% 
  do((function(.df) {
    # browser()
    if (dim(.df)[1]<2) 
      return(data.frame())
    return( combn(.df$genealogy, 2, simplify=FALSE) %>% 
      lapply(function(.x) as.data.frame(genealogy_relationship(.x), stringsAsFactors=FALSE)) %>% 
      do.call(rbind, .) )
  })(.)) %>% 
  mutate(rel=factor(rel, levels=c("sisters", "cousins1", "cousins2", "niece"))) %>% 
  left_join(mycells_switching %>% ungroup %>% 
              setNames(., paste(names(.), "1", sep="_")) %>% rename(gl_id=gl_id_1, switch_idx=switch_idx_1) ) %>% 
  left_join(mycells_switching %>% ungroup %>% 
              setNames(., paste(names(.), "2", sep="_")) %>% rename(gl_id=gl_id_2, switch_idx=switch_idx_2) ) 

ggplot(filter(mycells_switching, !(switch_idx>1 & gfp_ini<150)), aes(x=gfp_ini, y=lag_200/60, col=factor(switch_idx))) +
  facet_grid(switch_idx~.) +
  geom_point(alpha=.5, size=.5) +
  expand_limits(y=0) +
  scale_y_continuous(breaks=seq(0, 500, 100)) +
  labs(x='initial GFP level (molecules)', y='induction lag (+200 GFP molecules; min)', col='switch_4h') +
  theme(legend.position='top') + guides(col=guide_legend(override.aes=list(size=3, alpha=1)))

ggplot(filter(mypairs_switching, rel!='niece', !( (switch_idx>1 & gfp_ini_1<150) | (switch_idx>1 & gfp_ini_2<150) )), aes(lag_200_1/60, lag_200_2/60, col=rel)) +
# ggplot(filter(mypairs_switching, rel!='niece'), aes(lag_200_1/60, lag_200_2/60, col=rel)) +
  facet_wrap(~switch_idx, scales='free', ncol = 3) +
  geom_abline(col='gray50') +
  geom_point(alpha=.5, size=.5) +
  # geom_smooth() +
  expand_limits(x=0, y=0) +
  # scale_y_continuous(breaks=seq(0, 500, 100)) +
  labs(x='induction lag cell 1 (min)', y='induction lag cell 2 (min)', col='relationship') +
  theme(legend.position='bottom') + guides(col=guide_legend(override.aes=list(size=3, alpha=1)))
ggsave('plots/asc_gfp_lag200_genealogy.pdf', width=5, height=4)

# with(mypairs_switching, table(switch_idx, rel, useNA='ifany'))
filter(mypairs_switching, rel!='niece', !( (switch_idx>1 & gfp_ini_1<150) | (switch_idx>1 & gfp_ini_2<150) )) %>% 
# filter(mypairs_switching, rel!='niece', !(switch_idx==2 & lag_200_1/60>75)) %>% 
  group_by(switch_idx, rel) %>% 
  summarise(r2=cor(lag_200_1, lag_200_2, use="complete.obs", method="pearson")^2, n=n()) %>% 
  (function(.df) ggplot(.df, aes(rel, r2)) +
     facet_grid(.~switch_idx) +
     geom_bar(aes(fill=rel), stat='identity', show.legend=FALSE) +
     geom_text(aes(y=0.99, label=paste0("n = ", n)), angle=90, hjust=1) +
     expand_limits(y=1) + labs(x='relationship', y='squared pearson correlation r2') +
     theme(axis.text.x=element_text(angle=45, hjust=1, vjust=1))
  )
ggsave('plots/asc_gfp_lag200_genealogyr2.pdf', width=2.5, height=4)


```


```{r}

ggplot(filter(myframes_switching, nframes>20, between(time_sec, 360*60, 600*60)) %>% head(5e3),
       aes(gfp_nb, length_um, col=cell)) +
  geom_path() + 
  geom_smooth(method='lm', fullrange=FALSE,
              data=filter(myframes_switching, nframes>20, gfp_nb>100, between(time_sec, 360*60, 600*60)) %>% head(5e3)) +
  scale_colour_periodic_brewer() +
  facet_wrap(~cell)

```

