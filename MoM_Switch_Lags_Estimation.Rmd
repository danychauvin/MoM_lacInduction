---
title: "Measuring the growth and *lac* induction lags in switching environments"
author: Thomas Julou
date: "`r format(Sys.time(), '%d %B, %Y')`"
---

## Estimation

First, let's select the cells that undergo a switch (i.e. the first frame occured before a switch to lactose, and the last frame after (or at) the switch). We "prolonge" each cell by summing the variables (length and total GFP) of its two daughters, and discard cells for which the acquisition stopped less than 30' after the switch (10 points; it is difficult to distinguish growth from lag on shorter traces).

Based on the log of the length traces, the growth lag is computed by fitting a flat lag followed by a linear increase to the subset of each trace where the length is smaller than 3 times the length at the switch (note that the cells do more than doubling because daughters' lengths are summed).

Estimating the induction lag is more cumbersome because GFP traces do not follow a general shape. We compute two lag estimates:

- the GFP lag is computed by fitting a flat lag followed by a linear increase to the subset of each GFP trace where it is lower than the GFP at the switch plus 1000 GFP molecules (NB: the typical value at the switch is 100 molecules while fully induced cells have ca. 4000 moecules in average).
- the lag\_200 is computed by finding the delay until the cell increases its GFP by 200 molecules after the switch. If the GFP becomes lower than this value after this delay, then lag\_200 is undefined.

```{r}
myframes_switching <- myframes %>% 
  filter(!(condition %in% c('glucose', 'lactose', 'mg1655'))) %>% 
  filter(!discard_start, !discard_top) %>%
  group_by(date, pos, gl, id) %>%
  # partition(date, pos, gl, id, cluster=mycluster) %>%
  select(condition, date, pos, gl, id, genealogy, start_time, end_time, end_type, 
         time_sec, medium, m_start, m_end, gfp_nb, length_um, m_cycle, cell_num_in_lane, total_cell_in_lane) %>% 
  mutate(is_lac=str_detect(medium, 'lactose') | str_detect(medium, 'lactose+IPTG'), 
         t_lac_switch=min(m_start[is_lac]), t_lac_end=min(m_end[is_lac])) %>% 
  filter(first(time_sec)<t_lac_switch & last(time_sec)>=unique(t_lac_switch)) %>% 
  # prolonge traces with daughters' data
  (function(.df) bind_rows(
    mutate(.df, type='cell'),
    .df %>% 
      group_by(date, pos, gl, id) %>% slice(1L) %>% 
      (function(.df)
        # find the genealogy of the daughters and extract the corresponding rows from myframes
        bind_rows(mutate(.df, join_gen=paste0(genealogy, 'B')),
                  mutate(.df, join_gen=paste0(genealogy, 'T')) ) %>% 
         semi_join(myframes %>% filter(!discard_top, !discard_start) %>% mutate(join_gen=genealogy),
                   ., by=c('date', 'pos', 'gl', 'join_gen')) ) %>%
      ungroup %>% mutate(genealogy=get_parent_cid(genealogy)) %>% 
      select(condition, date, pos, gl, id, genealogy, 
             time_sec, medium, m_start, m_end, gfp_nb, length_um) %>% 
      # group by time, compute the stat of both daughters' and keep only the first row
      # compared to summarise, this keeps all other variables
      group_by(date, pos, gl, genealogy, time_sec) %>% 
      mutate(gfp_nb=ifelse(n()==2, sum(gfp_nb), 2*gfp_nb), 
             length_um=ifelse(n()==2, sum(length_um), 2*length_um), 
             type=paste0(n(), "dg")) %>%
      slice(1L) 
  ) ) %>% 
  collect() %>% 
  # fill in missing values
  group_by(date, pos, gl, genealogy) %>% 
  fill(start_time, end_time, t_lac_switch, t_lac_end) %>% 
  mutate(ugen=paste(date, pos, gl, genealogy, sep='.'),
         pre_switch=time_sec>t_lac_switch+60 & time_sec<t_lac_switch+10*60) %>% 
  # select data used for lag estimation
  group_by(condition, ugen) %>% 
  mutate(fit_lag=ifelse(
    type!='1dg' & # discard traces after one daughter is lost (because of discontinuity)
      tail(time_sec[type!='1dg']-t_lac_switch[type!='1dg'], 1) > (10 * dt*60) & # require at least 10 frames after the switch
      m_start==t_lac_switch # focus on the medium after the switch
    , TRUE, FALSE) )

```

Let's visualise the data used to estimate the lags:

```{r fig.height=21}
myframes_switching %>% 
  filter(fit_lag) %>% 
  ggplot(aes(time_sec - 2*3600, gfp_nb, col=ugen, alpha=type)) +
  # geom_rect(aes(xmin=t_start - 2*3600, xmax=t_end - 2*3600, ymin=-Inf, ymax=Inf, x=NaN, y=NaN, group=1), fill=rgb(1, 0, 0, .1), col='red', data=filter(condition_ts, condition=='switch', medium=='lactose')) +
  facet_wrap(~condition, ncol=1) +
  geom_path() + # geom_point() +
  scale_colour_periodic_brewer(guide='none') +
  scale_alpha_discrete(range=c(0.1, 0.6)) +
  scale_x_hours() + #, limits=c(19*3600, 23*3600)) +
  ylim(-100, 1e4) +   expand_limits(x=0, y=0) +
  labs(y='total fluorescence (GFP molecules)')

```


```{r}
mycells_switching <- myframes_switching %>%
  filter(fit_lag) %>% 
  # group_by(condition, ugen) %>%
  partition(condition, date, pos, gl, ugen, cluster=mycluster %>% cluster_assign_func(compute_lag) %>% cluster_assign_obj(dt)) %>%
  do((function(.df){
    # print(unique(.df$ugen))
    # if (unique(.df$ugen)=="20150703.0.11.0:BBBBTBB") browser()
    # if (unique(.df$ugen)=="20150703.3.11.0:BBTBBB") browser()
    
    .cond <- head(.df$condition)
    .preswitch_gfp <- mean(filter(.df, pre_switch)$gfp_nb)
    .preswitch_length <- mean(filter(.df, pre_switch)$length_um)
    # compute growth lag
    .growth_lag <- .df %>% filter(time_sec>=t_lac_switch, length_um<3*.preswitch_length) %>%
      .[['length_um']] %>% log %>% compute_lag(.scaling_factor=1) #,.plot=TRUE)
    if (length(.growth_lag) == 0) { warning('growth lag estimation failed')
      .growth_lag <- list(tau_idx=NaN, x_lag=NaN, slope_after=NaN)
    }

    .gfp_lag <- .df %>% filter(time_sec>=t_lac_switch, gfp_nb<.preswitch_gfp+ifelse(.cond!='switch_iptg', 1000, 2000)) %>%
      .[['gfp_nb']] %>% compute_lag #(.plot=TRUE)
    if (length(.gfp_lag) == 0)
      .gfp_lag <- list(tau_idx=NaN, x_lag=NaN, slope_after=NaN)

    # compute induction lag
    .tmin <- filter(.df, pre_switch)$time_sec %>% max
    .t_200 <- filter(.df, time_sec>.tmin, gfp_nb > .preswitch_gfp+200)$time_sec %>% first
    .t_200_fail <- filter(.df, time_sec>.t_200, gfp_nb < .preswitch_gfp+200)$time_sec %>% first
    return(data.frame(genealogy=gsub(":", "", unique(.df$genealogy)), 
                      t_lac_switch=first(.df$t_lac_switch), t_lac_end=first(.df$t_lac_end),
                      tmax_lag_fit=max(.df$time_sec),
                      cell_num_from_top=mean(.df$cell_num_in_lane, na.rm=T), cell_num_from_bottom=mean(.df$total_cell_in_lane-.df$cell_num_in_lane, na.rm=T),
                      switch_idx=filter(.df, is_lac)$m_cycle %>% first, 
                      time_birth=unique(.df$start_time), time_div=unique(.df$end_time),
                      growth_lag=(.growth_lag$tau_idx-1)*dt*60, growth_lag_length=exp(.growth_lag$x_lag), growth_lag_rate_after=.growth_lag$slope_after / (dt*60),
                      gfp_lag=(.gfp_lag$tau_idx-1)*dt*60, gfp_lag_length=.gfp_lag$x_lag, gfp_lag_slope_after=.gfp_lag$slope_after / (dt*60),
                      gfp_ini=.preswitch_gfp, length_ini=.preswitch_length, cell_num=mean(.df$cell_num_in_lane, na.rm=TRUE),
                      lac_200=.t_200, lac_200_fail=.t_200_fail))
    })(.)) %>%
  collect() %>% 
  arrange(condition, ugen) %>%  # sort data after `partition()`
# mycells_switching <- mycells_switching %>% 
  mutate(lac_200=ifelse(is.na(lac_200), Inf, lac_200), # set lag_200 to Inf if no restart
         lag_200 = ifelse(is.na(lac_200_fail) | lac_200_fail-lac_200 > 20*60,
                          lac_200-t_lac_switch, NaN) )

# ggplot(mycells_switching) +
#   facet_grid(condition~., margins=TRUE, scales='free') +
#   geom_vline(xintercept=0.12, col='red') +
#   geom_histogram(aes(gfp_lag_slope_after), binwidth=0.025)
# 
# ggplot(mycells_switching) +
#   facet_grid(condition~., margins=TRUE, scales='free') +
#   geom_vline(xintercept=4e-5, col='red') +
#   geom_histogram(aes(growth_lag_rate_after), binwidth=2e-6)

# discard lag fit with slope too close to 0
mycells_switching <- mycells_switching %>% 
  mutate(gfp_lag=ifelse(!is.na(gfp_lag_slope_after) & between(gfp_lag_slope_after, 0.12, Inf), gfp_lag, Inf),
         gfp_lag_slope_after=ifelse(!is.na(gfp_lag_slope_after) & between(gfp_lag_slope_after, 0.12, Inf), gfp_lag_slope_after, NaN),
         growth_lag=ifelse(!is.na(growth_lag_rate_after) & between(growth_lag_rate_after, 4e-5, 2.5e-4), growth_lag, Inf),
         growth_lag_rate_after=ifelse(!is.na(growth_lag_rate_after) & between(growth_lag_rate_after, 4e-5, 2.5e-4), growth_lag_rate_after, NaN))
  
# set to NA lags of uninduced cells with traces shorter than the lactose episode
mycells_switching <- mycells_switching %>%
  mutate(reach_lac_end = abs(tmax_lag_fit-(t_lac_end-180))<1e-3) %>% 
  mutate(gfp_lag=ifelse(is.infinite(gfp_lag) & !reach_lac_end, NA, gfp_lag),
         growth_lag=ifelse(is.infinite(growth_lag) & !reach_lac_end, NA, growth_lag),
         lag_200=ifelse(is.infinite(lag_200) & !reach_lac_end, NA, lag_200) )

# add fit prediction and residual to myframes_switching
myframes_switching <- myframes_switching %>% 
  group_by(ugen) %>% 
  mutate(switch_idx=m_cycle[is_lac] %>% first) %>% 
  ungroup %>% 
  left_join(mycells_switching %>% ungroup %>% 
              select(ugen, growth_lag, growth_lag_length, growth_lag_rate_after, 
                     gfp_lag, gfp_lag_length, gfp_lag_slope_after,
                     gfp_ini, lag_200, lac_200)) %>%
  mutate(length_predict=ifelse(time_sec<t_lac_switch+growth_lag, growth_lag_length,
    growth_lag_length * exp(growth_lag_rate_after*(time_sec-t_lac_switch-growth_lag) )),
         length_predict=ifelse(time_sec>=t_lac_switch, length_predict, NA),
         llength_residual=log(length_um)-log(length_predict))

# # visual control
# for(i in 1:1000) {
# filter(myframes_switching, cell==nth(unique(ugen), i)) %>%
# filter(myframes_switching, ugen==unique(ugen)[i]) %>%
#   (function(.x) ggplot(.x)+
#   geom_vline(aes(xintercept = unique(t_lac_switch-start_time+growth_lag)), lty='dashed') +
#   geom_point(aes(time_sec-start_time, log(length_um), col=medium)) +
#   geom_line(aes(time_sec-start_time, log(length_predict))) ) %>%
#     print
# scan("")
# }

```

We use the following convention:
- NaN: lag estimation failed
- NA: lag longer than the gfp (resp. length) time series, time series shorter than the lactose episode
- Inf: lag longer than the lactose episode


## Validation of the lag estimation

Let's look at the proportion of cells for which a lag can be estimated and identify the different types of indetermination (based on the interaction between the different estimates):

```{r eval=FALSE}
mycells_switching %>% 
  mutate(growth_lag=as.character(growth_lag), growth_lag=ifelse(is.na(growth_lag), 'NA', growth_lag),
         growth_lag=ifelse(growth_lag %in% c('NaN', 'NA', 'Inf'), growth_lag, 'numeric'),
         gfp_lag=as.character(gfp_lag), gfp_lag=ifelse(is.na(gfp_lag), 'NA', gfp_lag),
         gfp_lag=ifelse(gfp_lag %in% c('NaN', 'NA', 'Inf'), gfp_lag, 'numeric'),
         lag_200=as.character(lag_200), lag_200=ifelse(is.na(lag_200), 'NA', lag_200),
         lag_200=ifelse(lag_200 %in% c('NaN', 'NA', 'Inf'), lag_200, 'numeric')) %>% 
  group_by(growth_lag, gfp_lag, lag_200) %>% 
  summarise(n=n()) %>% 
  ungroup %>% mutate(p=n/sum(n)) %>% 
  knitr::kable(digits=2)

mycells_switching %>% 
  mutate(growth_lag=ifelse(is.na(growth_lag), 'NA', as.character(growth_lag)),
         growth_lag=ifelse(growth_lag %in% c('NA', 'Inf'), growth_lag, 'numeric'),
         gfp_lag=ifelse(is.na(gfp_lag), 'NA', as.character(gfp_lag)),
         gfp_lag=ifelse(gfp_lag %in% c('NA', 'Inf'), gfp_lag, 'numeric'),
         lag_200=ifelse(is.na(lag_200), 'NA', as.character(lag_200)),
         lag_200=ifelse(lag_200 %in% c('NA', 'Inf'), lag_200, 'numeric')) %>% 
  filter(growth_lag=='numeric', gfp_lag=='Inf', lag_200=='numeric') %>% 
  select(ugen) %>% 
  semi_join(myframes_switching, ., by='ugen') %>% 
  group_by(ugen) %>% slice(1L) %>%
  select(condition, date, pos, gl, id, ugen) %>%  print(n=200)

```

|growth_lag |gfp_lag |lag_200 |    n|    p|
|:----------|:-------|:-------|----:|----:|
|Inf        |Inf     |Inf     |  121| 0.04| no restart  |
|Inf        |Inf     |NA      |   21| 0.01| no restart but wiggly fluo |
|Inf        |Inf     |numeric |   39| 0.01| no restart (with minor fluo increase) |
|Inf        |numeric |Inf     |    9| 0.00| fluo only restart but lower than 200 |
|Inf        |numeric |NA      |    1| 0.00| fluo only restart but wiggly |
|Inf        |numeric |numeric |  162| 0.05| fluo restart but no growth |
|numeric    |Inf     |Inf     |    8| 0.00| growth restart but not fluo |
|numeric    |Inf     |numeric |    5| 0.00| (missed gfp_lag?) |
|numeric    |numeric |NA      |    3| 0.00| (fluo either lower than 200 or wiggly) |
|numeric    |numeric |numeric | 2722| 0.88| |

- length pb before division (cf perl)
- for Inf lags, check if true arrest by fitting the slope before and after the switch (to identify cells with slow growth that don't arrest)
- for Inf lag, account for the trace length
- remove filaments and "really" arrested cells

iptg:
20151207 pos0 GL17 0:BBBBBTBT
20151207 pos0 GL17  0:BBBBBBBT

For the growth lag, the residuals around the switch show less than 2% deviation from our model in average. In order to understand the distribution of residuals, it must be stratified by time: the residuals are the largest at the switch and decrease monotonically until the end of the lag exponential fit. During the post-lag exponential growth, the residuals continue to decrease.

XXX TO BE REVIEWED

```{r}
myframes_switching %>% 
  filter(is.finite(growth_lag)) %>% 
  mutate(t_switch=time_sec-t_lac_switch-growth_lag, rel_resid=llength_residual/log(length_predict)) %>% 
  group_by(t_switch) %>% 
  summarise(mean=mean(rel_resid, na.rm=TRUE), n=n(), sem=sd(rel_resid, na.rm=TRUE)/sqrt(n)) %>%
  ungroup() %>% filter(n>max(n)/20) %>% 
ggplot(aes(t_switch/60, mean, alpha=n)) +
  geom_errorbar(aes(ymin=mean-sem, ymax=mean+sem)) +
  geom_line() +
  labs(x='time after switch (min)', y='scaled residuals average')

myframes_switching %>% 
  filter(is.finite(growth_lag)) %>% 
  mutate(t_switch=time_sec-t_lac_switch-growth_lag, rel_resid=llength_residual/log(length_predict)) %>% 
  filter(between(t_switch, -200*60, 200*60)) %>% 
  ggplot() +
  geom_histogram(aes(rel_resid)) +
  scale_y_log10()

myframes_switching %>% 
  filter(is.finite(growth_lag), time_sec>=t_lac_switch, time_sec<=t_lac_switch+growth_lag) %>% 
  mutate(time=time_sec-t_lac_switch, rel_resid=llength_residual/log(length_predict)) %>% 
  filter(time<300*60) %>% 
  mutate(time=mycut(time, seq(0, 300*60, length.out=6))) %>% 
  ggplot() +
  # facet_grid(.~t_switch)
  geom_step_hist(aes(rel_resid, ..density.., col=time/60, group=time), alpha=.6, position='identity') +
  # geom_density(aes(rel_resid, col=t_switch/60, group=t_switch), alpha=.2) +
  scale_y_log10() +
  # coord_cartesian(xlim=c(-.3, .3)) +
  labs(x='scaled residuals', col='time after \nswitch (min)') +
  scale_colour_distiller(palette="Spectral")

myframes_switching %>% 
  filter(is.finite(growth_lag)) %>% 
  mutate(t_switch=time_sec-t_lac_switch-growth_lag, rel_resid=llength_residual/log(length_predict)) %>% 
  filter(between(t_switch, -200*60, 200*60)) %>% 
  mutate(t_switch=mycut(t_switch, seq(-200*60, 200*60, length.out=6))) %>% 
  ggplot() +
  # facet_grid(.~t_switch)
  geom_step_hist(aes(rel_resid, ..density.., col=t_switch/60, group=t_switch, position='identity'), alpha=.6) +
  # geom_density(aes(rel_resid, col=t_switch/60, group=t_switch), alpha=.2) +
  scale_y_log10() +
  labs(x='scaled residuals', col='time after \nrestart (min)') +
  scale_colour_distiller(palette="Spectral")

```


```{r eval=FALSE}
# print control plots to pdf
pdf('plots/MoM_Switch_lag_verif.pdf', width=12, height=9)
myframes_switching %>%
  semi_join(mycells_switching, by='ugen') %>% 
  ungroup %>% 
  filter(type!='1dg') %>% 
  # head(1e3) %>%
  gather(var, value, gfp_nb, length_um) %>% 
  mutate(value=ifelse(var=='length_um', log(value), value),
         var=ifelse(var=='length_um', 'llength_um', var)) %>% 
  group_by(ugen) %>% 
  mutate(b_rank_avg=round(mean(total_cell_in_lane-cell_num_in_lane, na.rm=TRUE)),
         fct=paste(b_rank_avg, var, sep=":")) %>% 
  group_by(condition, date, pos, gl) %>% 
  do((function(.df){
    print(.df$ugen[1])
    .pl <- ggplot(.df, aes((time_sec-t_lac_switch)/60, value, col=ugen)) +
      facet_grid(fct~switch_idx, scales='free', as.table=FALSE) +
      # add annotations
      geom_vline(xintercept=0, col='grey60') +
      geom_text(aes(x=-Inf, y=Inf, label=sprintf("%d (%s)", id, genealogy)),
                hjust=-0.05, vjust=1.2, size=3, alpha=0.9, 
                data=.df %>% group_by(fct, ugen) %>% slice(1)) +
      # plot traces
      geom_line(aes(alpha=type, lty=fit_lag, group=interaction(ugen, type, fit_lag, time_sec<t_lac_switch))) +
      scale_colour_periodic_brewer(guide='none') +
      # add lag estimations
      geom_vline(aes(xintercept=(lvalue)/60, col=ugen, lty=lvar),
                 data=.df%>% group_by(fct, ugen) %>% slice(1) %>% 
                   gather(lvar, lvalue, lag_200, gfp_lag, growth_lag) %>% 
                   mutate(lvalue=ifelse(var!='llength_um' & lvar=='growth_lag', NA, lvalue),
                          lvalue=ifelse(var!='gfp_nb' & lvar%in%c('gfp_lag', 'lag_200'), NA, lvalue))) +
      scale_linetype_manual(values=c('TRUE'=1, 'FALSE'=4
                                     , 'growth_lag'=3, 'gfp_lag'=3, 'lag_200'=2), guide='none') +
      # add bg every other rank
      geom_rect(aes(xmin=-Inf, ymin=-Inf, xmax=Inf, ymax=Inf, x=NULL, y=NULL,
                alpha=b_rank_avg%%2==0), color='grey80',
                data=.df %>% group_by(fct, switch_idx, ugen) %>%
                  summarise(b_rank_avg=first(b_rank_avg))) +
      scale_alpha_manual(values=c("cell"=1, "2dg"=.5, "FALSE"=0.1, "TRUE"=0), guide='none') +
      labs(title=slice(.df, 1) %>% with(sprintf("%s pos%s GL%s (%s)", date, pos, gl, condition)))
    
    print(.pl)
  })(.))
dev.off()

```

```{r BZSposter, eval=FALSE}
myframes_switching %>% 
  filter(date==20150703, pos==0, gl==27, genealogy=='0:BBBBB') %>% 
  semi_join(mycells_switching, by='ugen') %>% 
  ungroup %>% 
  filter(type!='1dg') %>%
  gather(var, value, gfp_nb, length_um) %>% 
  mutate(value=ifelse(var=='length_um', log(value), value),
         # var=ifelse(var=='length_um', 'log(length)', var)
         var=forcats::fct_recode(var, 'log(length)'='length_um', '# GFP molecules'='gfp_nb')) %>% 
  group_by(ugen) %>% 
  (function(.df){
    ggplot(.df, aes((time_sec-t_lac_switch)/60, value, col=ugen)) +
      facet_grid(var~., scales='free', as.table=FALSE) +
      # add annotations
      geom_vline(xintercept=0, col='grey70') +
      # plot traces
      geom_line(aes(alpha=type, lty=fit_lag, group=interaction(ugen, type, fit_lag, time_sec<t_lac_switch))) +
      scale_colour_periodic_brewer(guide='none') +
      # add lag estimations
      geom_vline(aes(xintercept=(lvalue)/60, col=ugen, lty=lvar),
                 data=.df%>% group_by(var, ugen) %>% slice(1) %>% ungroup %>% 
                   gather(lvar, lvalue, gfp_lag, growth_lag) %>% 
                   mutate(lvalue=ifelse(var!='log(length)' & lvar=='growth_lag', NA, lvalue),
                          lvalue=ifelse(var!='# GFP molecules' & lvar%in%c('gfp_lag', 'lag_200'), NA, lvalue)) ) +
      scale_linetype_manual(values=c('TRUE'=1, 'FALSE'=4, 
                                     'growth_lag'=3, 'gfp_lag'=3, 'lag_200'=2), guide='none') +
      # xlim(-30, 80) +
      scale_alpha_manual(values=c("cell"=1, "2dg"=.5, "FALSE"=0.1, "TRUE"=0), guide='none') +
      labs(x='time after the switch (min)') +
      theme_classic(base_size=8) + 
      theme(axis.line.x=element_line(), axis.line.y=element_line()) +
      theme(strip.background=element_rect(fill='gray95', colour='transparent'))
  })
ggsave('plots/BZSposter2017/lags_inference.pdf', width=180/25.4/2, height=140/25.4/2)

```


## Comparison of lag types

```{r}
ggplot(data=mycells_switching, aes(lag_200/60, gfp_lag/60)) +
  # facet_grid(switch_idx~condition, scales='free', margins=TRUE) +
  facet_wrap(~condition+switch_idx, scales='free') +
  geom_abline(col='red', alpha=0.5) +
  geom_point(alpha=.2, size=.2) +
  labs(x='induction lag (+200 GFP molecules; min)', y='GFP lag (min)') +
  expand_limits(x=0, y=0)

ggplot(data=mycells_switching, aes(growth_lag/60, gfp_lag/60)) +
  # facet_grid(switch_idx~condition, scales='free') + #, margins=TRUE) +
  facet_wrap(~condition+switch_idx, scales='free') +
  geom_abline(col='red', alpha=0.5) +
  geom_point(alpha=.2, size=.2) +
  labs(x='growth lag (min)', y='GFP lag (min)') +
  expand_limits(x=0, y=0) 

ggplot(data=mycells_switching, aes(growth_lag/60, lag_200/60)) +
  # facet_grid(switch_idx~condition, scales='free', margins=TRUE) +
  facet_wrap(~condition+switch_idx, scales='free') +
  geom_abline(col='red', alpha=0.5) +
  geom_point(alpha=.2, size=.2) +
  expand_limits(x=0, y=0) 

```

NB: the lower bound of the GFP lags probably comes from GFP maturation time.

```{r BZSposter, eval=FALSE}
mycells_switching %>% 
  filter(!date %in% discarded_date) %>%
  filter(str_detect(condition, '^switch_[0-9]+h$') | condition=='switch_long_lac') %>%
  filter(switch_idx==1) %>%
  mutate(growth_lag=ifelse(growth_lag>240*60, Inf, growth_lag),
         gfp_lag=ifelse(gfp_lag>240*60, Inf, gfp_lag) ) %>% 
  group_by(growth_lag, gfp_lag) %>% 
  summarise(n=n()) %>% ungroup %>% 
  mutate(infinite=ifelse(is.infinite(growth_lag) | is.infinite(gfp_lag), TRUE, FALSE),
         growth_lag=ifelse(is.infinite(growth_lag), 240*60, growth_lag),
         gfp_lag=ifelse(is.infinite(gfp_lag), 240*60, gfp_lag) ) %>% 
  ( function(.df)
    ggplot(.df, aes(gfp_lag/60, growth_lag/60, size=n, shape=infinite)) +
      geom_abline(col='red', alpha=0.9, size=.25) +
      geom_point(stroke=.1) +
      labs(x=expression(paste(italic('lac'), ' induction lag (min)')), y='growth lag (min)') +
      scale_size_continuous(range=c(1.8/max(.df$n), 1.8), breaks=c(5, 20, 100)) +
      scale_shape_manual(breaks=c(TRUE, FALSE), values=c(19, 1), guide='none') +
      expand_limits(x=0, y=0) +
      scale_x_continuous(breaks=seq(0, 200, 50)) + scale_y_continuous(breaks=seq(0, 200, 50)) +
      theme_classic(base_size=8) + theme(axis.line.x=element_line(), axis.line.y=element_line()) +
      theme(legend.position=c(0.01, 1), legend.justification=c(0, 1), legend.direction='horizontal')
  )
ggsave('plots/BZSposter2017/gfp_growth_lags.pdf', width=180/25.4/2, height=100/25.4/2)
  
```


## Overview of lag distributions

```{r fig.height=12}
mycells_switching %>% ungroup %>% 
  gather(variable, lag, growth_lag, gfp_lag, lag_200, factor_key=TRUE) %>% 
  mutate(lag=ifelse(!is.infinite(lag), lag, max(lag[is.finite(lag)])+60),
         lag=ifelse(is.na(lag), -1, lag)) %>% 
  ggplot(aes(lag/60)) +
  facet_grid(condition~switch_idx, labeller=as_labeller(switch_facets_labels)) +
  stat_ecdf(aes(y=1-..y.., col=variable)) +
  coord_cartesian(xlim=c(0, 240)) +
  labs(x='lag after the switch (min)', y='rev. cumulative proba.')
  
mycells_switching %>% ungroup %>% 
  gather(variable, lag, growth_lag, gfp_lag, lag_200, factor_key=TRUE) %>% 
  mutate(lag=ifelse(!is.infinite(lag), lag, max(lag[is.finite(lag)])+60),
         lag=ifelse(is.na(lag), -1, lag)) %>% 
  ggplot(aes(lag/60)) +
  facet_grid(condition~variable, labeller=as_labeller(switch_facets_labels)) +
  stat_ecdf(aes(y=1-..y.., col=factor(switch_idx))) +
  coord_cartesian(xlim=c(0, 240)) +
  scale_y_continuous(breaks=seq(0, 1, by=0.5)) +
  labs(x='lag after the switch (min)', y='rev. cumulative proba.', col='switch')
# ggsave('Rplot.pdf', width=7.5, height=4.5)


mycells_switching %>% ungroup %>% 
  # filter(!condition %in% c('switch_08h')) %>% 
  gather(variable, lag, growth_lag, gfp_lag, lag_200, factor_key=TRUE) %>% 
  mutate(lag=ifelse(!is.infinite(lag), lag, max(lag[is.finite(lag)])+60),
         lag=ifelse(is.na(lag), -1, lag)) %>% 
  ggplot(aes(lag/60)) +
  facet_grid(variable~switch_idx, labeller=as_labeller(switch_facets_labels)) +
  stat_ecdf(aes(y=1-..y.., col=condition, group=date)) +
  coord_cartesian(xlim=c(0, 240)) +
  scale_y_continuous(breaks=seq(0, 1, by=0.5)) +
  ggplot2::scale_color_discrete() +
  labs(x='lag after the switch (min)', y='rev. cumulative proba.')

```

Focus on the first switch:

```{r}
mycells_switching %>% ungroup %>% 
  # filter(!condition %in% c('switch_08h')) %>% 
  filter(switch_idx==1) %>% 
  gather(variable, lag, growth_lag, gfp_lag, lag_200, factor_key=TRUE) %>% 
  mutate(lag=ifelse(!is.infinite(lag), lag, max(lag[is.finite(lag)])+60),
         lag=ifelse(is.na(lag), -1, lag)) %>% 
  ggplot(aes(lag/60)) +
  facet_grid(condition+date~variable, scales='free_y', labeller=as_labeller(switch_facets_labels)) +
  geom_histogram(aes(fill=condition, group=date), alpha=.2, position='identity', binwidth=6) +
  geom_step_hist(aes(col=condition, group=date), position='identity', binwidth=6) +
  xlim(0, 240) +
  ggplot2::scale_color_discrete() + ggplot2::scale_fill_discrete() +
  labs(x='lag after the switch (min)')

```

